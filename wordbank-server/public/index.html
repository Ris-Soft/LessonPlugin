<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>外部词库服务器</title>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"> -->
     <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <style>
      :root { color-scheme: dark; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background:#121212; color:#e6e6e6; }
      header { padding: 18px 22px; border-bottom:1px solid #2c2c2c; display:flex; align-items:center; gap:10px; }
      header h1 { font-size: 18px; margin:0; color:#fafafa; }
      main { padding: 16px; max-width: 980px; margin: 0 auto; }
      .card { background:#1f1f1f; border:1px solid #2c2c2c; border-radius:10px; padding:12px; }
      input, button { background:#1b1b1b; color:#e6e6e6; border:1px solid #2c2c2c; border-radius:8px; padding:8px 10px; }
      button { cursor:pointer; }
      table { width:100%; border-collapse: collapse; margin-top:8px; }
      th, td { border:1px solid #2c2c2c; padding:8px; }
      th { background:#1b1b1b; }
      .row { display:flex; gap:10px; align-items:center; }
      .muted { opacity:.8; }
      .sugg-box { position: relative; }
      .upper-module { margin-bottom:8px; }
      .upper-module.float { position: fixed; left: 0; right: 0; bottom: var(--kb-offset, 0px); z-index: 50; padding: 6px 10px; }
      .sugg-list { position:absolute; bottom:100%; left:0; margin-bottom:4px; background:#1b1b1b; border:1px solid #2c2c2c; border-radius:8px; width:100%; box-shadow:0 4px 12px rgba(0,0,0,0.35); z-index:6; }
      .sugg-head { display:flex; justify-content:flex-end; gap:8px; padding:6px 8px; border-bottom:1px solid #2c2c2c; }
      .sugg-body { max-height:120px; overflow:auto; }
      .sugg-item { display:block; width:100%; text-align:left; padding:6px 10px; border:none; background:transparent; color:#e6e6e6; }
      .sugg-item:hover, .sugg-item.active { background:#262626; }
      @media (min-width: 641px) { .sugg-box { max-width: 360px; } }
      @media (max-width: 640px) { .sugg-box { max-width: 100%; } }
      .sugg-item { display:block; width:100%; text-align:left; padding:6px 10px; border:none; background:transparent; color:#e6e6e6; }
      .sugg-item:hover { background:#262626; }
      .pos-list { display:flex; flex-wrap: wrap; gap:8px; margin-top:8px; }
      .pos-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#1b1b1b; border:1px solid #2c2c2c; border-radius:999px; }
      /* 进入页面时的密钥输入弹层 */
      .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; place-items:center; z-index:100; }
      .modal { width: 360px; max-width: 90vw; background:#1f1f1f; border:1px solid #2c2c2c; border-radius:10px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,0.45); }
      .modal h3 { margin:0 0 8px 0; font-size:16px; }
      .modal .row { margin-top:8px; }
      .link { background:transparent; border:none; color:#9bd; cursor:pointer; }
  </style>
  </head>
  <body>
    <header>
      <i class="ri-database-2-line"></i>
      <h1>外部词库服务器</h1>
      <span class="muted">用于与“多维单词”插件连接</span>
    </header>
    <!-- 密钥输入弹层：进入页面时提示，仅编辑需要密钥 -->
    <div id="keyOverlay" class="overlay">
      <div class="modal">
        <h3><i class="ri-key-2-line"></i> 请输入编辑密钥</h3>
        <div class="muted">仅添加 / 删除需要密钥，查看列表不需要</div>
        <div class="row">
          <input id="overlayKey" placeholder="编辑密钥" style="flex:1;" />
          <button id="overlayConfirm"><i class="ri-check-line"></i> 确定</button>
          <button id="overlaySkip" class="link">稍后再说</button>
        </div>
      </div>
    </div>
    <main>
      <section class="card">
        <b><i class="ri-health-book-line"></i> 健康状态</b>
        <div id="health" class="muted" style="margin-top:6px;">检测中…</div>
      </section>

      <section class="card" style="margin-top:14px;">
        <b><i class="ri-add-line"></i> 添加词汇</b>
        <div id="upperModule" class="upper-module">
          <div id="dictBox" class="pos-list" style="display:none;"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="sugg-box" style="flex:1; min-width:240px;">
            <input id="word" placeholder="英文单词" style="width:235px;" />
            <div id="suggestions" class="sugg-list" style="display:none;">
              <div class="sugg-head"><button id="suggCollapse" class="link">收起候选</button></div>
              <div id="suggBody" class="sugg-body"></div>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="cn" placeholder="汉语解释（可留空）" style="flex:1;" />
          <button id="addBtn"><i class="ri-save-2-line"></i> 添加</button>
        </div>
        <div id="addRes" class="muted" style="margin-top:8px;"></div>
      </section>

      <section class="card" style="margin-top:14px;">
        <b><i class="ri-article-line"></i> 词库列表</b>
        <div style="margin-top:8px;">
          <table>
            <thead><tr><th>单词</th><th>汉语</th><th>时间</th><th>操作</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      async function refreshHealth() {
        try { const r = await fetch('/health'); const j = await r.json(); document.getElementById('health').textContent = j.ok ? '服务器正常运行' : '异常'; } catch { document.getElementById('health').textContent = '无法连接'; }
      }
      async function loadWords() {
        try {
          const r = await fetch('/words'); const j = await r.json();
          const list = Array.isArray(j.words) ? j.words : [];
          document.getElementById('tbody').innerHTML = list.map(w => {
            const pairs = Array.isArray(w.translations) ? w.translations.map(it => (it.pos ? (it.pos + '. ' + (it.cn||'')) : (it.cn||''))).filter(Boolean) : [];
            const cnText = pairs.length ? pairs.join('；') : (w.cn || '');
            return `<tr>
              <td>${w.word}</td>
              <td>${cnText}</td>
              <td>${new Date(w.createdAt||Date.now()).toLocaleString()}</td>
              <td><button data-id="${w.id||''}" data-word="${w.word}"><i class='ri-delete-bin-line'></i> 删除</button></td>
            </tr>`;
          }).join('');
        } catch { document.getElementById('tbody').innerHTML = '<tr><td colspan="4">加载失败</td></tr>'; }
      }
      function debounce(fn, wait) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; }
      let suggItems = [];
      let suggActive = -1;
      function renderSuggest(items) {
        const body = document.getElementById('suggBody');
        body.innerHTML = items.map(x => `<button class="sugg-item" data-w="${x.word}">${x.word}</button>`).join('');
        document.getElementById('suggestions').style.display = '';
        document.getElementById('dictBox').style.display = 'none';
      }
      function setSuggActive(idx) {
        const els = Array.from(document.querySelectorAll('#suggBody .sugg-item'));
        els.forEach((el, i) => { if (i === idx) el.classList.add('active'); else el.classList.remove('active'); });
        suggActive = idx;
        const sel = suggItems[idx];
        if (sel && sel.word) document.getElementById('word').value = sel.word;
      }
      async function fetchSuggest(prefix) {
        const dict = document.getElementById('dictBox');
        if (!prefix || /\s/.test(prefix)) { document.getElementById('suggestions').style.display = 'none'; dict.style.display = 'none'; suggItems = []; suggActive = -1; return; }
        try {
          const r = await fetch('https://api.datamuse.com/words?sp=' + encodeURIComponent(prefix) + '*');
          const list = await r.json();
          const top = (Array.isArray(list) ? list : []).slice(0, 8);
          if (!top.length) { document.getElementById('suggestions').style.display = 'none'; document.getElementById('suggBody').innerHTML = ''; dict.style.display = 'none'; suggItems = []; suggActive = -1; return; }
          suggItems = top;
          suggActive = -1;
          renderSuggest(suggItems);
        } catch { document.getElementById('suggestions').style.display = 'none'; }
      }
      function parseDict(remote) {
        const out = [];
        const push = (pos, text) => { const t = String(text||'').trim(); if (!t) return; out.push({ pos: String(pos||'').trim() || '释义', text: t }); };
        try {
          // 兼容常见结构：symbols.parts[].means[]
          if (remote && remote.symbols && Array.isArray(remote.symbols)) {
            for (const s of remote.symbols) {
              const parts = Array.isArray(s.parts) ? s.parts : [];
              for (const p of parts) { const means = Array.isArray(p.means) ? p.means.join('；') : (p.means || ''); push(p.part || '释义', means); }
            }
          }
          // 兼容 explains / definitions
          else if (Array.isArray(remote?.explains)) { for (const e of remote.explains) push('释义', e); }
          else if (Array.isArray(remote?.definitions)) { for (const d of remote.definitions) push(d.pos || '释义', d.cn || d.text || d.definition || ''); }
          // 兼容 result / data 列表
          else if (Array.isArray(remote?.result)) { for (const it of remote.result) push(it.pos || '释义', it.cn || it.translation || it.text || ''); }
          else if (Array.isArray(remote?.data)) { for (const it of remote.data) push(it.pos || '释义', it.cn || it.translation || it.text || ''); }
          // 新增：兼容 data.translations 数组结构（pos + tran_cn）
          else if (Array.isArray(remote?.data?.translations)) { for (const it of remote.data.translations) push(it.pos || '释义', it.tran_cn || it.translation || it.text || ''); }
          // 兼容顶层 translations 数组
          else if (Array.isArray(remote?.translations)) { for (const it of remote.translations) push(it.pos || '释义', it.tran_cn || it.translation || it.text || ''); }
          // 单字段兼容
          else if (typeof remote?.translation === 'string') push('释义', remote.translation);
          else if (Array.isArray(remote?.translation)) push('释义', remote.translation.join('；'));
        } catch {}
        // 不再强制加入“未解析到词典数据”，由 UI 层展示提示
        return out;
      }
      async function fetchDict(word) {
        const box = document.getElementById('dictBox'); box.innerHTML = '';
        if (!word || /\s/.test(word)) return;
        try {
          const api = new URL('https://v2.xxapi.cn/api/englishwords'); api.searchParams.set('word', word);
          const r = await fetch(api); let remote = null;
          try { remote = await r.json(); } catch { remote = { raw: await r.text() }; }
          const items = parseDict(remote);
          if (!items.length) { box.innerHTML = '<div class="muted">未找到词典释义</div>'; }
          else {
            box.innerHTML = items.map((it, idx) => {
              const id = `pos_${idx}`; const label = `${it.pos}: ${it.text}`;
              return `<label class="pos-chip"><input type="checkbox" id="${id}" data-pos="${it.pos}" data-cn="${it.text}" checked /> ${label}</label>`;
            }).join('');
          }
          document.getElementById('dictBox').style.display = '';
          document.getElementById('suggestions').style.display = 'none';
        } catch { /* ignore */ }
      }
      function getEditKey() { return localStorage.getItem('wordbank.editKey') || ''; }
      function showKeyOverlayIfNeeded() {
        const has = !!localStorage.getItem('wordbank.editKey');
        if (!has) document.getElementById('keyOverlay').style.display = 'grid';
      }
      document.getElementById('overlayConfirm').addEventListener('click', () => {
        const v = document.getElementById('overlayKey').value.trim();
        if (v) localStorage.setItem('wordbank.editKey', v);
        document.getElementById('keyOverlay').style.display = 'none';
      });
      document.getElementById('overlaySkip').addEventListener('click', () => {
        document.getElementById('keyOverlay').style.display = 'none';
      });
      async function addWord() {
        const word = document.getElementById('word').value.trim();
        const cn = document.getElementById('cn').value.trim();
        const resEl = document.getElementById('addRes');
        if (!word) { resEl.textContent = '请输入英文单词'; return; }
        try {
          // 如未点击建议且中文为空，则尝试自动获取词典
          const hasDictChoices = document.querySelector('#dictBox input[type="checkbox"]');
          if (!cn && !hasDictChoices) { await fetchDict(word.toLowerCase()); }
          // 提取勾选的词典翻译
          const chips = Array.from(document.querySelectorAll('#dictBox input[type="checkbox"]'));
          const pickedPairs = cn ? [] : chips.filter(x => x.checked).map(x => ({ pos: x.getAttribute('data-pos') || '', cn: x.getAttribute('data-cn') || '' })).filter(it => it.cn);
          const picked = pickedPairs.map(it => (it.pos ? (it.pos + '. ' + it.cn) : it.cn));
          const cnAll = cn ? cn : picked.join('；');
          const r = await fetch('/words', { method:'POST', headers:{'Content-Type':'application/json', 'x-edit-key': getEditKey()}, body: JSON.stringify({ word, cn: cnAll, translations: pickedPairs }) });
          const j = await r.json();
          if (j.ok) {
            resEl.textContent = '已添加：' + j.item.word;
            document.getElementById('word').value = '';
            document.getElementById('cn').value = '';
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('dictBox').innerHTML = '';
            await loadWords();
          } else { resEl.textContent = '添加失败：' + (j.error||''); }
        } catch (e) { resEl.textContent = '添加失败：' + (e.message||e); }
      }
      document.getElementById('addBtn').addEventListener('click', addWord);
      const onInputSuggest = debounce((v) => fetchSuggest(v.toLowerCase()), 200);
      document.getElementById('word').addEventListener('input', (ev) => { const v = ev.target.value; onInputSuggest(v); });
      // 输入框失焦时关闭自动补全建议框；若未从建议列表点击，则触发词典获取
      let suggClicking = false;
      document.getElementById('suggestions').addEventListener('mousedown', () => { suggClicking = true; });
      document.getElementById('word').addEventListener('blur', (ev) => {
        const v = ev.target.value.trim();
        setTimeout(() => {
          document.getElementById('suggestions').style.display = 'none';
          const body = document.getElementById('suggBody'); if (body) body.innerHTML = '';
          const cnCurrent = document.getElementById('cn').value.trim();
          if (v && !suggClicking && !cnCurrent) fetchDict(v.toLowerCase());
          suggClicking = false;
        }, 120);
      });
      document.getElementById('suggestions').addEventListener('click', (ev) => {
        if (ev.target.closest('#suggCollapse')) {
          document.getElementById('suggestions').style.display = 'none';
          const w = document.getElementById('word').value.trim();
          const cnCurrent = document.getElementById('cn').value.trim();
          if (w && !cnCurrent) fetchDict(w.toLowerCase());
          return;
        }
        const btn = ev.target.closest('.sugg-item'); if (!btn) return;
        const w = btn.getAttribute('data-w');
        document.getElementById('word').value = w; document.getElementById('suggestions').style.display = 'none';
        const cnCurrent = document.getElementById('cn').value.trim();
        if (!cnCurrent) fetchDict(w.toLowerCase());
      });
      // 在英文输入框按下回车视为"提交"并收起建议框
      document.getElementById('word').addEventListener('keydown', (ev) => {
        const isEnter = ev.key === 'Enter' || ev.code === 'Enter' || ev.keyCode === 13;
        const isDown = ev.key === 'ArrowDown' || ev.code === 'ArrowDown' || ev.keyCode === 40;
        const isUp = ev.key === 'ArrowUp' || ev.code === 'ArrowUp' || ev.keyCode === 38;
        if (isDown || isUp) {
          if (document.getElementById('suggestions').style.display !== 'none' && suggItems.length) {
            ev.preventDefault();
            const len = suggItems.length;
            let next = suggActive;
            if (isDown) next = (next + 1 + len) % len; else next = (next - 1 + len) % len;
            setSuggActive(next);
          }
          return;
        }
        if (isEnter) {
          ev.preventDefault();
          document.getElementById('suggestions').style.display = 'none';
          const body = document.getElementById('suggBody'); if (body) body.innerHTML = '';
          addWord();
        }
      });
      // 在汉语解释输入框按下回车也视为"提交"并立即清空表单
      document.getElementById('cn').addEventListener('keydown', async (ev) => {
        const isEnter = ev.key === 'Enter' || ev.code === 'Enter' || ev.keyCode === 13;
        if (!isEnter) return;
        ev.preventDefault();
        document.getElementById('suggestions').style.display = 'none';
        const body = document.getElementById('suggBody'); if (body) body.innerHTML = '';
        
        const word = document.getElementById('word').value.trim();
        const cn = document.getElementById('cn').value.trim();
        const resEl = document.getElementById('addRes');
        
        if (!word) { 
          resEl.textContent = '请输入英文单词'; 
          return; 
        }
        
        try {
          // 立即清空表单并显示提交状态
          document.getElementById('word').value = '';
          document.getElementById('cn').value = '';
          document.getElementById('dictBox').innerHTML = '';
          resEl.textContent = '正在提交...';
          
          // 提交数据（使用手动输入的中文解释，不使用词典翻译）
          const r = await fetch('/words', { 
            method:'POST', 
            headers:{'Content-Type':'application/json', 'x-edit-key': getEditKey()}, 
            body: JSON.stringify({ word, cn: cn, translations: [] }) 
          });
          const j = await r.json();
          
          if (j.ok) {
            resEl.textContent = '已提交：' + j.item.word;
            await loadWords();
          } else { 
            resEl.textContent = '提交失败：' + (j.error||''); 
          }
        } catch (e) { 
          resEl.textContent = '提交失败：' + (e.message||e); 
        }
      });
      document.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-id],button[data-word]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const word = btn.getAttribute('data-word');
        const payload = id ? { id } : { word };
        try {
          await fetch('/words', { method:'DELETE', headers:{'Content-Type':'application/json', 'x-edit-key': getEditKey()}, body: JSON.stringify(payload) });
          await loadWords();
        } catch {}
      });
      refreshHealth();
      loadWords();
      showKeyOverlayIfNeeded();

      const upperModule = document.getElementById('upperModule');
      function updateKbOffset() {
        const vv = window.visualViewport;
        const gap = vv ? (window.innerHeight - vv.height) : 0;
        upperModule.style.setProperty('--kb-offset', Math.max(gap, 0) + 'px');
      }
      function enableUpperFloat() { updateKbOffset(); upperModule.classList.add('float'); }
      function disableUpperFloat() { upperModule.classList.remove('float'); }
      document.getElementById('word').addEventListener('focus', enableUpperFloat);
      document.getElementById('cn').addEventListener('focus', enableUpperFloat);
      document.getElementById('word').addEventListener('blur', () => { setTimeout(disableUpperFloat, 150); });
      document.getElementById('cn').addEventListener('blur', () => { setTimeout(disableUpperFloat, 150); });
      if (window.visualViewport) { window.visualViewport.addEventListener('resize', updateKbOffset); }
    </script>
  </body>
</html>