<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>随机点名</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <style>
      :root { --fg: #e6f0ff; --muted: #88a; }
      html, body { height: 100%; }
      body { margin: 0; display: flex; align-items: center; justify-content: center; background: transparent; color: var(--fg); }
      .name { font-size: 96px; font-weight: 800; letter-spacing: 6px; text-shadow: 0 8px 24px rgba(0,0,0,0.35); }
      .placeholder { font-size: 24px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
      .placeholder i { font-size: 24px; }
      .overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; }
      .overlay .center { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
      .overlay .pos { font-size: 20px; color: rgba(230,240,255,0.85); text-shadow: 0 4px 12px rgba(0,0,0,0.35); }
      .neighbor { position: absolute; z-index: 1; min-width: 180px; max-width: 280px; padding: 10px 14px; border-radius: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; gap: 8px; color: #e6f0ff; font-weight: 600; }
      .neighbor .label { color: var(--muted); font-weight: 700; }
      .neighbor.top { top: 12%; left: 50%; transform: translateX(-50%); }
      .neighbor.bottom { bottom: 12%; left: 50%; transform: translateX(-50%); }
      .neighbor.left { left: 8%; top: 50%; transform: translateY(-50%); }
      .neighbor.right { right: 8%; top: 50%; transform: translateY(-50%); }
    </style>
  </head>
  <body>
    <div id="content"></div>
    <script>
      let running = false;
      function getParam(k) { try { const u = new URL(window.location.href); return String(u.searchParams.get(k) || '').trim(); } catch { return ''; } }
      function showName(n, seat) {
        const el = document.getElementById('content');
        if (!n) { el.innerHTML = '<div class="placeholder"><i class="ri-shuffle-line"></i><span>未开始抽选</span></div>'; return; }
        const found = seat && seat.found;
        if (!found) { el.innerHTML = '<div class="name">'+n+'</div>'; return; }
        const pos = seat.pos || { row: '', col: '' };
        const nb = seat.neighbors || {};
        const seg = [];
        seg.push('<div class="overlay">');
        
        const join = (arr) => { try { const a = Array.isArray(arr) ? arr.filter(Boolean) : []; return a.slice(0,2).join('、'); } catch { return ''; } };
        const f = join(nb.front);
        const l = join(nb.left);
        const r = join(nb.right);
        const b = join(nb.back);
        if (f) seg.push('<div class="neighbor top"><span class="label">前</span><span>'+f+'</span></div>');
        if (l) seg.push('<div class="neighbor left"><span class="label">左</span><span>'+l+'</span></div>');
        seg.push('<div class="center"><div class="name">'+n+'</div><div class="pos">第'+String(pos.row||'')+'排 第'+String(pos.col||'')+'列</div></div>');
        if (r) seg.push('<div class="neighbor right"><span class="label">右</span><span>'+r+'</span></div>');
        if (b) seg.push('<div class="neighbor bottom"><span class="label">后</span><span>'+b+'</span></div>');
        seg.push('</div>');
        const tpl = seg.join('');
        el.innerHTML = tpl;
      }
      function renderInit() { const n = getParam('name'); showName(n); }
      function runAnimate(seq, finalName, stepMs, seat) {
        if (!Array.isArray(seq) || !seq.length) { showName(finalName); return; }
        if (running) return; running = true; let i = 0; const step = Number(stepMs || 40);
        const tick = () => { if (i < seq.length) { showName(String(seq[i]||'')); i++; setTimeout(tick, step); } else { showName(String(finalName||''), seat); running = false; } };
        tick();
      }
      renderInit();
      try {
        const ch = getParam('channel');
        if (window.lowbarAPI && ch) {
          window.lowbarAPI.subscribe?.(ch);
          window.lowbarAPI.onEvent?.((name, payload) => {
            if (name !== ch) return;
            if (payload && payload.type === 'animate.pick') {
              const seq = Array.isArray(payload.names) ? payload.names : [];
              const finalName = String(payload.final || '');
              const stepMs = Number(payload.stepMs || 80);
              const seat = payload.seat || null;
              runAnimate(seq, finalName, stepMs, seat);
            }
          });
        }
      } catch {}
    </script>
  </body>
  </html>
