<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>值日预览</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../../renderer/settings.css" />
    <style>
      :root { --panel: rgba(255,255,255,0.06); }
      body { margin: 0; }
      .section { padding: 16px; background: transparent !important; border: none !important; }
      .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
      @media (max-width: 1400px) { .grid { grid-template-columns: repeat(3, 1fr); } }
      @media (max-width: 1100px) { .grid { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
      .card { border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 14px; background: linear-gradient(180deg, rgba(40,80,120,0.25), rgba(20,30,50,0.25)); box-shadow: 0 6px 18px rgba(0,0,0,0.25); transform: translateY(0); transition: transform .2s ease, box-shadow .2s ease; }
      .card:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
      .card h4 { margin: 0 0 8px 0; font-size: 18px; display: flex; align-items: center; gap: 8px; }
      .badge { display: inline-flex; align-items: center; gap: 6px; padding: 2px 10px; border-radius: 999px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); font-size: 12px; }
      .subhead { display:flex; align-items:center; gap:8px; margin:8px 0 4px 0; color: var(--muted); font-size: 13px; }
      .table { margin-top: 8px; overflow-x: auto; }
      .table table { width: 100%; border-collapse: separate; border-spacing: 0; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; overflow: hidden; }
      .table thead th { font-weight: 700; color: var(--muted); text-align: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.12); font-size: 14px; }
      .table tbody td { color: var(--fg); padding: 10px 8px; text-align: center; border-top: 1px solid rgba(255,255,255,0.12); font-size: 16px; }
      .table tbody tr:first-child td { border-top: none; }
      .label-lg { font-weight: 800; white-space: nowrap; }
      .rot { margin-top: 6px; }
      .rot table { width:100%; border-collapse: separate; border-spacing:0; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.12); border-radius: 12px; overflow:hidden }
      .rot-name { width: 120px; text-align: left; font-weight: 700; color: var(--fg); padding-left: 8px; }
      .rot-names { text-align: left; }
      .rot-names.hot { border-radius:10px; background: rgba(138,180,248,0.12); outline: 2px solid rgba(138,180,248,0.35); }
      .muted { color: var(--muted); }
      .today { outline: 2px solid rgba(72,207,173,0.5); }
      .header { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    </style>
  </head>
  <body>
    <div class="section">
      <div class="section-title"><i class="ri-calendar-check-line"></i> 值日信息</div>
      <div class="muted">展示今天和后三天的值日安排。</div>
      <div id="preview" class="grid"></div>
    </div>
    <script>
      let channel = '';
      let caller = '';
      function el(t,c){const e=document.createElement(t);if(c)e.className=c;return e}
      function dowStr(s){ try{ const d=new Date(s); const n=d.getDay(); return ['周日','周一','周二','周三','周四','周五','周六'][n] }catch{ return '' } }
      function todayISO(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}` }
      async function load(){
        let r=null; if(window.lowbarAPI?.pluginCall){ r=await window.lowbarAPI.pluginCall(caller,'getPreview'); r=r?.result||r; }
        const list=Array.isArray(r?.list)?r.list:[]; const wrap=document.getElementById('preview'); wrap.innerHTML='';
        const today=todayISO();
        list.forEach(item=>{ const card=el('div','card'); if(item.dateISO===today) card.classList.add('today'); const h=el('h4'); const head=el('div','header'); const b=el('span','badge'); b.innerHTML=`<i class=\"ri-calendar-line\"></i> ${dowStr(item.dateISO)}`; const t=document.createTextNode(item.dateISO);
          const gBadge=el('span','badge'); gBadge.innerHTML=`<i class=\"ri-group-line\"></i> ${item.groupName||'未设置组'}`;
          head.appendChild(t); head.appendChild(b); head.appendChild(gBadge);
          h.appendChild(head); card.appendChild(h);
          const tableWrap=el('div','table'); const table=document.createElement('table'); const thead=document.createElement('thead'); const trh=document.createElement('tr'); const th0=document.createElement('th'); th0.textContent=''; trh.appendChild(th0);
          (item.rolesGroup||[]).forEach(r=>{ const th=document.createElement('th'); th.textContent=r; trh.appendChild(th) }); thead.appendChild(trh); table.appendChild(thead);
          const tbody=document.createElement('tbody'); const r1=document.createElement('tr'); const tdLabel=document.createElement('td'); tdLabel.className='label-lg'; tdLabel.textContent=item.groupName||''; r1.appendChild(tdLabel);
          (item.rolesGroup||[]).forEach(r=>{ const td=document.createElement('td'); const arr=Array.isArray(item.groupMembers?.[r])?item.groupMembers[r]:[]; td.textContent=arr.length?arr.join('、'):'未设置'; r1.appendChild(td) }); tbody.appendChild(r1); table.appendChild(tbody); tableWrap.appendChild(table); card.appendChild(tableWrap);
          const sub=el('div','subhead'); sub.innerHTML=`<i class=\"ri-repeat-2-line\"></i> 轮班预览`; card.appendChild(sub);
          const rotWrap=el('div','rot'); const rot=document.createElement('table'); const rotBody=document.createElement('tbody');
          (item.rolesGroup||[]).forEach(r=>{ const soloArr=Array.isArray(item.singleMembers?.[r])?item.singleMembers[r]:[]; if(!soloArr.length) return; const tr=document.createElement('tr'); const lc=document.createElement('td'); lc.className='rot-name'; lc.textContent=r; const rc=document.createElement('td'); rc.className='rot-names hot'; rc.textContent=soloArr.join('、'); tr.appendChild(lc); tr.appendChild(rc); rotBody.appendChild(tr) }); rot.appendChild(rotBody); rotWrap.appendChild(rot); card.appendChild(rotWrap);
          wrap.appendChild(card);
        });
      }
      (function(){ try{const u=new URL(window.location.href); channel=String(u.searchParams.get('channel')||''); caller=String(u.searchParams.get('caller')||'');}catch{}
        if(window.lowbarAPI){ window.lowbarAPI.subscribe?.(channel); window.lowbarAPI.onEvent?.((n,p)=>{ if(n!==channel)return; if(p?.type==='update'){ if(p.target==='refresh') load(); }}); }
        load();
      })();
    </script>
  </body>
  </html>
