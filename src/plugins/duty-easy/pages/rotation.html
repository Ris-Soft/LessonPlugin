<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>轮执列表</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../../renderer/settings.css" />
    <style>
      :root { --panel: rgba(255,255,255,0.06); }
      body { margin: 0; }
      .section { padding: 16px; background: transparent !important; border: none !important; }
      .editor { margin-top: 8px; }
      .row { display: flex; align-items: center; gap: 12px; margin: 6px 0; }
      input { width: 100%; box-sizing: border-box; padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); }
      .actions { display: flex; gap: 8px; margin-top: 8px; }
      .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); cursor: pointer; }
      .btn.secondary { background: rgba(255,255,255,0.08); }
      .btn.danger { background: rgba(255, 100, 100, 0.2); border-color: rgba(255, 100, 100, 0.4); }
    </style>
  </head>
  <body>
    <div class="section">
      <div class="section-title"><i class="ri-loop-left-line"></i> 轮执列表</div>
      <div class="editor">
        <div id="rotLists"></div>
        <div class="actions">
          <button id="addRot" class="btn secondary"><i class="ri-add-line"></i> 新增轮执表</button>
        </div>
      </div>
    </div>
    <script>
      let channel=''; let cfg={ rotationLists:[], roles:[] };
      function el(t,c){const e=document.createElement(t); if(c)e.className=c; return e}
      async function load(){
        try {
          if (window.lowbarAPI?.pluginCall) {
            const res=await window.lowbarAPI.pluginCall('duty.easy','getConfig'); const r=res?.result||res; cfg=r?.config||{};
          } else if (window.lowbarAPI?.configEnsureDefaults) {
            await window.lowbarAPI.configEnsureDefaults('duty.easy',{});
            const all=await window.lowbarAPI.configGetAll('duty.easy'); cfg=all||{};
          } else if (window.pluginAPI?.configEnsureDefaults) {
            await window.pluginAPI.configEnsureDefaults('duty.easy',{});
            const all=await window.pluginAPI.configGetAll('duty.easy'); cfg=all||{};
          }
        } catch {}
        if(!Array.isArray(cfg.rotationLists)) cfg.rotationLists=[]; if(!Array.isArray(cfg.roles)) cfg.roles=[]; render()
      }
      function render(){ const box=document.getElementById('rotLists'); box.innerHTML=''; (cfg.rotationLists||[]).forEach((it,idx)=>{ const row=el('div','row'); const name=document.createElement('input'); name.value=it.name||''; name.placeholder='轮执表名称'; const roles=document.createElement('input'); roles.value=Array.isArray(it.roles)?it.roles.join(','):''; roles.placeholder='使用的分工，逗号分隔'; const del=document.createElement('button'); del.className='btn danger'; del.innerHTML='<i class="ri-delete-bin-line"></i> 删除'; del.addEventListener('click',()=>{ cfg.rotationLists.splice(idx,1); render() }); name.addEventListener('input',()=>{ cfg.rotationLists[idx].name=name.value }); roles.addEventListener('input',()=>{ cfg.rotationLists[idx].roles=roles.value.split(',').map(s=>s.trim()).filter(s=>s) }); row.appendChild(name); row.appendChild(roles); row.appendChild(del); box.appendChild(row) }) }
      async function save(){ try {
        if (window.lowbarAPI?.pluginCall) {
          await window.lowbarAPI.pluginCall('duty.easy','saveConfig',[{ rotationLists: cfg.rotationLists }]);
          const res=await window.lowbarAPI.pluginCall('duty.easy','getConfig'); const r=res?.result||res; cfg=r?.config||cfg;
        } else if (window.lowbarAPI?.configEnsureDefaults) {
          await window.lowbarAPI.configEnsureDefaults('duty.easy',{});
          await window.lowbarAPI.configSet('duty.easy','rotationLists',cfg.rotationLists);
          const verify=await window.lowbarAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        } else if (window.pluginAPI?.configEnsureDefaults) {
          await window.pluginAPI.configEnsureDefaults('duty.easy',{});
          await window.pluginAPI.configSet('duty.easy','rotationLists',cfg.rotationLists);
          const verify=await window.pluginAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        }
      } catch {} }
      (function(){ try{const u=new URL(window.location.href); channel=String(u.searchParams.get('channel')||'')}catch{}
        if(window.lowbarAPI){ window.lowbarAPI.subscribe?.(channel); window.lowbarAPI.onEvent?.(async (n,p)=>{ if(n!==channel)return; if(p?.type==='update'){ if(p.target==='duty.save'){ await save() } }}); }
        load(); document.getElementById('addRot').addEventListener('click',()=>{ cfg.rotationLists.push({ name:'新轮执', roles:(cfg.roles||[]).slice() }); render() })
      })();
    </script>
  </body>
  </html>