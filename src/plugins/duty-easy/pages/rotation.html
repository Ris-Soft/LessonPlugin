<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>单人轮值设置</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../../renderer/settings.css" />
    <style>
      :root { --panel: rgba(255,255,255,0.06); }
      body { margin: 0; }
      .section { padding: 16px; background: transparent !important; border: none !important; }
      .editor { margin-top: 8px; }
      .row { display: flex; align-items: center; gap: 12px; margin: 6px 0; }
      input { width: 100%; box-sizing: border-box; padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); }
      .actions { display: flex; gap: 8px; margin-top: 8px; }
      .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); cursor: pointer; }
      .btn.secondary { background: rgba(255,255,255,0.08); }
      .btn.danger { background: rgba(255, 100, 100, 0.2); border-color: rgba(255, 100, 100, 0.4); }
      .tag { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); margin: 4px; }
      .hint { color: rgba(255,100,100,0.9); font-size: 12px; margin-top: 6px; }
      .weekday { display:inline-flex; align-items:center; gap:6px; margin-right:8px; }
      .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 999; }
      .overlay .panel { width: 520px; max-width: calc(100% - 40px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(30,30,30,0.95); padding: 16px; }
      .overlay .row { margin: 8px 0; }
      .overlay select { padding:6px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); }
      .overlay .title { font-weight: 800; margin-bottom: 8px; }
      .hot { margin-top: 10px; }
      .hot .row { display:flex; align-items:center; gap:10px; }
      .hot .label { width:120px; color: var(--muted); }
      .hot .val { font-weight:700; width:120px; flex:0 0 120px; text-align:center; }
      .hot .chip { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); cursor:pointer }
      .hot .chip.hot { border-color: rgba(138,180,248,0.7); background: rgba(138,180,248,0.15); box-shadow: 0 0 0 2px rgba(138,180,248,0.25) inset }
      .tag.hot { border-color: rgba(138,180,248,0.7); background: rgba(138,180,248,0.15); }
      .hot .val.hot { color: rgba(138,180,248,0.95); }
      .list-item { display:flex; align-items:center; gap:8px; margin:4px 0; }
      .list-item .ops { display:flex; gap:6px; }
      .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
      .tab { padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); cursor:pointer; color: var(--fg); font-size:12px }
      .tab.active { background: rgba(138,180,248,0.18); border-color: rgba(138,180,248,0.6) }
    </style>
  </head>
  <body>
    <div class="section">
      <div id="rotListsWrap" style="display:none;">
        <div class="section-title"><i class="ri-loop-left-line"></i> 轮执列表</div>
        <div class="editor">
          <div id="rotLists"></div>
          <div class="actions">
            <button id="addRot" class="btn secondary"><i class="ri-add-line"></i> 新增轮执表</button>
          </div>
        </div>
      </div>
      <div id="singleRolesWrap">
        <div class="section-title"><i class="ri-user-star-line"></i> 单人轮值分工</div>
        <div class="editor">
          <div id="singleRoles"></div>
          <div class="actions">
            <button id="addSingleRole" class="btn secondary"><i class="ri-add-line"></i> 新增分工</button>
            <button id="saveSingleRoles" class="btn"><i class="ri-save-3-line"></i> 保存</button>
          </div>
        </div>
      </div>
      <div id="singleListsWrap">
        <div class="section-title"><i class="ri-user-star-line"></i> 单人轮值名单</div>
        <div class="actions">
          <button id="openSingleRoles" class="btn secondary"><i class="ri-settings-3-line"></i> 分工设置</button>
          <button id="saveSingleLists" class="btn"><i class="ri-save-3-line"></i> 保存</button>
        </div>
        <div id="roleTabs" class="tabs"></div>
        <div id="roleEditor"></div>
      </div>
      <div class="overlay" id="condOverlay">
        <div class="panel">
          <div class="title"><i class="ri-slideshow-3-line"></i> 轮值条件</div>
          <div class="row"><span id="condRole" style="font-weight:700"></span></div>
          <div class="row"><select id="condMode"><option value="every">每周</option><option value="odd">单周</option><option value="even">双周</option></select></div>
          <div class="row" id="condDays"></div>
          <div class="actions">
            <button id="condSave" class="btn"><i class="ri-save-3-line"></i> 保存</button>
            <button id="condClose" class="btn"><i class="ri-close-line"></i> 关闭</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      let channel=''; const studentsChannel='profiles.students.channel'; let currentRole=null; let mode=''; let cfg={ rotationLists:[], roles:[], singleRoleLists:{}, singleRoles:[], singleRoleConditions:{}, rule:{ mainMode:'group' } };
      let condEditingRole='';
      function el(t,c){const e=document.createElement(t); if(c)e.className=c; return e}
      async function load(){
        try {
          if (window.lowbarAPI?.pluginCall) {
            const res=await window.lowbarAPI.pluginCall('duty.easy','getConfig'); const r=res?.result||res; cfg=r?.config||{};
          } else if (window.lowbarAPI?.configEnsureDefaults) {
            await window.lowbarAPI.configEnsureDefaults('duty.easy',{});
            const all=await window.lowbarAPI.configGetAll('duty.easy'); cfg=all||{};
          } else if (window.pluginAPI?.configEnsureDefaults) {
            await window.pluginAPI.configEnsureDefaults('duty.easy',{});
            const all=await window.pluginAPI.configGetAll('duty.easy'); cfg=all||{};
          }
        } catch {}
        if(!Array.isArray(cfg.rotationLists)) cfg.rotationLists=[]; if(!Array.isArray(cfg.roles)) cfg.roles=[]; if(typeof cfg.singleRoleLists!=='object'||!cfg.singleRoleLists) cfg.singleRoleLists={}; if(!Array.isArray(cfg.singleRoles)) cfg.singleRoles=(cfg.roles||[]).slice(); if(typeof cfg.singleRoleConditions!=='object'||!cfg.singleRoleConditions) cfg.singleRoleConditions={}; render(); renderSingleRoles(); renderSingleHot(); toggleRotLists()
      }
      function render(){ const box=document.getElementById('rotLists'); box.innerHTML=''; (cfg.rotationLists||[]).forEach((it,idx)=>{ const row=el('div','row'); const name=document.createElement('input'); name.value=it.name||''; name.placeholder='轮执表名称'; const roles=document.createElement('input'); roles.value=Array.isArray(it.roles)?it.roles.join(','):''; roles.placeholder='使用的分工，逗号分隔'; const del=document.createElement('button'); del.className='btn danger'; del.innerHTML='<i class="ri-delete-bin-line"></i> 删除'; del.addEventListener('click',()=>{ cfg.rotationLists.splice(idx,1); render() }); name.addEventListener('input',()=>{ cfg.rotationLists[idx].name=name.value }); roles.addEventListener('input',()=>{ cfg.rotationLists[idx].roles=roles.value.split(',').map(s=>s.trim()).filter(s=>s) }); row.appendChild(name); row.appendChild(roles); row.appendChild(del); box.appendChild(row) }) }
      function renderSingle(){ const tabs=document.getElementById('roleTabs'); const editor=document.getElementById('roleEditor'); const roles=Array.isArray(cfg.singleRoles)?cfg.singleRoles:[]; tabs.innerHTML=''; if(!window.__editingRole || !roles.includes(window.__editingRole)) window.__editingRole=String(roles[0]||''); roles.forEach(r=>{ const t=el('span','tab'); t.textContent=r; if(r===window.__editingRole) t.classList.add('active'); t.addEventListener('click',()=>{ window.__editingRole=r; renderSingle() }); tabs.appendChild(t) }); editor.innerHTML=''; const role=window.__editingRole; if(!role) return; const rule=cfg.rule||{}; const indices=(typeof rule.singleRoleIndices==='object'&&rule.singleRoleIndices)?rule.singleRoleIndices:{}; const hotIdx=Number.isFinite(indices[role])?indices[role]:-1; const arr=Array.isArray(cfg.singleRoleLists?.[role])?cfg.singleRoleLists[role]:[]; arr.forEach((n,ni)=>{ const item=el('div','list-item'); const name=el('span','tag'); name.innerHTML=`<i class="ri-user-line"></i> ${n}`; if(ni===hotIdx) name.classList.add('hot'); name.addEventListener('click',()=>{ setHotIndex(role,ni) }); const ops=el('div','ops'); const up=document.createElement('button'); up.className='btn secondary'; up.innerHTML='<i class="ri-arrow-up-s-line"></i>'; const down=document.createElement('button'); down.className='btn secondary'; down.innerHTML='<i class="ri-arrow-down-s-line"></i>'; const rm=document.createElement('button'); rm.className='btn danger'; rm.innerHTML='<i class="ri-close-line"></i>'; up.addEventListener('click',()=>{ const a=Array.isArray(cfg.singleRoleLists?.[role])?cfg.singleRoleLists[role]:(cfg.singleRoleLists[role]=[]); if(ni>0){ const tmp=a[ni-1]; a[ni-1]=a[ni]; a[ni]=tmp; renderSingle() } }); down.addEventListener('click',()=>{ const a=Array.isArray(cfg.singleRoleLists?.[role])?cfg.singleRoleLists[role]:(cfg.singleRoleLists[role]=[]); if(ni<a.length-1){ const tmp=a[ni+1]; a[ni+1]=a[ni]; a[ni]=tmp; renderSingle() } }); rm.addEventListener('click',()=>{ const a=Array.isArray(cfg.singleRoleLists?.[role])?cfg.singleRoleLists[role]:(cfg.singleRoleLists[role]=[]); a.splice(ni,1); renderSingle() }); ops.appendChild(up); ops.appendChild(down); ops.appendChild(rm); item.appendChild(name); item.appendChild(ops); editor.appendChild(item) }); const add=document.createElement('button'); add.className='btn secondary'; add.innerHTML='<i class="ri-add-line"></i> 添加'; add.addEventListener('click',()=>{ if(hasDupRoles()){ showDupHint(); return } currentRole=role; openStudentsPicker() }); editor.appendChild(add) }
      function renderSingleHot(){ renderSingle() }
      async function setHotIndex(role, index){ try{ if (window.lowbarAPI?.pluginCall) { const res=await window.lowbarAPI.pluginCall('duty.easy','getConfig'); const r=res?.result||res; const current=r?.config||{}; const rule=current.rule||{}; const indices=(typeof rule.singleRoleIndices==='object'&&rule.singleRoleIndices)?{...rule.singleRoleIndices}:{ }; indices[role]=index; const nextRule={ ...rule, singleRoleIndices: indices }; await window.lowbarAPI.pluginCall('duty.easy','saveConfig',[{ rule: nextRule }]); const verify=await window.lowbarAPI.pluginCall('duty.easy','getConfig'); const rr=verify?.result||verify; cfg=rr?.config||cfg; renderSingle(); try{ if(channel) window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'refresh', value:true }) }catch{} } else if (window.lowbarAPI?.configSet) { const all=await window.lowbarAPI.configGetAll('duty.easy'); const rule=all.rule||{}; const indices=(typeof rule.singleRoleIndices==='object'&&rule.singleRoleIndices)?{...rule.singleRoleIndices}:{ }; indices[role]=index; await window.lowbarAPI.configSet('duty.easy','rule',{ ...rule, singleRoleIndices: indices }); const verify=await window.lowbarAPI.configGetAll('duty.easy'); cfg=verify||cfg; renderSingle(); } else if (window.pluginAPI?.configSet) { const all=await window.pluginAPI.configGetAll('duty.easy'); const rule=all.rule||{}; const indices=(typeof rule.singleRoleIndices==='object'&&rule.singleRoleIndices)?{...rule.singleRoleIndices}:{ }; indices[role]=index; await window.pluginAPI.configSet('duty.easy','rule',{ ...rule, singleRoleIndices: indices }); const verify=await window.pluginAPI.configGetAll('duty.easy'); cfg=verify||cfg; renderSingle(); } }catch{} }
      function renderSingleRoles(){ const box=document.getElementById('singleRoles'); box.innerHTML=''; (cfg.singleRoles||[]).forEach((name,idx)=>{ const row=el('div','row'); const inp=document.createElement('input'); inp.value=name||''; inp.placeholder='分工名称'; const up=document.createElement('button'); up.className='btn secondary'; up.innerHTML='<i class="ri-arrow-up-s-line"></i>'; const down=document.createElement('button'); down.className='btn secondary'; down.innerHTML='<i class="ri-arrow-down-s-line"></i>'; const cond=document.createElement('button'); cond.className='btn secondary'; cond.innerHTML='<i class="ri-slideshow-3-line"></i> 条件'; const del=document.createElement('button'); del.className='btn danger'; del.innerHTML='<i class="ri-delete-bin-line"></i>'; inp.addEventListener('input',()=>{ cfg.singleRoles[idx]=inp.value }); up.addEventListener('click',()=>{ if(idx>0){ const t=cfg.singleRoles[idx]; cfg.singleRoles[idx]=cfg.singleRoles[idx-1]; cfg.singleRoles[idx-1]=t; renderSingleRoles() } }); down.addEventListener('click',()=>{ if(idx<cfg.singleRoles.length-1){ const t=cfg.singleRoles[idx]; cfg.singleRoles[idx]=cfg.singleRoles[idx+1]; cfg.singleRoles[idx+1]=t; renderSingleRoles() } }); cond.addEventListener('click',()=>{ showCondOverlay(cfg.singleRoles[idx]) }); del.addEventListener('click',()=>{ const name=cfg.singleRoles[idx]; cfg.singleRoles.splice(idx,1); if(cfg.singleRoleLists && typeof cfg.singleRoleLists==='object'){ delete cfg.singleRoleLists[name]; } renderSingleRoles(); renderSingle() }); row.appendChild(inp); row.appendChild(up); row.appendChild(down); row.appendChild(cond); row.appendChild(del); box.appendChild(row) }) }
      function hasDupRoles(){ const names=(cfg.singleRoles||[]).map(s=>String(s||'').trim()).filter(Boolean); return names.some((n,idx)=>names.indexOf(n)!==idx) }
      function showDupHint(){ let hint=document.getElementById('rotation-dup-hint'); if(!hint){ hint=document.createElement('div'); hint.id='rotation-dup-hint'; hint.className='hint'; hint.textContent='存在重复分工名称，请在当前页的“单人轮值分工”中修正为唯一后再添加'; document.querySelector('.section').appendChild(hint) } }
      function toggleRotLists(){ const wrap=document.getElementById('rotListsWrap'); if(!wrap) return; wrap.style.display='none'; }
      async function save(){ try {
        if (window.lowbarAPI?.pluginCall) {
          await window.lowbarAPI.pluginCall('duty.easy','saveConfig',[{ singleRoleLists: cfg.singleRoleLists, singleRoles: cfg.singleRoles, singleRoleConditions: cfg.singleRoleConditions }]);
          const res=await window.lowbarAPI.pluginCall('duty.easy','getConfig'); const r=res?.result||res; cfg=r?.config||cfg;
          try{ if(channel) window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'refresh', value:true }) }catch{}
        } else if (window.lowbarAPI?.configEnsureDefaults) {
          await window.lowbarAPI.configEnsureDefaults('duty.easy',{});
          await window.lowbarAPI.configSet('duty.easy','singleRoleLists',cfg.singleRoleLists);
          await window.lowbarAPI.configSet('duty.easy','singleRoles',cfg.singleRoles);
          await window.lowbarAPI.configSet('duty.easy','singleRoleConditions',cfg.singleRoleConditions);
          const verify=await window.lowbarAPI.configGetAll('duty.easy'); cfg=verify||cfg;
          try{ if(channel) window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'refresh', value:true }) }catch{}
        } else if (window.pluginAPI?.configEnsureDefaults) {
          await window.pluginAPI.configEnsureDefaults('duty.easy',{});
          await window.pluginAPI.configSet('duty.easy','singleRoleLists',cfg.singleRoleLists);
          await window.pluginAPI.configSet('duty.easy','singleRoles',cfg.singleRoles);
          await window.pluginAPI.configSet('duty.easy','singleRoleConditions',cfg.singleRoleConditions);
          const verify=await window.pluginAPI.configGetAll('duty.easy'); cfg=verify||cfg;
          try{ if(channel) window.pluginAPI.emitEvent?.(channel,{ type:'update', target:'refresh', value:true }) }catch{}
        }
      } catch {} }
      function toggleSections(){ const a=document.getElementById('singleRolesWrap'); const b=document.getElementById('singleListsWrap'); if(mode==='roles'){ if(a) a.style.display='block'; if(b) b.style.display='none'; } else { if(a) a.style.display='none'; if(b) b.style.display='block'; } }
      function openSingleRoles(){ try{ const url=new URL(window.location.href); url.searchParams.set('mode','roles'); window.lowbarAPI?.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      function openStudentsPicker(){ try{ const url=new URL('../../../plugins/profiles-students/index.html', window.location.href); url.searchParams.set('channel', studentsChannel); url.searchParams.set('caller','profiles.students'); url.searchParams.set('mode','pick'); window.lowbarAPI?.emitEvent?.(channel, { type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      function showCondOverlay(role){ const ov=document.getElementById('condOverlay'); const lab=document.getElementById('condRole'); const modeSel=document.getElementById('condMode'); const days=document.getElementById('condDays'); condEditingRole=role; lab.textContent=role; days.innerHTML=''; const names=['周一','周二','周三','周四','周五','周六','周日']; const values=[1,2,3,4,5,6,7]; const cond=cfg.singleRoleConditions[role]||{}; modeSel.value=cond.mode||'every'; const selected=Array.isArray(cond.weekdays)?cond.weekdays:[]; values.forEach((v,i)=>{ const w=document.createElement('label'); w.className='weekday'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=selected.includes(v); cb.addEventListener('change',()=>{ const c=cfg.singleRoleConditions[role]||(cfg.singleRoleConditions[role]={}); const arr=Array.isArray(c.weekdays)?c.weekdays:(c.weekdays=[]); const idx=arr.indexOf(v); if(cb.checked){ if(idx<0) arr.push(v) } else { if(idx>=0) arr.splice(idx,1) } }); const tx=document.createTextNode(names[i]); w.appendChild(cb); w.appendChild(tx); days.appendChild(w) }); ov.style.display='flex'; }
      function hideCondOverlay(){ const ov=document.getElementById('condOverlay'); ov.style.display='none'; condEditingRole=''; }
      (function(){ try{const u=new URL(window.location.href); channel=String(u.searchParams.get('channel')||''); mode=String(u.searchParams.get('mode')||'')}catch{}
        if(window.lowbarAPI){ window.lowbarAPI.subscribe?.(channel); window.lowbarAPI.subscribe?.(studentsChannel); window.lowbarAPI.onEvent?.(async (n,p)=>{ if(n!==channel && n!==studentsChannel) return; if(p?.type==='update'){ if(n===channel && p.target==='duty.save'){ await save() } if(n===channel && p.target==='refresh'){ await load(); renderSingle(); renderSingleRoles(); toggleRotLists(); toggleSections() } } if(n===studentsChannel){ const name=String(p?.name||'').trim(); if(p?.type==='pick' && name && currentRole){ if(hasDupRoles()){ currentRole=null; showDupHint(); return } const arr=Array.isArray(cfg.singleRoleLists?.[currentRole])?cfg.singleRoleLists[currentRole]:(cfg.singleRoleLists[currentRole]=[]); arr.push(name); currentRole=null; renderSingle(); try{ window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value:null }); }catch{} } } }); }
        load(); document.getElementById('openSingleRoles').addEventListener('click',openSingleRoles);
        document.getElementById('addSingleRole').addEventListener('click',()=>{ (cfg.singleRoles||[]).push('新分工'); renderSingleRoles() });
        document.getElementById('saveSingleRoles').addEventListener('click',async ()=>{ await save() });
        document.getElementById('saveSingleLists').addEventListener('click',async ()=>{ await save() });
        document.getElementById('condSave').addEventListener('click',async ()=>{ const mode=document.getElementById('condMode').value; const c=cfg.singleRoleConditions[condEditingRole]||(cfg.singleRoleConditions[condEditingRole]={}); c.mode=mode; await save(); hideCondOverlay() });
        document.getElementById('condClose').addEventListener('click',()=>{ hideCondOverlay() });
        setTimeout(()=>{ renderSingle(); renderSingleRoles(); toggleRotLists(); toggleSections() }, 50);
      })();
    </script>
  </body>
  </html>
