<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>组别分工</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../../renderer/settings.css" />
    <style>
      :root { --panel: rgba(255,255,255,0.06); }
      body { margin: 0; }
      .section { padding: 16px; background: transparent !important; border: none !important; }
      .table-wrap { border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; overflow: auto; }
      table { width: 100%; border-collapse: collapse; table-layout: fixed; }
      th, td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 8px; }
      th { text-align: left; color: var(--muted); font-weight: 600; position: sticky; top: 0; background: #0b1520; }
      .cell { min-height: 40px; border: 1px dashed rgba(255,255,255,0.12); border-radius: 8px; padding: 6px; }
      .cell.drag-over { background: rgba(255,255,255,0.06); }
      .tag { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); cursor: grab; margin: 4px; }
      .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); cursor: pointer; }
      .btn.secondary { background: rgba(255,255,255,0.08); }
    </style>
  </head>
  <body>
    <div class="section">
      <div class="section-title"><i class="ri-team-line"></i> 组别分工表</div>
      <div class="table-wrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
    <script>
      let channel=''; let caller=''; const studentsChannel='profiles.students.channel'; let currentPick=null; let cfg={ roles:[], groups:[] };
      function el(t,c){const e=document.createElement(t); if(c)e.className=c; return e}
      async function load(){
        try {
          if (window.lowbarAPI?.pluginCall) {
            const res=await window.lowbarAPI.pluginCall(caller,'getConfig'); const r=res?.result||res; cfg=r?.config||{};
          } else if (window.lowbarAPI?.configEnsureDefaults) {
            await window.lowbarAPI.configEnsureDefaults('duty.easy',{
              roles: ['清洁','黑板','值日生'],
              groups: [
                { name: '一组', roles: { '清洁': [], '黑板': [], '值日生': [] } },
                { name: '二组', roles: { '清洁': [], '黑板': [], '值日生': [] } }
              ]
            });
            const all=await window.lowbarAPI.configGetAll('duty.easy'); cfg=all||{};
          } else if (window.pluginAPI?.configEnsureDefaults) {
            await window.pluginAPI.configEnsureDefaults('duty.easy',{});
            const all=await window.pluginAPI.configGetAll('duty.easy'); cfg=all||{};
          }
        } catch {}
        if(!Array.isArray(cfg.roles)) cfg.roles=[]; if(!Array.isArray(cfg.groups)) cfg.groups=[]; render()
      }
      function render(){ const thead=document.getElementById('thead'); const tbody=document.getElementById('tbody'); thead.innerHTML=''; tbody.innerHTML=''; const trh=el('tr'); const th0=el('th'); th0.textContent='组别'; trh.appendChild(th0); (cfg.roles||[]).forEach(r=>{ const th=el('th'); th.textContent=r||''; trh.appendChild(th) }); thead.appendChild(trh);
        (cfg.groups||[]).forEach((g,gi)=>{ const tr=el('tr'); const tdGroup=el('td'); tdGroup.textContent=g.name||''; tr.appendChild(tdGroup);
          (cfg.roles||[]).forEach(r=>{ const td=el('td'); const cell=el('div','cell'); const arr=Array.isArray(g.roles?.[r])?g.roles[r]:[];
            arr.forEach((n,ni)=>{ const t=el('span','tag'); t.draggable=true; t.textContent=n||''; const rm=document.createElement('button'); rm.innerHTML='<i class="ri-close-line"></i>'; rm.addEventListener('click',(e)=>{ e.stopPropagation(); const a=Array.isArray(cfg.groups?.[gi]?.roles?.[r])?cfg.groups[gi].roles[r]:[]; a.splice(ni,1); render() }); t.appendChild(rm);
              t.addEventListener('dragstart',e=>{ try{ e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('application/json', JSON.stringify({type:'name',from:{gi,r,ni},name:n})); e.dataTransfer.setData('text/plain', JSON.stringify({type:'name',from:{gi,r,ni},name:n})); }catch{} });
              t.addEventListener('dragover',e=>{ e.preventDefault(); try{ e.dataTransfer.dropEffect='move' }catch{} });
              t.addEventListener('drop',e=>{ e.preventDefault(); const raw=e.dataTransfer.getData('application/json')||e.dataTransfer.getData('text/plain'); const data=safeParse(raw); if(data?.type==='name'){ const sgi=data.from.gi; const sr=data.from.r; const sni=data.from.ni; const srcArr=Array.isArray(cfg.groups?.[sgi]?.roles?.[sr])?cfg.groups[sgi].roles[sr]:[]; const tgtArr=Array.isArray(cfg.groups?.[gi]?.roles?.[r])?cfg.groups[gi].roles[r]:[]; const srcName=srcArr[sni]; srcArr[sni]=tgtArr[ni]; tgtArr[ni]=srcName; render() } }); cell.appendChild(t) });
            cell.addEventListener('dragover',e=>{ e.preventDefault(); try{ e.dataTransfer.dropEffect='move' }catch{}; cell.classList.add('drag-over') });
            cell.addEventListener('dragleave',()=>{ cell.classList.remove('drag-over') });
            cell.addEventListener('drop',e=>{ e.preventDefault(); cell.classList.remove('drag-over'); const data=safeParse(e.dataTransfer.getData('text/plain')); if(data?.type==='name'){ const sgi=data.from.gi; const sr=data.from.r; const sni=data.from.ni; const srcArr=Array.isArray(cfg.groups?.[sgi]?.roles?.[sr])?cfg.groups[sgi].roles[sr]:[]; const tgtArr=Array.isArray(cfg.groups?.[gi]?.roles?.[r])?cfg.groups[gi].roles[r]:[]; const mv=srcArr.splice(sni,1)[0]; tgtArr.push(mv); render() } });
            const addBtn=el('button','btn secondary'); addBtn.innerHTML='<i class="ri-add-line"></i> 添加'; addBtn.addEventListener('click',()=>{ currentPick={gi,r}; openStudentsPicker(); }); cell.appendChild(addBtn);
            td.appendChild(cell); tr.appendChild(td)
          }); tbody.appendChild(tr)
        })
      }
      function openStudentsPicker(){ try{ const url=new URL('../../../plugins/profiles-students/index.html', window.location.href); url.searchParams.set('channel', studentsChannel); url.searchParams.set('caller','profiles.students'); window.lowbarAPI?.emitEvent?.(channel, { type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      function safeParse(t){ try{ return JSON.parse(String(t||'')) }catch{ return null } }
      async function save(){ try {
        if (window.lowbarAPI?.pluginCall) {
          await window.lowbarAPI.pluginCall(caller,'saveConfig',[{ groups: cfg.groups }]);
          const res=await window.lowbarAPI.pluginCall(caller,'getConfig'); const r=res?.result||res; cfg=r?.config||cfg;
        } else if (window.lowbarAPI?.configEnsureDefaults) {
          await window.lowbarAPI.configEnsureDefaults('duty.easy',{
            roles: ['清洁','黑板','值日生'],
            groups: [
              { name: '一组', roles: { '清洁': [], '黑板': [], '值日生': [] } },
              { name: '二组', roles: { '清洁': [], '黑板': [], '值日生': [] } }
            ]
          });
          await window.lowbarAPI.configSet('duty.easy','groups',cfg.groups);
          const verify=await window.lowbarAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        } else if (window.pluginAPI?.configEnsureDefaults) {
          await window.pluginAPI.configEnsureDefaults('duty.easy',{});
          await window.pluginAPI.configSet('duty.easy','groups',cfg.groups);
          const verify=await window.pluginAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        }
      } catch {} }
      (function(){ try{const u=new URL(window.location.href); channel=String(u.searchParams.get('channel')||''); caller=String(u.searchParams.get('caller')||'')}catch{}
        if(window.lowbarAPI){ if(channel) window.lowbarAPI.subscribe?.(channel); window.lowbarAPI.subscribe?.(studentsChannel); window.lowbarAPI.onEvent?.(async (n,p)=>{ if(p?.type==='update'){ if(n===channel && p.target==='duty.save'){ await save(); await load() } } if(n===studentsChannel){ const name=String(p?.name||'').trim(); if(p?.type==='pick' && name && currentPick){ const arr=Array.isArray(cfg.groups?.[currentPick.gi]?.roles?.[currentPick.r])?cfg.groups[currentPick.gi].roles[currentPick.r]:(cfg.groups[currentPick.gi].roles[currentPick.r]=[]); arr.push(name); currentPick=null; render(); try{ window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value:null }); }catch{} } } }); }
        load()
      })();
    </script>
  </body>
  </html>