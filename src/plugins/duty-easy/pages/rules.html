<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>分工规则</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../../renderer/settings.css" />
    <style>
      body { margin: 0; }
      .section { padding: 16px; background: transparent !important; border: none !important; }
      .list { display: flex; flex-direction: column; gap: 8px; }
      .item { display: flex; gap: 8px; align-items: center; }
      .label { width: 120px; color: var(--muted); }
      select { flex: 1; padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); }
      .mode { display: flex; gap: 8px; align-items: center; }
      .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); cursor: pointer; }
      .actions { display: flex; gap: 8px; margin-top: 8px; }
    </style>
  </head>
  <body>
    <div class="section">
      <div class="section-title"><i class="ri-settings-3-line"></i> 分工规则</div>
      <div class="list">
        <div class="item mode">
          <span class="label">主模式</span>
          <select id="mainMode">
            <option value="group">组别更替</option>
            <option value="single">单人轮值</option>
          </select>
        </div>
        <div class="item mode">
          <span class="label">切换方式</span>
          <select id="mode">
            <option value="list">按照列表顺序</option>
            <option value="weekday">按照星期对应组别</option>
          </select>
        </div>
        <div id="weekBox"></div>
      </div>
      <div class="actions">
        <button id="save" class="btn"><i class="ri-save-3-line"></i> 保存</button>
      </div>
    </div>
    <script>
      let channel=''; let cfg={ rule:{ mode:'list', weekdayMap:{}, currentGroupIndex:0, currentRotationIndex:0, mainMode:'group' }, groups:[] };
      async function load(){ await window.lowbarAPI.configEnsureDefaults('duty.easy',{}); const all=await window.lowbarAPI.configGetAll('duty.easy'); cfg=all||{}; if(!cfg.rule) cfg.rule={ mode:'list', weekdayMap:{}, currentGroupIndex:0, currentRotationIndex:0, mainMode:'group' }; if(!Array.isArray(cfg.groups)) cfg.groups=[]; document.getElementById('mode').value=String(cfg.rule.mode||'list'); document.getElementById('mainMode').value=String(cfg.rule.mainMode||'group'); renderWeek(); renderVisibility() }
      function renderWeek(){ const mode=document.getElementById('mode').value; const box=document.getElementById('weekBox'); box.innerHTML=''; if(mode!=='weekday') return; const names=(cfg.groups||[]).map(g=>g.name||''); const map=cfg.rule.weekdayMap||{}; const labels=['周日','周一','周二','周三','周四','周五','周六']; for(let i=0;i<7;i++){ const wrap=document.createElement('div'); wrap.className='item'; const lab=document.createElement('span'); lab.className='label'; lab.textContent=labels[i]; const sel=document.createElement('select'); names.forEach((n,gi)=>{ const op=document.createElement('option'); op.value=String(gi); op.textContent=n||''; sel.appendChild(op) }); const cur=Number.isFinite(map[i])?map[i]:0; sel.value=String(cur); sel.addEventListener('change',()=>{ cfg.rule.weekdayMap[i]=parseInt(sel.value,10) }); wrap.appendChild(lab); wrap.appendChild(sel); box.appendChild(wrap) } }
      function renderVisibility(){ const main=document.getElementById('mainMode').value; const modeWrap=document.getElementById('mode').parentElement; const weekWrap=document.getElementById('weekBox'); if(main==='single'){ modeWrap.style.display='none'; weekWrap.innerHTML=''; } else { modeWrap.style.display=''; }
      }
      function save(){ const mode=document.getElementById('mode').value; const main=document.getElementById('mainMode').value; cfg.rule.mode=mode; cfg.rule.mainMode=main; window.lowbarAPI.configSet('duty.easy','rule',cfg.rule); try{ const u=new URL(window.location.href); const ch=String(u.searchParams.get('channel')||''); if(ch) window.lowbarAPI.emitEvent?.(ch,{ type:'update', target:'refresh', value:true }) }catch{} }
      (function(){ try{ const u=new URL(window.location.href); channel=String(u.searchParams.get('channel')||'') }catch{}
        if(window.lowbarAPI){ window.lowbarAPI.subscribe?.(channel); window.lowbarAPI.onEvent?.((n,p)=>{ if(n!==channel) return; if(p?.type==='update'){ if(p.target==='duty.save'){ save() } } }); }
        load(); document.getElementById('mode').addEventListener('change',renderWeek); document.getElementById('mainMode').addEventListener('change',()=>{ renderVisibility(); }); document.getElementById('save').addEventListener('click',save)
      })();
    </script>
  </body>
  </html>
