<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>屏幕罗盘设置</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <style>
      :root { --fg: #e6f0ff; --muted: #88a; }
      html, body { height: 100%; }
      body { margin: 0; background: transparent; color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Microsoft YaHei', sans-serif; }
      .wrap { padding: 16px; }
      .title { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
      .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
      input, select { height:30px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color:#e6f0ff; padding:0 8px; }
      select, .sel { appearance: none; -webkit-appearance: none; -moz-appearance: none; background: rgba(255,255,255,0.06) !important; color:#e6f0ff !important; border:1px solid rgba(255,255,255,0.2) !important; }
      option { background: #182030; color: #e6f0ff; }
      .del { margin-left:auto; height:30px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#e6f0ff; cursor:pointer; }
      .actions { display:flex; gap:8px; margin-top:10px; }
      .btn { height:32px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#e6f0ff; cursor:pointer; padding: 0 10px; display:flex; align-items:center; gap:6px; }
      .btn.primary { border-color: rgba(64,224,128,0.4); background: rgba(64,224,128,0.18); }
      .arg-list { display:flex; flex-direction:column; gap:6px; }
      .arg-item { display:flex; gap:6px; align-items:center; }
      .arg-item input { flex:1; }
      .arg-item .del { height:30px; }
      .seg { display:flex; gap:6px; }
      .seg .btn { height:30px; padding:0 12px; }
      .seg .btn.active { border-color: rgba(64,128,255,0.42); background: rgba(64,128,255,0.22); }
      .pane-row { display:flex; gap:12px; align-items:flex-start; margin-top:12px; }
      .preview { border:1px solid rgba(255,255,255,0.2); border-radius:10px; background: rgba(16,24,36,0.4); width: 240px; height: 240px; display:flex; align-items:center; justify-content:center; position: relative; overflow:hidden; }
      .preview .root { width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; }
      .preview .circle-bg { position:absolute; inset:0; border-radius:50%; background: rgba(20,28,40,0.28); border: 1px solid rgba(255,255,255,0.18); }
      .preview .ring { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
      .preview .sectors { position:absolute; inset:0; pointer-events:none; }
      .preview .wedge { transition: opacity .2s ease; }
      .preview .item { width: 44px; height: 58px; border-radius: 12px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; background: rgba(20,28,40,0.52); border: 1px solid rgba(255,255,255,0.28); pointer-events:auto; cursor:pointer; }
      .preview .item i { font-size:22px; color:#e6f0ff; }
      .preview .item .label { font-size:11px; line-height:12px; color:#e6f0ff; opacity:0.88; max-width:64px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .preview .center-btn { width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; background: rgba(20,28,40,0.62); border: 1px solid rgba(255,255,255,0.30); cursor: pointer; position: relative; z-index: 3; }
      .preview .center-btn i { font-size: 22px; color: #ffffff; }
      .preview.classic .item { background: transparent; border: none; height: 58px; width: 56px; }
      .preview.classic .item .dot { width: 52px; height: 52px; border-radius: 50%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; background: rgba(20,28,40,0.62); border: 1px solid rgba(255,255,255,0.30); }
      .preview.classic .item i { color:#ffffff; font-size: 19px; }
      .preview.classic .item .label { font-size: 11px; line-height: 12px; max-width: 48px; margin: 0; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .preview.sector .circle-bg { opacity: 1; }
      .preview.classic .circle-bg { opacity: 0; }
      .preview.sector .item { background: transparent; border: none; }
      .preview.classic .item.active .dot { border-color: rgba(64,128,255,0.42); box-shadow: 0 0 0 2px rgba(64,128,255,0.22) inset; }
      .editor { border:1px solid rgba(255,255,255,0.2); border-radius:10px; background: rgba(16,24,36,0.35); padding:10px; display:flex; flex-direction:column; gap:8px; margin-top: 12px; }
      #appearanceEditor { margin-top: 0; width: 320px; flex: 0 0 320px; position: sticky; top: 12px; }
      .editor .row { margin: 0; }
      #appearanceEditor .row label { flex: 0 0 120px; }
      #appearanceEditor .row input { flex: 1 1 auto; min-width: 0; }
      #appearanceEditor .row .btn { flex: 0 0 auto; min-width: 120px; height: 30px; padding: 0 12px; white-space: nowrap; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="title">罗盘按钮设置</div>
      <div class="row">
        <label style="min-width:80px;color:#e6f0ff;">主题</label>
        <div class="seg" id="themeSeg">
          <button class="btn" id="themeClassicBtn"><span>经典</span></button>
          <button class="btn" id="themeSectorBtn"><span>扇形</span></button>
        </div>
      </div>
      <div class="pane-row" id="pvRow">
        <div class="preview" id="preview">
          <div class="root" id="pvRoot">
            <div class="circle-bg" id="pvCircle"></div>
            <div class="sectors" id="pvSectors"></div>
            <div class="ring" id="pvRing"></div>
            <div class="center-btn" id="pvCenter"><i class="ri-compass-3-line"></i></div>
          </div>
        </div>
        <div class="editor" id="appearanceEditor">
          <div class="row">
            <label style="min-width:120px;color:#e6f0ff;">收起窗口尺寸</label>
            <input id="sizeCollapsedInput" type="number" min="40" max="240" step="1" placeholder="60" />
          </div>
          <div class="row">
            <label style="min-width:120px;color:#e6f0ff;">展开窗口尺寸</label>
            <input id="sizeExpandedInput" type="number" min="120" max="480" step="1" placeholder="240" />
          </div>
          <div class="row">
            <label style="min-width:120px;color:#e6f0ff;">中心按钮大小</label>
            <input id="centerSizeInput" type="number" min="32" max="160" step="1" placeholder="50" />
          </div>
          <div class="row">
            <label style="min-width:120px;color:#e6f0ff;">罗盘图标</label>
            <input id="centerIconInput" placeholder="ri-compass-3-line" />
            <button class="btn" id="pickCenterIcon"><i class="ri-pantone-line"></i><span>选择图标</span></button>
          </div>
        </div>
      </div>
      <div id="list"></div>
      <div class="actions">
        <button class="btn" id="openCompass"><i class="ri-compass-3-line"></i><span>打开罗盘</span></button>
        <button class="btn" id="add"><i class="ri-add-line"></i><span>新增按钮</span></button>
        <button class="btn primary" id="save"><i class="ri-check-line"></i><span>保存</span></button>
      </div>
    </div>
    <script>
      const scope = 'screen-compass';
      let items = [];
      let pluginIcons = [];
      const remixShort = ['ri-compass-3-line','ri-close-line','ri-shuffle-line','ri-settings-3-line','ri-terminal-line','ri-apps-2-line','ri-focus-3-line','ri-play-line','ri-stop-line','ri-puzzle-line','ri-presentation-line','ri-slideshow-line','ri-pencil-line','ri-brush-line','ri-quill-pen-line','ri-eraser-line'];
      let plugins = [];
      let pluginMap = {};
      async function ensureDefaults(){
        const defaults = {
          buttons: [
            { id: 'rollcall', label: '随机点名', icon: 'ri-shuffle-line', actionType: 'plugin', actionPayload: { pluginId: 'rollcall.random', fn: 'openRollcallTemplate', args: [] } }
          ]
        };
        try { await window.lowbarAPI.configEnsureDefaults(scope, defaults); } catch {}
      }
      async function load(){
        try {
          const raw = await window.lowbarAPI.configGet(scope, 'buttons');
          const list = (raw && raw.result) ? raw.result : raw;
          items = Array.isArray(list) ? list : [];
          items.forEach(it => { if (it && typeof it==='object') { if (it.actionType==='program') it.actionType='openApp'; if (it.actionType==='command') it.actionType='cmd'; } });
        } catch { items = []; }
        try { const v = await window.lowbarAPI.configGet(scope, 'sizeCollapsed'); window.__sizeCollapsed = Number((v && v.result) ? v.result : v) || 60; } catch { window.__sizeCollapsed = 60; }
        try { const v = await window.lowbarAPI.configGet(scope, 'sizeExpanded'); window.__sizeExpanded = Number((v && v.result) ? v.result : v) || 240; } catch { window.__sizeExpanded = 240; }
        try { const v = await window.lowbarAPI.configGet(scope, 'centerSize'); window.__centerSize = Number((v && v.result) ? v.result : v) || 50; } catch { window.__centerSize = 50; }
        try { const v = await window.lowbarAPI.configGet(scope, 'centerIcon'); window.__centerIcon = String((v && v.result) ? v.result : v || 'ri-compass-3-line'); } catch { window.__centerIcon = 'ri-compass-3-line'; }
        try {
          window.__centerSize = Math.max(32, Math.min(160, Number(window.__centerSize || 50)));
          window.__sizeCollapsed = Math.max(40, Math.min(240, Number(window.__sizeCollapsed || (window.__centerSize + 10))));
          window.__centerSize = Math.max(32, Math.min(160, Number(window.__sizeCollapsed - 10)));
          window.__sizeCollapsed = Math.max(40, Math.min(240, Number(window.__centerSize + 10)));
        } catch {}
      }
      function render(){
        const root = document.getElementById('list');
        root.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) return;
        if (typeof window.__selectedIndex !== 'number' || window.__selectedIndex < 0 || window.__selectedIndex >= items.length) window.__selectedIndex = 0;
        const it = items[window.__selectedIndex];
        const editor = document.createElement('div'); editor.className = 'editor';
        const row = document.createElement('div'); row.className = 'row';
        const label = document.createElement('input'); label.placeholder='名称'; label.value = it.label || '';
        const icon = document.createElement('input'); icon.placeholder='图标类名'; icon.value = it.icon || '';
        const pick = document.createElement('button'); pick.className='btn'; pick.innerHTML = '<i class="ri-pantone-line"></i><span>选择图标</span>';
        const type = document.createElement('select'); type.className = 'sel';
        ['plugin','pluginEvent','openApp','cmd','power','wait'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; type.appendChild(opt); });
        type.value = (it.actionType==='program')? 'openApp' : (it.actionType==='command'? 'cmd' : (it.actionType || 'plugin'));
        const payloadBox = document.createElement('div'); payloadBox.style.flex = '1';
        const del = document.createElement('button'); del.className='del'; del.textContent='删除'; del.onclick=()=>{ items.splice(window.__selectedIndex,1); if (window.__selectedIndex >= items.length) window.__selectedIndex = items.length - 1; render(); placePreview(); };
        row.appendChild(label); row.appendChild(icon); row.appendChild(pick); row.appendChild(type); row.appendChild(payloadBox); row.appendChild(del);
        editor.appendChild(row);
        root.appendChild(editor);
        function syncBase(){ it.label = label.value; it.icon = icon.value; it.actionType = type.value; placePreview(); }
        label.onchange=syncBase; icon.onchange=syncBase; type.onchange=()=>{ syncBase(); renderActionFields(it, payloadBox); };
        pick.onclick = () => openIconPicker(icon);
        renderActionFields(it, payloadBox);
      }
      document.getElementById('openCompass').onclick = async () => { try { await window.lowbarAPI.pluginCall('screen.compass','openCompass',[]); } catch {} };
      document.getElementById('add').onclick = () => { items.push({ id: 'btn_'+Date.now(), label:'新按钮', icon:'ri-focus-3-line', actionType:'cmd', actionPayload:{ cmd: '' } }); window.__selectedIndex = items.length - 1; render(); placePreview(); };
      let theme = 'classic';
      function updateThemeSeg(){ try {
        const c = document.getElementById('themeClassicBtn');
        const s = document.getElementById('themeSectorBtn');
        c.classList.toggle('active', theme==='classic');
        s.classList.toggle('active', theme==='sector');
      } catch {} }
      document.getElementById('themeClassicBtn').onclick = () => { theme = 'classic'; updateThemeSeg(); placePreview(); };
      document.getElementById('themeSectorBtn').onclick = () => { theme = 'sector'; updateThemeSeg(); placePreview(); };
      document.getElementById('save').onclick = async () => {
        try {
          await window.lowbarAPI.configSet(scope, 'theme', theme);
          await window.lowbarAPI.configSet(scope, 'buttons', items);
          await window.lowbarAPI.configSet(scope, 'sizeCollapsed', Math.max(40, Math.min(240, Number(document.getElementById('sizeCollapsedInput').value || window.__sizeCollapsed || 60))));
          await window.lowbarAPI.configSet(scope, 'sizeExpanded', Math.max(120, Math.min(480, Number(document.getElementById('sizeExpandedInput').value || window.__sizeExpanded || 240))));
          const centerSaved = Math.max(32, Math.min(160, Number(document.getElementById('centerSizeInput').value || window.__centerSize || 50)));
          window.__centerSize = centerSaved;
          window.__sizeCollapsed = Math.max(40, Math.min(240, centerSaved + 10));
          await window.lowbarAPI.configSet(scope, 'centerSize', window.__centerSize);
          await window.lowbarAPI.configSet(scope, 'centerIcon', String(document.getElementById('centerIconInput').value || window.__centerIcon || 'ri-compass-3-line'));
          await window.lowbarAPI.emitEvent(scope, { type: 'buttons.update', buttons: items, theme, sizeCollapsed: window.__sizeCollapsed, sizeExpanded: window.__sizeExpanded, centerSize: window.__centerSize, centerIcon: window.__centerIcon });
        } catch {}
      };
      function placePreview(){
        try { const rootEl = document.getElementById('pvRoot'); const ring = document.getElementById('pvRing'); ring.innerHTML=''; const sectors = document.getElementById('pvSectors'); sectors.innerHTML=''; } catch {}
        const rootEl = document.getElementById('pvRoot'); const ring = document.getElementById('pvRing'); const sectors = document.getElementById('pvSectors');
        const W = Math.max(200, Math.floor(rootEl.getBoundingClientRect().width || 240));
        const H = Math.max(200, Math.floor(rootEl.getBoundingClientRect().height || 240));
        const cx = Math.floor(W/2), cy = Math.floor(H/2);
        let R = Math.min(cx, cy) - 24; if (R < 22) R = 22;
        const N = items.length;
        try { const pv = document.getElementById('preview'); pv.classList.toggle('classic', theme==='classic'); pv.classList.toggle('sector', theme==='sector'); } catch {}
        if (theme === 'sector' && N > 0) {
          const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
          svg.setAttribute('width','100%');
          svg.setAttribute('height','100%');
          svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
          const ro = Math.min(R + 14, Math.min(cx, cy) - 10);
          const centerR = 25;
          const ri = Math.max(centerR + 4, Math.round(R * 0.5));
          for (let i = 0; i < N; i++) {
            const a1 = (Math.PI * 2) * (i / N);
            const a2 = (Math.PI * 2) * ((i + 1) / N);
            const o1x = Math.round(cx + ro * Math.cos(a1));
            const o1y = Math.round(cy + ro * Math.sin(a1));
            const o2x = Math.round(cx + ro * Math.cos(a2));
            const o2y = Math.round(cy + ro * Math.sin(a2));
            const i2x = Math.round(cx + ri * Math.cos(a2));
            const i2y = Math.round(cy + ri * Math.sin(a2));
            const i1x = Math.round(cx + ri * Math.cos(a1));
            const i1y = Math.round(cy + ri * Math.sin(a1));
            const largeArc = ((a2 - a1) % (Math.PI*2)) > Math.PI ? 1 : 0;
            const path = document.createElementNS('http://www.w3.org/2000/svg','path');
            const d = `M ${o1x} ${o1y} A ${ro} ${ro} 0 ${largeArc} 1 ${o2x} ${o2y} L ${i2x} ${i2y} A ${ri} ${ri} 0 ${largeArc} 0 ${i1x} ${i1y} Z`;
            path.setAttribute('d', d);
            path.setAttribute('fill','rgba(64,128,255,0.18)');
            path.setAttribute('stroke','rgba(64,128,255,0.32)');
            path.setAttribute('stroke-width','1');
            path.style.opacity = (typeof window.__selectedIndex==='number' && window.__selectedIndex===i) ? '1' : '0';
            path.setAttribute('class','wedge');
            svg.appendChild(path);
          }
          sectors.appendChild(svg);
        }
        for (let i=0;i<N;i++){
          const it = items[i];
          const a = (Math.PI * 2) * ((i + 0.5) / Math.max(N, 1));
          const centerR = 25;
          const ro2 = Math.min(R + 14, Math.min(cx, cy) - 10);
          const ri2 = Math.max(centerR + 4, Math.round(R * 0.5));
          const RB = Math.round((ro2 + ri2) / 2);
          let x = Math.round(cx + RB * Math.cos(a));
          let y = Math.round(cy + RB * Math.sin(a));
          const div = document.createElement('div');
          div.className = 'item';
          div.style.position = 'absolute';
          const halfW = (theme === 'classic') ? 28 : 22;
          const halfH = 29;
          x = Math.max(halfW, Math.min(W - halfW, x));
          y = Math.max(halfH+1, Math.min(H - (halfH+1), y));
          div.style.left = (x - halfW) + 'px';
          div.style.top = (y - halfH) + 'px';
          const labelText = String(it.label || '').trim();
          if (theme === 'classic') { div.innerHTML = `<div class="dot"><i class="${it.icon || 'ri-circle-line'}"></i><div class="label">${labelText}</div></div>`; }
          else { div.innerHTML = `<i class="${it.icon || 'ri-circle-line'}"></i><div class="label">${labelText}</div>`; }
          div.title = it.label || '';
          if (typeof window.__selectedIndex==='number' && window.__selectedIndex===i && theme==='classic') { div.classList.add('active'); }
          div.onclick = () => { window.__selectedIndex = i; render(); placePreview(); };
          ring.appendChild(div);
        }
        const center = document.getElementById('pvCenter');
        try {
          center.style.width = (window.__centerSize || 50) + 'px';
          center.style.height = (window.__centerSize || 50) + 'px';
          const icon = center.querySelector('i');
          icon.className = String(window.__centerIcon || 'ri-compass-3-line');
          icon.style.fontSize = Math.round((window.__centerSize || 50) * 0.44) + 'px';
        } catch {}
        try { center.onclick = () => {}; } catch {}
      }
      function renderActionFields(it, box){
        box.innerHTML = '';
        const type = it.actionType || 'plugin';
        if (type === 'plugin'){
          const pidSel = document.createElement('select'); pidSel.className = 'sel';
          const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='选择插件'; pidSel.appendChild(emptyOpt);
          plugins.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name || p.id; pidSel.appendChild(opt); });
          pidSel.value = (it.actionPayload && it.actionPayload.pluginId) || '';
          const actSel = document.createElement('select'); actSel.className = 'sel';
          const emptyAct = document.createElement('option'); emptyAct.value=''; emptyAct.textContent='选择动作(函数)'; actSel.appendChild(emptyAct);
          const argsList = document.createElement('div'); argsList.className='arg-list';
          const addArg = document.createElement('button'); addArg.className='btn'; addArg.innerHTML = '<i class="ri-add-line"></i><span>添加参数</span>';
          const syncAll = () => { const args = Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload = { pluginId: pidSel.value.trim(), fn: actSel.value.trim(), args }; };
          const buildArgs = () => {
            argsList.innerHTML = '';
            const src = Array.isArray(it.actionPayload?.args)? it.actionPayload.args : [];
            src.forEach((val, index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); });
          };
          addArg.onclick = () => { const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); };
          const updateActions = () => {
            actSel.innerHTML = ''; const emptyAct2=document.createElement('option'); emptyAct2.value=''; emptyAct2.textContent='选择动作(函数)'; actSel.appendChild(emptyAct2);
            const pid = pidSel.value.trim(); const info = pluginMap[pid]; const acts = Array.isArray(info?.actions)? info.actions : [];
            acts.forEach(a=>{ const opt=document.createElement('option'); opt.value = a.target || a.id || ''; opt.textContent = a.text || a.id || (a.target||''); actSel.appendChild(opt); });
            // 若原有 fn 不在列表，保留为选中项
            const currentFn = (it.actionPayload && it.actionPayload.fn) || '';
            if (currentFn && !Array.from(actSel.options).some(o=>o.value===currentFn)){
              const opt=document.createElement('option'); opt.value=currentFn; opt.textContent=currentFn+' (自定义)'; actSel.appendChild(opt);
            }
            actSel.value = currentFn || '';
          };
          pidSel.onchange = () => { updateActions(); syncAll(); };
          actSel.onchange = () => { syncAll(); };
          updateActions();
          buildArgs();
          box.appendChild(pidSel); box.appendChild(actSel); box.appendChild(argsList); box.appendChild(addArg);
          syncAll();
        } else if (type === 'pluginEvent'){
          const pidSel = document.createElement('select'); pidSel.className = 'sel';
          const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='选择插件'; pidSel.appendChild(emptyOpt);
          plugins.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name || p.id; pidSel.appendChild(opt); });
          pidSel.value = (it.actionPayload && it.actionPayload.pluginId) || '';
          const evtSel = document.createElement('select'); evtSel.className = 'sel';
          const emptyEvt = document.createElement('option'); emptyEvt.value=''; emptyEvt.textContent='选择事件'; evtSel.appendChild(emptyEvt);
          const argsList = document.createElement('div'); argsList.className='arg-list';
          const addArg = document.createElement('button'); addArg.className='btn'; addArg.innerHTML = '<i class="ri-add-line"></i><span>添加参数</span>';
          const syncAll = () => { const args = Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload = { pluginId: pidSel.value.trim(), event: evtSel.value.trim(), args }; };
          const buildArgs = () => { argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)? it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); }); };
          addArg.onclick = () => { const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); };
          const updateEvents = async () => {
            evtSel.innerHTML = ''; const emptyEvt2=document.createElement('option'); emptyEvt2.value=''; emptyEvt2.textContent='选择事件'; evtSel.appendChild(emptyEvt2);
            const pid = pidSel.value.trim();
            try { const res = await window.lowbarAPI.pluginCall('screen.compass','listAutomationEvents',[pid]); const payload = (res && res.result) ? res.result : res; const events = Array.isArray(payload)? payload : []; events.forEach(e=>{ const opt=document.createElement('option'); opt.value=e.id || e.name; opt.textContent=e.name || e.id; evtSel.appendChild(opt); }); } catch {}
            const currentEvt = (it.actionPayload && it.actionPayload.event) || '';
            if (currentEvt && !Array.from(evtSel.options).some(o=>o.value===currentEvt)){
              const opt=document.createElement('option'); opt.value=currentEvt; opt.textContent=currentEvt+' (自定义)'; evtSel.appendChild(opt);
            }
            evtSel.value = currentEvt || '';
          };
          pidSel.onchange = () => { updateEvents(); syncAll(); };
          evtSel.onchange = () => { syncAll(); };
          buildArgs();
          box.appendChild(pidSel); box.appendChild(evtSel); box.appendChild(argsList); box.appendChild(addArg);
          updateEvents(); syncAll();
        } else if (type === 'openApp'){
          const p = document.createElement('input'); p.placeholder='程序路径'; p.value = (it.actionPayload && it.actionPayload.path) || '';
          const argsList = document.createElement('div'); argsList.className='arg-list';
          const addArg = document.createElement('button'); addArg.className='btn'; addArg.innerHTML = '<i class="ri-add-line"></i><span>添加参数</span>';
          const sync = () => { const args = Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload = { path: p.value.trim(), args }; };
          const buildArgs = () => { argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)? it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); sync(); }; inp.onchange=sync; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); }); };
          addArg.onclick = () => { const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); sync(); }; inp.onchange=sync; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); };
          box.appendChild(p); box.appendChild(argsList); box.appendChild(addArg);
          p.onchange=sync; buildArgs(); sync();
        } else if (type === 'cmd'){
          const c = document.createElement('input'); c.placeholder='命令'; c.value = (it.actionPayload && it.actionPayload.cmd) || '';
          box.appendChild(c);
          const sync = () => { it.actionPayload = { cmd: c.value }; };
          c.onchange=sync;
        } else if (type === 'power'){
          const opSel = document.createElement('select'); opSel.className = 'sel';
          ['shutdown','restart','logoff'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; opSel.appendChild(opt); });
          opSel.value = (it.actionPayload && it.actionPayload.op) || 'shutdown';
          const sync = () => { it.actionPayload = { op: opSel.value }; };
          opSel.onchange = sync;
          box.appendChild(opSel);
        } else if (type === 'wait'){
          const sec = document.createElement('input'); sec.placeholder='秒数'; sec.value = (it.actionPayload && (it.actionPayload.seconds || it.actionPayload.sec || it.actionPayload.ms)) || '';
          const sync = () => { it.actionPayload = { seconds: Number(sec.value) || 0 }; };
          sec.onchange = sync; box.appendChild(sec);
        }
      }

      function openIconPicker(targetInput){
        const overlay = document.createElement('div');
        overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(6,12,24,0.6)'; overlay.style.backdropFilter='blur(6px)'; overlay.style.zIndex='9999'; overlay.style.padding='12px';
        const panel = document.createElement('div'); panel.style.maxHeight='80vh'; panel.style.overflow='auto'; panel.style.border='1px solid rgba(255,255,255,0.2)'; panel.style.borderRadius='8px'; panel.style.background='rgba(16,24,36,0.8)'; panel.style.padding='12px';
        const close = document.createElement('div'); close.style.textAlign='right'; close.innerHTML='<button class="btn"><i class="ri-close-line"></i><span>关闭</span></button>';
        const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill, 120px)'; grid.style.gap='8px';
        const allIcons = Array.from(new Set([...(pluginIcons||[]), ...remixShort]));
        allIcons.forEach(ic => { const cell=document.createElement('div'); cell.style.display='flex'; cell.style.alignItems='center'; cell.style.gap='8px'; cell.style.cursor='pointer'; cell.style.padding='6px'; cell.style.border='1px solid rgba(255,255,255,0.12)'; cell.style.borderRadius='6px'; cell.innerHTML = `<i class="${ic}"></i><span style="color:#e6f0ff;font-size:12px;">${ic}</span>`; cell.onclick=()=>{ try { targetInput.value = ic; targetInput.dispatchEvent(new Event('change')); } catch {} document.body.removeChild(overlay); }; grid.appendChild(cell); });
        panel.appendChild(close); panel.appendChild(grid);
        overlay.appendChild(panel);
        document.body.appendChild(overlay);
        close.onclick = () => { try { document.body.removeChild(overlay); } catch {} };
      }

      (async function init(){
        await ensureDefaults();
        await load();
        try {
          const sc = document.getElementById('sizeCollapsedInput'); sc.value = String(window.__sizeCollapsed || 60);
          const se = document.getElementById('sizeExpandedInput'); se.value = String(window.__sizeExpanded || 240);
          const cs = document.getElementById('centerSizeInput'); cs.value = String(window.__centerSize || 50);
          const ci = document.getElementById('centerIconInput'); ci.value = String(window.__centerIcon || 'ri-compass-3-line');
          document.getElementById('pickCenterIcon').onclick = () => openIconPicker(ci);
          sc.onchange = () => {
            window.__sizeCollapsed = Math.max(40, Math.min(240, Number(sc.value)||60));
            window.__centerSize = Math.max(32, Math.min(160, window.__sizeCollapsed - 10));
            cs.value = String(window.__centerSize);
            placePreview();
          };
          se.onchange = () => { window.__sizeExpanded = Math.max(120, Math.min(480, Number(se.value)||240)); placePreview(); };
          cs.onchange = () => {
            window.__centerSize = Math.max(32, Math.min(160, Number(cs.value)||50));
            window.__sizeCollapsed = Math.max(40, Math.min(240, window.__centerSize + 10));
            sc.value = String(window.__sizeCollapsed);
            placePreview();
          };
          ci.onchange = () => { window.__centerIcon = String(ci.value || 'ri-compass-3-line'); placePreview(); };
        } catch {}
        try {
          let list = [];
          try {
            const res = await window.lowbarAPI.pluginCall('screen.compass','listPlugins',[]);
            list = (res && res.result) ? res.result : res;
          } catch {}
          if (!Array.isArray(list) || !list.length) {
            try { const p = await window.lowbarAPI.getPlugins?.(); list = (p && p.result) ? p.result : p; } catch {}
          }
          plugins = Array.isArray(list) ? list : [];
          pluginMap = {};
          plugins.forEach(p => { pluginMap[p.id] = p; });
          pluginIcons = plugins.map(p => String(p.icon || '').trim()).filter(Boolean);
        } catch { pluginIcons = []; plugins = []; pluginMap = {}; }
        render(); placePreview();
        try { const t = await window.lowbarAPI.configGet(scope, 'theme'); const v = (t && t.result) ? t.result : t; theme = (v === 'sector') ? 'sector' : 'classic'; updateThemeSeg(); } catch { theme='classic'; updateThemeSeg(); }
        placePreview();
      })();
    </script>
  </body>
  </html>
