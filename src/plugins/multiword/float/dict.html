<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>在线词典</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>

    
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #121212;
      color: #e6e6e6;
    }

    .wrap {
      padding: 12px;
    }

    input,
    button {
      background: #1b1b1b;
      color: #e6e6e6;
      border: 1px solid #2c2c2c;
      border-radius: 8px;
      padding: 6px 10px;
    }

    /* 取消输入框选中时的黄色/高亮边线 */
    input:focus,
    input:focus-visible,
    textarea:focus,
    button:focus {
      outline: none;
      box-shadow: none;
      border-color: #2c2c2c;
    }

    .sugg-item:focus {
      outline: none;
    }

    /* 处理 WebKit 自动填充的黄色背景 */
    input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0px 1000px #1b1b1b inset;
      -webkit-text-fill-color: #e6e6e6;
      caret-color: #e6e6e6;
    }

    /* 美化纵向滚动条 */
    * {
      scrollbar-width: thin;
      scrollbar-color: #444 #1a1a1a;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 8px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #3b3b3b, #555);
      border-radius: 8px;
      border: 1px solid #2c2c2c;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #4a4a4a, #666);
    }

    .sugg-box {
      position: relative;
      max-width: 420px;
      margin-right: 18px;
    }

    .sugg-list {
      position: absolute;
      top: 100%;
      left: 0;
      background: #1b1b1b;
      border: 1px solid #2c2c2c;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 180px;
      overflow: auto;
      z-index: 5;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
      display: none;
    }

    .sugg-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 10px;
      border: none;
      background: transparent;
      color: #e6e6e6;
    }

    .sugg-item:hover {
      background: #262626;
    }

    .result {
      margin-top: 10px;
      background: #1f1f1f;
      border: 1px solid #2c2c2c;
      border-radius: 10px;
      padding: 12px;
    }

    .result h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #fafafa;
    }

    .pos-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pos-chip {
      display: inline-flex;
      gap: 6px;
      padding: 4px 8px;
      background: #1b1b1b;
      border: 1px solid #2c2c2c;
      border-radius: 999px;
    }

    .muted {
      opacity: .85;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    a.audio {
      color: #9bd;
      text-decoration: none;
    }

    .audio-btn {
      background: #243a4a;
      border-color: #2f4d61;
      color: #d8ecff;
    }

    .audio-btn:hover {
      background: #2b4657;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .tabbar {
      display: flex;
      gap: 8px;
      margin: 0;
      align-items: center;
    }

    .tab {
      padding: 4px 10px;
      border-radius: 999px;
      background: #1b1b1b;
      border: 1px solid #2c2c2c;
      cursor: pointer;
      min-height: 32px;
      display: flex;
      align-items: center;
    }

    .tab:hover {
      background: #242424;
    }

    .ai-card h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #fafafa;
    }

    .ai-text {
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .result.ai-card {
      max-height: none;
    }

    .topbar { position: sticky; top: 0; z-index: 20; background: #121212; padding: 8px 0; border-bottom: 1px solid #2c2c2c; box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
    /* 全屏底栏模式：将顶栏改为底栏，避免与外层底栏冲突 */
    body.bar-bottom .topbar { position: fixed; top: auto; bottom: 0; left: 0; right: 0; border-bottom: none; border-top: 1px solid #2c2c2c; box-shadow: 0 -6px 12px rgba(0,0,0,0.12); }
    body.bar-bottom .wrap { padding-bottom: 62px; } /* 为底栏留出空间 */
    /* 自动补全框：在底栏模式下默认尝试上翻，避免被底部遮挡 */
    .sugg-list.above { top: auto; bottom: 100%; margin-top: 0; margin-bottom: 4px; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.35); }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="row topbar">
      <div class="sugg-box">
        <div style="position:relative; display:flex; align-items:center; gap:6px;">
          <input id="wd" placeholder="输入英文单词，如 heat" style="width:100%;" />
          <button id="suggClose" class="icon-btn" title="收起补全" aria-label="收起补全" style="flex:0 0 auto;"><i class="ri-arrow-up-s-line"></i></button>
        </div>
        <div id="suggestions" class="sugg-list"></div>
      </div>
      <button id="query"><i class="ri-search-line"></i> 查询</button>
      <span style="flex:1"></span>
      <div class="tabbar">
        <button class="tab" id="jumpCore"><i class="ri-book-2-line"></i> 核心解释</button>
        <button class="tab" id="jumpAI"><i class="ri-sparkling-2-line"></i> AI解词</button>
        <button class="tab" id="zoomBtn"><i class="ri-zoom-in-line"></i> 放大显示</button>
        <button class="tab" id="closeDictLocal" style="display:none"><i class="ri-close-circle-line"></i> 关闭词典</button>
      </div>
    </div>
    <div class="result" id="res">
      <div id="coreBox" class="core-box">
        结果将显示在此。
      </div>
    </div>
    <div class="result ai-card" id="aiBox" style="margin-top:12px; display:none;">
      <h3><i class="ri-sparkling-2-line"></i> AI解读（仅供参考）</h3>
      <div id="aiText" class="ai-text muted">尚未加载</div>
    </div>
  </div>
  <script>
    const api = () => window.lowbarAPI;
    const resEl = document.getElementById('res');
    const LOWBAR_CHANNEL = 'multiword.lowbar';
    let lastWord = '';
    function debounce(fn, wait) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; }
    function applyFontSizeFromQuery() {
      try {
        const q = new URLSearchParams(window.location.search || '');
        const fs = q.get('fontsize');
        const n = fs != null ? parseInt(fs, 10) : null;
        const size = (!Number.isNaN(n) && n > 0) ? n : (q.get('zoom') ? 18 : null);
        if (size) { document.body.style.fontSize = size + 'px'; }
      } catch {}
    }
    async function fetchSuggest(prefix) {
      const box = document.getElementById('suggestions');
      if (window.__suggCollapsed__) { box.style.display = 'none'; box.innerHTML = ''; return; }
      if (!prefix || /\s/.test(prefix)) { box.style.display = 'none'; box.innerHTML = ''; return; }
      try {
        const r = await fetch('https://api.datamuse.com/words?sp=' + encodeURIComponent(prefix) + '*');
        const list = await r.json();
        let top = (Array.isArray(list) ? list : []).slice(0, 8);
        // 若接口未返回，或不包含当前词干，添加本词作为兜底建议
        const hasSelf = top.some(x => String(x.word || '').toLowerCase() === String(prefix).toLowerCase());
        if (!hasSelf) top = [{ word: prefix }, ...top].slice(0, 8);
        box.innerHTML = top.map(x => `<button class="sugg-item" data-w="${x.word}">${x.word}</button>`).join('');
        box.style.display = 'block';
        // 展开时立即评估是否需要上翻（底栏模式或底部空间不足）
        try {
          const input = document.getElementById('wd');
          const rect = input.getBoundingClientRect();
          const spaceBelow = (window.innerHeight || 800) - rect.bottom;
          const needAbove = spaceBelow < 200 || document.body.classList.contains('bar-bottom');
          box.classList.toggle('above', !!needAbove);
        } catch {}
      } catch {
        // 接口不可用时也展示当前词作为兜底建议
        box.innerHTML = `<button class=\"sugg-item\" data-w=\"${prefix}\">${prefix}</button>`;
        box.style.display = 'block';
        // 兜底也评估上翻
        try {
          const input = document.getElementById('wd');
          const rect = input.getBoundingClientRect();
          const spaceBelow = (window.innerHeight || 800) - rect.bottom;
          const needAbove = spaceBelow < 200 || document.body.classList.contains('bar-bottom');
          box.classList.toggle('above', !!needAbove);
        } catch {}
      }
    }
    function normTranslations(src) {
      const arr = [];
      try {
        if (Array.isArray(src?.translations)) {
          for (const it of src.translations) arr.push({ pos: it.pos || '', cn: it.tran_cn || it.cn || it.translation || '' });
        } else if (Array.isArray(src?.data?.translations)) {
          for (const it of src.data.translations) arr.push({ pos: it.pos || '', cn: it.tran_cn || it.cn || it.translation || '' });
        } else if (Array.isArray(src?.result)) {
          for (const it of src.result) arr.push({ pos: it.pos || '', cn: it.cn || it.translation || it.text || '' });
        } else if (Array.isArray(src?.data)) {
          for (const it of src.data) arr.push({ pos: it.pos || '', cn: it.cn || it.translation || it.text || '' });
        }
      } catch { }
      return arr.filter(x => x.cn);
    }
    function renderDict(remote, local) {
      const data = (local && local.data) ? local.data : (remote && remote.data ? remote.data : remote);
      if (!data) return '<div class="muted">未获取到词典数据</div>';
      const word = data.word || '';
      const ukp = data.ukphone || '', usp = data.usphone || '';
      const uks = data.ukspeech || '', uss = data.usspeech || '';
      const trans = normTranslations({ data, translations: data.translations });
      const phrases = Array.isArray(data.phrases) ? data.phrases : [];
      const relWords = Array.isArray(data.relWords) ? data.relWords : [];
      const sentences = Array.isArray(data.sentences) ? data.sentences : [];
      const synonyms = Array.isArray(data.synonyms) ? data.synonyms : [];
      const partsHtml = trans.length ? `<div class="pos-list">${trans.map(t => `<span class="pos-chip">${t.pos ? (t.pos + '.') : ''} ${t.cn}</span>`).join('')}</div>` : '<div class="muted">无释义</div>';
      const phrHtml = phrases.length ? (`<ul>${phrases.map(p => `<li>${p.p_content} — ${p.p_cn}</li>`).join('')}</ul>`) : '<div class="muted">无短语</div>';
      const relHtml = relWords.length ? (`<ul>${relWords.map(g => `<li><b>${g.Pos || ''}</b>：${(Array.isArray(g.Hwds) ? g.Hwds : []).map(h => `${h.hwd}${h.tran ? (' — ' + h.tran) : ''}`).join('；')}</li>`).join('')}</ul>`) : '<div class="muted">无同根词</div>';
      const senHtml = sentences.length ? (`<ul>${sentences.map(s => `<li>${s.s_content} — ${s.s_cn}</li>`).join('')}</ul>`) : '<div class="muted">无例句</div>';
      const synHtml = synonyms.length ? (`<ul>${synonyms.map(sy => `<li><b>${sy.pos || ''}</b>：${sy.tran || ''}${Array.isArray(sy.Hwds) ? ('（' + sy.Hwds.map(h => h.word).join('，') + '）') : ''}</li>`).join('')}</ul>`) : '<div class="muted">无近义词</div>';
      const audioHtml = `<div class="row muted">英音 ${ukp} ${uks ? `<button class='audio-btn icon-btn' title='播放英音' aria-label='播放英音' data-audio-src='${uks}' data-voice='en-GB' data-word='${word}'><i class='ri-play-fill'></i></button>` : ''} ｜ 美音 ${usp} ${uss ? `<button class='audio-btn icon-btn' title='播放美音' aria-label='播放美音' data-audio-src='${uss}' data-voice='en-US' data-word='${word}'><i class='ri-play-fill'></i></button>` : ''}</div>`;
      return `
          <div class="grid2" id="core-section">
            <div>
              <h3><i class="ri-book-2-line"></i> 单词</h3>
              <div>${word || '（无）'}</div>
              ${audioHtml}
              <h3 style="margin-top:10px"><i class="ri-text" ></i> 释义</h3>
              ${partsHtml}
              <h3 style="margin-top:10px"><i class="ri-chat-check-line"></i> 短语</h3>
              ${phrHtml}
            </div>
            <div>
              <h3><i class="ri-shape-line"></i> 同根词</h3>
              ${relHtml}
              <h3 style="margin-top:10px"><i class="ri-double-quotes-l"></i> 例句</h3>
              ${senHtml}
              <h3 style="margin-top:10px"><i class="ri-contrast-2-line"></i> 近义词</h3>
              ${synHtml}
            </div>
          </div>
        `;
    }
    async function lookupFallback(word) {
      let local = null, remote = null;
      try { const r = await fetch('/renderer/a.json'); local = await r.json(); } catch { }
      try {
        const u = new URL('https://v2.xxapi.cn/api/englishwords');
        u.searchParams.set('word', word);
        const r = await fetch(u.toString()); remote = await r.json();
      } catch { }
      return { local, remote };
    }
    async function queryWord(w) {
      const word = String(w || '').trim();
      if (!word) return;
      lastWord = word;
      // 在核心解释容器中显示加载提示，避免清空顶部跳转标签
      const coreBoxLoading = document.getElementById('coreBox');
      if (coreBoxLoading) {
        coreBoxLoading.innerHTML = '查询中...';
      } else {
        // 兜底：旧结构或异常情况下，仍显示在结果容器
        resEl.innerHTML = '查询中...';
      }
      try {
        let r;
        if (window.lowbarAPI && typeof window.lowbarAPI.pluginCall === 'function') {
          r = await api().pluginCall('multi.word', 'dictLookup', [word]);
          // 兜底：当后端返回异常或无数据时，回退到前端本地+远端尝试
          const bad = !r || (r.ok === false) || (!r.remote && !r.local);
          if (bad) r = await lookupFallback(word);
        } else {
          r = await lookupFallback(word);
        }
        // 渲染核心解释到 coreBox 内，并保留顶部跳转标签
        const coreBox = document.getElementById('coreBox');
        if (coreBox) coreBox.innerHTML = renderDict(r.remote, r.local);
        else resEl.innerHTML = renderDict(r.remote, r.local);
        bindAudioControls();
        bindJumpTabs();
        queryAI(word);
      } catch (e) {
        const coreBox = document.getElementById('coreBox');
        const msg = '查询失败：' + (e?.message || e);
        if (coreBox) coreBox.textContent = msg; else resEl.textContent = msg;
      }
    }
      let lastAiWord = '';
      let lastAiAt = 0;
      async function queryAI(word) {
        const box = document.getElementById('aiBox');
        const textEl = document.getElementById('aiText');
        if (!box || !textEl) return;
        // 去重：短时间内重复同一词的请求直接忽略
        if (String(word||'').trim().toLowerCase() === lastAiWord && (Date.now() - lastAiAt) < 1000) {
          return;
        }
        lastAiWord = String(word||'').trim().toLowerCase();
        lastAiAt = Date.now();
        try {
          box.style.display = '';
          textEl.textContent = 'AI解读加载中...';
          const u = new URL('https://api.limeasy.cn/ai/engword/');
          // 新接口按示例采用 word=0word 形式
          u.searchParams.set('word', String(word||'').trim());
          const resp = await fetch(u.toString());
          const html = await resp.text();
          textEl.innerHTML = sanitizeAIHtml((html || '').trim()) || '无内容';
        } catch (e) {
          textEl.textContent = 'AI解读加载失败';
        }
      }
      function sanitizeAIHtml(html) {
        try {
          let out = String(html||'');
          // 移除潜在的脚本与样式标签
          out = out.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                   .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
          // 移除内联事件处理与潜在可执行标签
          out = out.replace(/\son\w+="[^"]*"/gi, '')
                   .replace(/\son\w+='[^']*'/gi, '')
                   .replace(/\son\w+=\s*[^\s>]+/gi, '')
                   .replace(/<\/?(iframe|object|embed|form|input|button)[^>]*>/gi, '');
          return out;
        } catch { return String(html||''); }
      }
    function sanitizeUrl(u) {
      const s = String(u || '').trim();
      if (!s) return '';
      if (s.startsWith('//')) return 'https:' + s;
      return s;
    }
    function pickVoice(lang) {
      try {
        const voices = window.speechSynthesis?.getVoices?.() || [];
        const preferred = voices.find(v => v.lang === lang) || voices.find(v => v.lang.startsWith(lang.split('-')[0]));
        return preferred || null;
      } catch { return null; }
    }
    async function speakText(text, lang) {
      try {
        if (!window.speechSynthesis) throw new Error('no_tts');
        const u = new SpeechSynthesisUtterance(text);
        const v = pickVoice(lang);
        if (v) u.voice = v;
        u.lang = lang;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch { }
    }
    async function playAudio(url, fallbackWord, lang) {
      const src = sanitizeUrl(url);
      if (!src) { await speakText(fallbackWord, lang); return; }
      try {
        const audio = new Audio(src);
        audio.crossOrigin = 'anonymous';
        audio.play().catch(async () => { await speakText(fallbackWord, lang); });
      } catch { await speakText(fallbackWord, lang); }
    }
    function bindAudioControls() {
      const buttons = resEl.querySelectorAll('.audio-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const src = btn.getAttribute('data-audio-src');
          const word = btn.getAttribute('data-word') || '';
          const lang = btn.getAttribute('data-voice') || 'en-US';
          await playAudio(src, word, lang);
        });
      });
    }
      function bindJumpTabs() {
        const btnCore = document.getElementById('jumpCore');
        const btnAI = document.getElementById('jumpAI');
        const scrollToAnchor = (el) => {
          if (!el) return;
          const topbar = document.querySelector('.topbar');
          const h = (topbar && topbar.offsetHeight) ? topbar.offsetHeight : 0;
          const rect = el.getBoundingClientRect();
          const targetY = rect.top + window.scrollY - h - 8; // 轻微上边距
          window.scrollTo({ top: targetY, behavior: 'smooth' });
        };
        if (btnCore) btnCore.onclick = () => {
          const coreSection = document.getElementById('core-section') || document.getElementById('coreBox') || document.getElementById('res');
          scrollToAnchor(coreSection);
        };
        if (btnAI) btnAI.onclick = () => {
          const ai = document.getElementById('aiBox');
          scrollToAnchor(ai);
        };
      }
    function openZoom(evt) {
      try {
        const w = (lastWord || document.getElementById('wd')?.value || '').trim();
        if (!w) { alert('请先输入并查询一个英文单词'); return; }
        const u = new URL(window.location.href);
        u.searchParams.set('zoom', '1');
        u.searchParams.set('word', w);
        // 默认字体增大到 18px，可根据需要调整
        u.searchParams.set('fontsize', (document.body.style.fontSize ? parseInt(document.body.style.fontSize) : 24));
        // 标记当前页为全屏底栏模式，便于内部布局适配
        u.searchParams.set('fullscreen', '1');
        if (api() && typeof api().emitEvent === 'function') {
          // 先关闭当前浮窗
          api().emitEvent(LOWBAR_CHANNEL, { type: 'update', target: 'floatingUrl', value: null });
          // Ctrl 路径：尝试直接调整窗口大小（像素值），用于验证直接尺寸控制
          if (evt && evt.ctrlKey) {
            const targetW = Math.min(Math.floor((window.innerWidth || 1200) * 0.88), 1400);
            const targetH = Math.min(Math.floor((window.innerHeight || 800) * 0.82), 900);
            api().emitEvent(LOWBAR_CHANNEL, { type: 'update', target: 'floatingBounds', value: { width: targetW, height: targetH } });
          } else {
            // 默认路径：请求渲染器进入最大化悬浮窗模式（取消 90% 与 1200px 限制）
            api().emitEvent(LOWBAR_CHANNEL, { type: 'update', target: 'floatingBounds', value: 'max' });
          }
          // 避免淡出动画与立即打开的竞争：延迟重开提升稳定性
          setTimeout(() => {
            try { api().emitEvent(LOWBAR_CHANNEL, { type: 'update', target: 'floatingUrl', value: u.href }); } catch {}
          }, 220);
        } else {
          // 预览态（无 lowbarAPI）直接在本页导航，避免弹窗被拦截
          window.location.href = u.href;
        }
      } catch {
        try {
          const u2 = new URL(window.location.href);
          window.location.href = u2.href;
        } catch {}
      }
    }
    const onInputSuggest = debounce((v) => fetchSuggest(v.toLowerCase()), 200);
    document.getElementById('wd').addEventListener('input', (ev) => { window.__suggCollapsed__ = false; const v = ev.target.value; onInputSuggest(v); });
    // 移除自动（blur）触发查询；改为显式触发（按钮或回车）
    document.getElementById('wd').addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') {
        const w = document.getElementById('wd').value.trim(); if (!w) return; queryWord(w.toLowerCase());
        const box = document.getElementById('suggestions'); box.style.display = 'none';
      }
    });
    document.getElementById('suggestions').addEventListener('click', (ev) => {
      const btn = ev.target.closest('.sugg-item'); if (!btn) return;
      const w = btn.getAttribute('data-w');
      document.getElementById('wd').value = w; document.getElementById('suggestions').style.display = 'none';
      lastWord = String(w||'').toLowerCase();
      queryWord(lastWord);
    });
    document.getElementById('suggClose').addEventListener('click', () => {
      try { window.__suggCollapsed__ = true; const box = document.getElementById('suggestions'); box.style.display = 'none'; box.innerHTML = ''; } catch {}
    });
    document.getElementById('query').addEventListener('click', async () => {
      const w = document.getElementById('wd').value.trim();
      if (!w) return alert('请输入英文单词');
      await queryWord(w);
    });
    document.getElementById('zoomBtn')?.addEventListener('click', (ev) => openZoom(ev));
    // 加载时读取查询参数：字体大小与初始单词
    (async function initFromQuery(){
      applyFontSizeFromQuery();
      try {
        const q = new URLSearchParams(window.location.search || '');
        const w = (q.get('word') || '').trim();
        // 全屏底栏模式：根据参数设置 body 类名以适配布局
        if (q.get('fullscreen') === '1') {
          document.body.classList.add('bar-bottom');
          // 在悬浮窗顶/底栏自身显示关闭按钮
          const btn = document.getElementById('closeDictLocal');
          if (btn) btn.style.display = '';
        }
        if (w) {
          document.getElementById('wd').value = w;
          lastWord = w.toLowerCase();
          queryWord(w.toLowerCase());
        }
      } catch {}
    })();
    // 悬浮窗本地关闭按钮：仅关闭当前浮窗，不改动整体底栏按钮
    document.getElementById('closeDictLocal')?.addEventListener('click', () => {
      try { api()?.emitEvent?.(LOWBAR_CHANNEL, { type:'update', target:'floatingUrl', value: null }); } catch {}
    });
    // 智能自动补全位置：若底部空间不足，自动改为向上展开
    window.addEventListener('resize', () => {
      const box = document.getElementById('suggestions');
      const input = document.getElementById('wd');
      if (!box || !input || box.style.display === 'none') return;
      try {
        const rect = input.getBoundingClientRect();
        const spaceBelow = (window.innerHeight || 800) - rect.bottom;
        const needAbove = spaceBelow < 200 || document.body.classList.contains('bar-bottom');
        box.classList.toggle('above', !!needAbove);
      } catch {}
    });
  </script>
</body>

</html>