const api=()=>window.lowbarAPI;const CH='multiword.lowbar';const qs=new URLSearchParams(window.location.search||'');const recentDays=parseInt(qs.get('days')||'7',10)||7;const wordSec=parseInt(qs.get('wordsec')||'2',10)||2;const cnSec=parseInt(qs.get('cnsec')||'1',10)||1;let wordFontSize=parseInt(qs.get('wordsize')||'34',10)||34;let cnFontSize=parseInt(qs.get('cnsize')||'24',10)||24;let pageSize=8;const previewMode=(qs.get('preview')||'')==='1';const selectedParam=String(qs.get('selected')||'').trim();const selectedList=selectedParam?selectedParam.split(',').map(x=>x.trim().toLowerCase()).filter(Boolean):[];const pageSec=(wordSec+cnSec);const gridEl=document.getElementById('grid');const timeLeftEl=document.getElementById('timeLeft');const pageInfoEl=document.getElementById('pageInfo');const stageEl=document.querySelector('.stage');const bottomSpacerEl=document.getElementById('bottomSpacer');const sepsEl=document.getElementById('pageSeps');let words=[];let pages=[];let pageIdx=0;let paused=false;let pageRemain=0;let showCn=(qs.get('showcn')||'1')!=='0';let anchorStart=0;let inRender=false;let pendingRerender=false;let resizeDebounce=null;let lastItemH=60;let lastRows=1;const ROW_GAP=16;const shufflePreview=(qs.get('shuffle')||'0')==='1';function totalPages(){try{const COLUMNS=4;const totalRows=Math.max(0,Math.ceil((words||[]).length/COLUMNS));return Math.max(1,Math.ceil(totalRows/Math.max(1,lastRows)));}catch{return 1}}function getPageHeight(){try{return Math.max(1,lastRows)*(Math.max(1,lastItemH)+ROW_GAP)-ROW_GAP}catch{return 400}}function getCurrentPageIndex(){try{const h=Math.max(1,getPageHeight());const base=(gridEl?.offsetTop||0);const pos=Math.max(0,(stageEl?.scrollTop||0)-base);const cur=Math.floor(pos/h);return Math.max(0,Math.min(totalPages()-1,cur))}catch{return pageIdx||0}}function computePageRemain(){try{const cur=getCurrentPageIndex();const start=cur*Math.max(1,pageSize);const len=Math.max(0,Math.min(Math.max(1,pageSize),(words||[]).length-start));return Math.max(0,len*pageSec)}catch{return pageSec}}function computePageRemainFor(idx){try{const cur=Math.max(0,Math.min(totalPages()-1,idx));const start=cur*Math.max(1,pageSize);const len=Math.max(0,Math.min(Math.max(1,pageSize),(words||[]).length-start));return Math.max(0,len*pageSec)}catch{return pageSec}}let serverBase='';function updateLowbarButtons(){try{const items=[{id:'carousel-prev',text:'上一页',icon:'ri-skip-back-line'},{id:'carousel-pause',text:(paused?'继续':'暂停'),icon:(paused?'ri-play-circle-line':'ri-pause-circle-line')},{id:'carousel-next',text:'下一页',icon:'ri-skip-forward-line'},{id:'carousel-toggle-cn',text:'中文开关',icon:'ri-translate'},{id:'open-carousel-settings',text:'轮播设置',icon:'ri-settings-3-line'},{id:'carousel-stop',text:'结束轮播',icon:'ri-stop-circle-line'}];if(previewMode)items.push({id:'check-start',text:'开始检查',icon:'ri-checkbox-line'});api().emitEvent(CH,{type:'update',target:'centerItems',value:items})}catch{}}function triggerWave(){try{const wave=document.createElement('div');wave.className='wave';document.body.appendChild(wave);wave.addEventListener('animationend',()=>{try{document.body.removeChild(wave)}catch{}})}catch{}}function applyFontSizes(){try{let style=document.getElementById('font-override');if(!style){style=document.createElement('style');style.id='font-override';document.head.appendChild(style)}style.textContent=`.word { font-size: ${wordFontSize}px !important; } .cn { font-size: ${cnFontSize}px !important; }`}catch{}}function calcPageSize(){try{const columns=4;const stageH=Math.max(200,(stageEl?.clientHeight||0));const temp=document.createElement('div');temp.className='item';temp.style.visibility='hidden';temp.style.position='absolute';temp.style.inset='auto';temp.innerHTML=`<div class="word">W</div><div class="cn" style="${showCn?'':'display:none'}">CN</div>`;gridEl.appendChild(temp);const itemHeight=Math.max(60,temp.offsetHeight||60);gridEl.removeChild(temp);const rowGap=16;const rows=Math.max(1,Math.floor((stageH+rowGap)/(itemHeight+rowGap)));lastItemH=itemHeight;lastRows=rows;return Math.max(columns,rows*columns)}catch{return 8}}function adjustPageSizeToFit(){try{const columns=4;const stageH=Math.max(200,(stageEl?.clientHeight||0));const items=Array.from(gridEl.querySelectorAll('.item'));if(!items.length)return;const itemHeight=Math.max(60,...items.map(el=>el.offsetHeight||0));const rowGap=16;const rows=Math.max(1,Math.floor((stageH+rowGap)/(itemHeight+rowGap)));lastItemH=itemHeight;lastRows=rows;const newSize=Math.max(columns,rows*columns);if(newSize!==pageSize){pageSize=newSize;pendingRerender=true;if(!inRender){requestAnimationFrame(()=>{pendingRerender=false;renderPage();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain)})}}}catch{}}async function fetchWords(){try{const r1=await api().pluginCall('multi.word','getWordbankUrl',[]);let base=String(r1?.url||'').trim();if(!base)base=String(qs.get('server')||'').trim();if(!base)base='http://localhost:6100';serverBase=base;const u=new URL('/words',base);const r=await fetch(u.href);const json=await r.json();const cutoff=Date.now()-recentDays*24*3600*1000;const raw=Array.isArray(json?.words)?json.words:[];if(selectedList.length){const byWord=new Map();for(const it of raw){const w=String(it.word||'').toLowerCase();if(!byWord.has(w))byWord.set(w,it)}const ordered=[];for(const w of selectedList){if(byWord.has(w))ordered.push(byWord.get(w))}words=ordered;if(shufflePreview){try{for(let i=words.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[words[i],words[j]]=[words[j],words[i]]}}catch{}}}else{words=raw.filter(x=>(x.createdAt||0)>=cutoff);words.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));if(shufflePreview){try{for(let i=words.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[words[i],words[j]]=[words[j],words[i]]}}catch{}}}pageSize=calcPageSize();anchorStart=0;pageIdx=0;pageRemain=computePageRemain();if(stageEl)stageEl.scrollTop=0;if(!words.length){gridEl.innerHTML='<div class="item"><div class="word">无符合时间条件的词汇</div></div>'}}catch(e){gridEl.innerHTML='<div class="item"><div class="word">加载失败 / 未连接词库</div><div class="cn">'+(e?.message||'请在“外部词库”页绑定，或通过 server 参数传入地址')+'</div></div>'}}function fmt(sec){sec=Math.max(0,Math.floor(sec));const m=Math.floor(sec/60),s=sec%60;return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}function renderPage(){inRender=true;const list=words||[];if(!list.length){gridEl.innerHTML='';inRender=false;return}gridEl.innerHTML=list.map(it=>{const cn=it.cn||(Array.isArray(it.translations)?it.translations.map(t=>t.cn).join('；'):'');const w=String(it.word||'');return `<div class="item" data-w="${w}"><div class="word">${w}</div><div class="cn" style="${showCn?'':'display:none'}">${cn}</div></div>`}).join('');Array.from(gridEl.querySelectorAll('.item')).forEach(el=>{el.addEventListener('click',()=>{const w=el.getAttribute('data-w')||'';try{api().pluginCall('multi.word','onLowbarEvent',[{type:'click',id:'dictWord',word:w}] )}catch{}})});adjustPageSizeToFit();renderSeparators();inRender=false;if(pendingRerender){requestAnimationFrame(()=>{pendingRerender=false;renderPage();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain);updatePageIndicator()})}else{updatePageIndicator()}}let indicatorLockIdx=null;let scrollEndTimer=null;function prevPage(){const h=Math.max(1,getPageHeight());const cur=getCurrentPageIndex();const idx=Math.max(0,cur-1);ensureScrollableToPage(idx);const target=(gridEl?.offsetTop||0)+idx*h;indicatorLockIdx=idx;if(stageEl)stageEl.scrollTo({top:target,behavior:'smooth'});setIndicator(idx+1);pageRemain=computePageRemainFor(idx);timeLeftEl.textContent=fmt(pageRemain);triggerWave();try{if(scrollEndTimer)clearTimeout(scrollEndTimer)}catch{}scrollEndTimer=setTimeout(()=>{indicatorLockIdx=null;updatePageIndicator();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain)},240)}function nextPage(){const h=Math.max(1,getPageHeight());const cur=getCurrentPageIndex();const idx=Math.min(totalPages()-1,cur+1);ensureScrollableToPage(idx);const target=(gridEl?.offsetTop||0)+idx*h;indicatorLockIdx=idx;if(stageEl)stageEl.scrollTo({top:target,behavior:'smooth'});setIndicator(idx+1);pageRemain=computePageRemainFor(idx);timeLeftEl.textContent=fmt(pageRemain);triggerWave();try{if(scrollEndTimer)clearTimeout(scrollEndTimer)}catch{}scrollEndTimer=setTimeout(()=>{indicatorLockIdx=null;updatePageIndicator();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain)},240)}let tickHandle=null;function startLoop(){if(tickHandle)clearInterval(tickHandle);renderPage();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain);tickHandle=setInterval(()=>{if(paused)return;pageRemain=Math.max(0,pageRemain-1);timeLeftEl.textContent=fmt(pageRemain);if(pageRemain<=0){const lastPage=(getCurrentPageIndex()>=totalPages()-1);if(lastPage){if(previewMode){try{if(tickHandle)clearInterval(tickHandle)}catch{}}else{anchorStart=0;pageIdx=0;if(stageEl)stageEl.scrollTop=0;ensureScrollableToPage(0);renderPage();updatePageIndicator();triggerWave();pageRemain=computePageRemain()}}else{nextPage();pageRemain=computePageRemain()}}},1000)}try{api().subscribe(CH);api().onEvent((name,payload)=>{if(name!==CH||!payload)return;if(payload.type==='control'&&payload.action==='carousel'){const cmd=String(payload.cmd||'');if(cmd==='prev')prevPage();else if(cmd==='next')nextPage();else if(cmd==='pause'){paused=!paused;updateLowbarButtons()}else if(cmd==='stop'){if(tickHandle)clearInterval(tickHandle)}else if(cmd==='settings'){try{const float=new URL('../../../plugins/multiword/float/carousel-font.html',window.location.href).href;const u=new URL(float);u.searchParams.set('server',String(serverBase||''));u.searchParams.set('wordsize',String(wordFontSize||''));u.searchParams.set('cnsize',String(cnFontSize||''));api().emitEvent(CH,{type:'update',target:'floatingBounds',value:{width:740,height:520}});api().emitEvent(CH,{type:'update',target:'floatingUrl',value:u.href})}catch{}}else if(cmd==='start-check'){const toUrl=(page,params={})=>{const base=new URL(page,window.location.href);Object.entries(params).forEach(([k,v])=>base.searchParams.set(k,String(v)));return base.href};const bg=new URL('../../../plugins/multiword/background/checker.html',window.location.href).href;const params={selected:selectedParam,server:serverBase};try{api().emitEvent(CH,{type:'update',target:'backgroundUrl',value:toUrl(bg,params)})}catch{}return}else if(cmd==='set-font'){const wf=parseInt(String(payload.wordsize||''),10);const cf=parseInt(String(payload.cnsize||''),10);if(Number.isFinite(wf)&&wf>0)wordFontSize=wf;if(Number.isFinite(cf)&&cf>0)cnFontSize=cf;applyFontSizes();requestAnimationFrame(()=>{const newSize=calcPageSize();if(newSize!==pageSize){pageSize=newSize}renderPage();updatePageIndicator();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain)});return}else if(cmd==='toggle-cn'){showCn=!showCn;const newSize=calcPageSize();if(newSize!==pageSize){pageSize=newSize}renderPage();updatePageIndicator();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain)}return}if(payload.type==='click'){const id=String(payload.id||'');if(id==='carousel-prev')prevPage();else if(id==='carousel-next')nextPage();else if(id==='carousel-pause')paused=!paused;else if(id==='carousel-stop'){if(tickHandle)clearInterval(tickHandle)}else if(id==='open-carousel-settings'||id==='carousel-settings'){try{const float=new URL('../../../plugins/multiword/float/carousel-font.html',window.location.href).href;const u=new URL(float);u.searchParams.set('server',String(serverBase||''));u.searchParams.set('wordsize',String(wordFontSize||''));u.searchParams.set('cnsize',String(cnFontSize||''));api().emitEvent(CH,{type:'update',target:'floatingBounds',value:{width:740,height:520}});api().emitEvent(CH,{type:'update',target:'floatingUrl',value:u.href})}catch{}}else if(id==='carousel-toggle-cn'){showCn=!showCn;const newSize=calcPageSize();if(newSize!==pageSize){pageSize=newSize}renderPage();updatePageIndicator();pageRemain=computePageRemain();timeLeftEl.textContent=fmt(pageRemain)}else if(id==='check-start'){const toUrl=(page,params={})=>{const base=new URL(page,window.location.href);Object.entries(params).forEach(([k,v])=>base.searchParams.set(k,String(v)));return base.href};const bg=new URL('../../../plugins/multiword/background/checker.html',window.location.href).href;const params={selected:selectedParam,server:serverBase};try{api().emitEvent(CH,{type:'update',target:'backgroundUrl',value:toUrl(bg,params)})}catch{}}}})}catch{}function updatePageIndicator(){try{if(pendingRerender)return;const totalWords=Math.max(0,(words||[]).length);if(!totalWords){pageInfoEl.textContent='--/--';return}const pageIdxNow=(indicatorLockIdx!=null)?indicatorLockIdx:getCurrentPageIndex();const startOrdinal=Math.max(1,Math.min(totalWords,pageIdxNow*Math.max(1,pageSize)+1));pageInfoEl.textContent=String(startOrdinal)+'/'+String(totalWords)}catch{}}function setIndicator(curPageNumber){try{const totalWords=Math.max(0,(words||[]).length);const pageNum=Math.max(1,curPageNumber);const startOrdinal=Math.max(1,Math.min(totalWords,(pageNum-1)*Math.max(1,pageSize)+1));pageInfoEl.textContent=String(startOrdinal)+'/'+String(totalWords)}catch{}}function renderSeparators(){try{const h=Math.max(1,getPageHeight());const total=totalPages();const base=(gridEl?.offsetTop||0);if(!sepsEl)return;sepsEl.innerHTML='';for(let i=1;i<total;i++){const line=document.createElement('div');line.className='sep-line';line.style.top=String(base+i*h-(ROW_GAP/2))+'px';sepsEl.appendChild(line)}}catch{}}try{window.addEventListener('resize',()=>{try{if(resizeDebounce)clearTimeout(resizeDebounce)}catch{}resizeDebounce=setTimeout(()=>{const newSize=calcPageSize();if(newSize!==pageSize&&Array.isArray(words)&&words.length){pageSize=newSize;ensureScrollableToPage(getCurrentPageIndex());renderPage();updatePageIndicator();triggerWave();renderSeparators()}},120)})}catch{}(async function init(){await fetchWords();applyFontSizes();startLoop()})();function ensureScrollableToPage(idx){try{const h=Math.max(1,getPageHeight());const base=(gridEl?.offsetTop||0);const target=base+Math.max(0,Math.min(totalPages()-1,idx))*h;const maxScroll=Math.max(0,(stageEl?.scrollHeight||0)-(stageEl?.clientHeight||0));const need=Math.max(0,target-maxScroll);if(bottomSpacerEl)bottomSpacerEl.style.height=need?(String(need)+'px'):'0px'}catch{}}
