<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>外部词库 · 全部展示</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <style>
      body { margin:0; font-family: system-ui, sans-serif; background:#121212; color:#e6e6e6; }
      .wrap { padding: 16px; }
      .toolbar { display:flex; align-items:center; gap:10px; margin-bottom: 10px; }
      .list { border:1px solid #2c2c2c; border-radius: 10px; }
      .row { display:grid; grid-template-columns: 1fr 2fr 140px; gap:10px; padding:8px 10px; border-bottom:1px solid #222; align-items:center; }
      .row:nth-child(odd){ background:#1a1a1a; }
      .row:hover { background:#232323; cursor: pointer; }
      .muted { opacity: .85; }
      select, button { background:#1b1b1b; color:#e6e6e6; border:1px solid #2c2c2c; border-radius:8px; padding:6px 10px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="toolbar">
        <label>排序：
          <select id="sort">
            <option value="time">按时间（新→旧）</option>
            <option value="alpha">按首字母（A→Z）</option>
          </select>
        </label>
        <button id="refresh"><i class="ri-refresh-line"></i> 刷新</button>
        <span class="muted">点击词条将通过在线词典悬浮窗展示</span>
      </div>
      <div class="list" id="list"></div>
    </div>
    <script>
      const api = () => window.lowbarAPI; const CH='multiword.lowbar';
      let all = []; let sortMode = 'time';
      function render(){
        try {
          const root = document.getElementById('list');
          const items = [...all];
          if (sortMode === 'time') items.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
          else items.sort((a,b)=>String(a.word||'').localeCompare(String(b.word||'')));
          const tz = 'Asia/Shanghai';
          const fmt = (ms) => {
            try {
              const d = new Date(ms||Date.now());
              const parts = new Intl.DateTimeFormat('zh-CN', { timeZone: tz, hour12: false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' }).formatToParts(d);
              const get = (t) => parts.find(p=>p.type===t)?.value || '';
              return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')}:${get('second')}`;
            } catch { return new Date(ms||Date.now()).toLocaleString(); }
          };
          root.innerHTML = items.map(it => `<div class='row' data-word='${it.word}'><div><b>${it.word||''}</b></div><div class='muted'>${it.cn || (Array.isArray(it.translations)? it.translations.map(t=>t.cn).join('；') : '')}</div><div class='muted'>${fmt(it.createdAt)}</div></div>`).join('');
          root.querySelectorAll('.row').forEach(r => {
            r.addEventListener('click', () => {
              const w = r.getAttribute('data-word');
              try { api().pluginCall('multi.word','onLowbarEvent',[{ type:'click', id:'dictWord', word:String(w||'') }]); } catch {}
            });
          });
        } catch {}
      }
      async function load(){
        try {
          const qs = new URLSearchParams(window.location.search||'');
          const r1 = await api().pluginCall('multi.word', 'getWordbankUrl', []);
          let base = String(r1?.url||'').trim();
          if (!base) base = String(qs.get('server')||'').trim();
          if (!base) base = 'http://localhost:6100';
          const u = new URL('/words', base);
          const r = await fetch(u.href); const json = await r.json();
          all = Array.isArray(json?.words) ? json.words : []; render();
        } catch (e) {
          document.getElementById('list').innerHTML = `<div class='row'><div>加载失败 / 未连接词库</div><div class='muted'>${e?.message||'请在“外部词库”页绑定，或通过 server 参数传入地址'}</div><div></div></div>`;
        }
      }
      document.getElementById('sort').addEventListener('change', (ev)=>{ sortMode = ev.target.value; render(); });
      document.getElementById('refresh').addEventListener('click', load);
      // 订阅底栏控制：切换排序或停止
      try {
        api().subscribe(CH);
        api().onEvent((name,payload)=>{
          if (name !== CH || !payload || payload.type !== 'control' || payload.action !== 'allwords') return;
          const cmd = String(payload.cmd||'');
          if (cmd === 'sort-time') { sortMode = 'time'; render(); }
          else if (cmd === 'sort-alpha') { sortMode = 'alpha'; render(); }
        });
      } catch {}
      (async function init(){ await load(); })();
    </script>
  </body>
  </html>