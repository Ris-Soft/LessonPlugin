<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>自动化演示</title>
  <link rel="stylesheet" href="../../renderer/remixicon-local.css" />
  <link rel="stylesheet" href="../../renderer/titlebar.css" />
  <link rel="stylesheet" href="../../renderer/settings.css" />
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const log = (msg) => { const el = document.getElementById('log'); const p = document.createElement('div'); p.textContent = msg; el.appendChild(p); };

      // 注册窗口内可调用函数（演示）
      window.pluginAPI?.onInvoke(async (fn, args) => {
        if (fn === 'echo') { return String(args?.[0] || ''); }
        throw new Error('未知函数: ' + fn);
      });

      // 订阅事件总线（演示）
      window.pluginAPI?.subscribe('demo.automation:event');
      window.pluginAPI?.onEvent((name, payload) => { log(`[事件] ${name}: ${JSON.stringify(payload)}`); });

      // 注册自动化事件（可选，主进程已通过导出自动注册）
      // window.pluginAPI?.registerAutomationEvents?.('demo.automation', [
      //   { id: 'notify', name: 'notify', desc: '系统通知（标题、内容）', params: [{ name: 'title', type: 'string' }, { name: 'body', type: 'string' }] },
      //   { id: 'logTime', name: 'logTime', desc: '将当前时间写入日志文件', params: [] }
      // ]);

      document.getElementById('btn-notify').addEventListener('click', async () => {
        await window.pluginAPI?.call('demo.automation', 'notify', ['测试通知', '来自 自动化演示 的消息']);
        log('已发送系统通知');
      });
      document.getElementById('btn-log').addEventListener('click', async () => {
        const p = await window.pluginAPI?.call('demo.automation', 'logTime', []);
        log('已写入日志: ' + (p || '未知路径'));
      });
      document.querySelectorAll('.win-btn').forEach((b) => {
        b.addEventListener('click', () => window.pluginAPI?.windowControl(b.dataset.act));
      });
    });
  </script>
</head>

<body>
  <div class="titlebar">
    <div class="drag">自动化演示</div>
    <div class="window-actions">
      <button class="win-btn" data-act="minimize" title="最小化"><i class="ri-subtract-line"></i></button>
      <button class="win-btn max" data-act="maximize" title="最大化"><i class="ri-checkbox-blank-line"></i></button>
      <button class="win-btn close" data-act="close" title="关闭"><i class="ri-close-line"></i></button>
    </div>
  </div>
  <div class="wrap">
    <div class="section">
      <div class="section-title"><i class="ri-robot-line"></i> 自动化演示</div>
      <div class="muted">这是一个支持自动化的示例插件。无需打开窗口也可通过自动化调用后端函数。</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn secondary" id="btn-notify"><i class="ri-notification-line"></i> 发送示例通知</button>
        <button class="btn secondary" id="btn-log"><i class="ri-time-line"></i> 写入当前时间到日志</button>
      </div>
    </div>
    <div class="section">
      <div class="section-title"><i class="ri-notification-3-line"></i> 通知插件示例触发</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn secondary" id="btnToastInfo">左上角通知（信息）</button>
        <button class="btn secondary" id="btnToastWarn">左上角通知（警告）</button>
        <button class="btn secondary" id="btnToastError">左上角通知（错误）</button>
        <button class="btn secondary" id="btnOverlayAuto">全屏遮罩（自动关闭）</button>
        <button class="btn secondary" id="btnOverlayClose">全屏遮罩（带关闭按钮与倒计时）</button>
        <button class="btn secondary" id="btnQueueDemo">队列示例</button>
        <button class="btn" id="btnOverlayText"><i class="ri-layout-top-2-line"></i> 纯文本遮罩</button>
        <button class="btn secondary" id="btnSoundIn"><i class="ri-volume-up-line"></i> 入场音效</button>
        <button class="btn secondary" id="btnSoundOut"><i class="ri-volume-down-line"></i> 退场音效</button>
        <!-- 暂时隐藏 EdgeTTS 测试入口 -->
      </div>
    </div>
    <div class="section">
      <div class="section-title"><i class="ri-file-list-3-line"></i> 日志</div>
      <div class="box" id="log"></div>
    </div>
  </div>
  <script>
    // 通过插件调用主进程函数，投递通知到运行窗口（避免 URL 打开错误）
    const sendNotify = async (payload) => {
      await window.pluginAPI?.call('notify.plugin', 'enqueue', [payload]);
    };

    document.getElementById('btnToastInfo').onclick = () => {
      sendNotify({ mode: 'toast', type: 'info', title: '信息通知', subText: '这是一个示例信息', duration: 2500, speak: true });
    };
    document.getElementById('btnToastWarn').onclick = () => {
      sendNotify({ mode: 'toast', type: 'warn', title: '警告通知', subText: '请注意处理', duration: 3000, speak: true });
    };
    document.getElementById('btnToastError').onclick = () => {
      sendNotify({ mode: 'toast', type: 'error', title: '错误通知', subText: '发生异常，请检查', duration: 3200, speak: true });
    };

    document.getElementById('btnOverlayAuto').onclick = () => {
      sendNotify({ mode: 'overlay', type: 'info', title: '全屏通知', subText: '将在 3 秒后自动关闭', autoClose: true, duration: 3000, speak: true });
    };
    document.getElementById('btnOverlayClose').onclick = () => {
      sendNotify({ mode: 'overlay', type: 'warn', title: '全屏通知', subText: '按钮 2 秒后可用', showClose: true, closeDelay: 2000, speak: true });
    };

    document.getElementById('btnQueueDemo').onclick = async () => {
      await window.pluginAPI?.call('notify.plugin', 'enqueueBatch', [[
        { mode: 'toast', type: 'info', title: '队列 1/3', subText: '信息', duration: 1500, speak: true },
        { mode: 'overlay', type: 'warn', title: '队列 2/3', subText: '2 秒后可关闭', showClose: true, closeDelay: 2000, speak: true },
        { mode: 'toast', type: 'error', title: '队列 3/3', subText: '错误', duration: 1800, speak: true },
      ]]);
    };

    // 新接口测试
    document.getElementById('btnOverlayText').onclick = async () => {
      await window.pluginAPI?.call('notify.plugin', 'overlayText', ['这是一条纯文本提示', 2500, 'fade']);
      log('已触发纯文本遮罩');
    };
    document.getElementById('btnSoundIn').onclick = async () => {
      await window.pluginAPI?.call('notify.plugin', 'playSound', ['in']);
      log('已播放入场音效');
    };
    document.getElementById('btnSoundOut').onclick = async () => {
      await window.pluginAPI?.call('notify.plugin', 'playSound', ['out']);
      log('已播放退场音效');
    };
    // 暂时隐藏 EdgeTTS 测试入口
  </script>
</body>

</html>