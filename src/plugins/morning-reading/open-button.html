<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>打开早读看板</title>
  <style>
    html,body{margin:0;background:transparent !important}
    .btn{display:inline-flex;align-items:center;height:56px;padding:0 16px;border:1px solid rgba(255,255,255,0.28);border-radius:999px;background:rgba(20,28,40,0.60);color:#e6f0ff;font-weight:600;cursor:pointer;font-size:14px;gap:8px}
    .btn i{font-size:18px}
  </style>
</head>
<body>
    <button class="btn" id="btn-open"><i class="ri-dashboard-2-line"></i> 打开早读看板</button>
  <script>
    window.pluginAPI?.ui.ensureStyles();
    const btn = document.getElementById('btn-open');
    let dragging = false; let sx=0, sy=0; let bx=0, by=0; let moved=false; let justDragged=false; let rafScheduled = false; let nextX = 0, nextY = 0;
    btn.addEventListener('click',async(e)=>{ if (dragging || moved || justDragged) return; try{ await window.pluginAPI?.call('morning.reading','openBoard',[]); window.pluginAPI?.windowControl('close'); }catch{} });
    const onDown = async (e)=>{
      try{
        dragging = true; moved=false; e.target.setPointerCapture?.(e.pointerId);
        const raw = await window.pluginAPI?.call('morning.reading','getOpenButtonBounds',[]);
        const b = (raw && raw.result) ? raw.result : raw;
        bx = (b && typeof b.x==='number') ? b.x : 0;
        by = (b && typeof b.y==='number') ? b.y : 0;
        sx = e.screenX; sy = e.screenY;
        await window.pluginAPI?.call('morning.reading','setOpenButtonDragging',[true]);
      }catch{}
    };
    const onMove = (e)=>{
      if(!dragging) return;
      const dx = e.screenX - sx; const dy = e.screenY - sy;
      if (Math.abs(dx) > 2 || Math.abs(dy) > 2) moved = true;
      nextX = Math.floor(bx + dx); nextY = Math.floor(by + dy);
      if (!rafScheduled) {
        rafScheduled = true;
        requestAnimationFrame(() => {
          rafScheduled = false;
          const x = nextX; const y = nextY;
          try { window.pluginAPI?.call('morning.reading','moveOpenButtonTo',[x,y]); } catch {}
        });
      }
    };
    const onUp = async (e)=>{
      try { btn.releasePointerCapture?.(e.pointerId); } catch {}
      dragging=false; if (moved) { justDragged = true; setTimeout(()=>{ justDragged=false; }, 200); }
      try{ await window.pluginAPI?.call('morning.reading','snapOpenButton',[]); await window.pluginAPI?.call('morning.reading','setOpenButtonDragging',[false]); }catch{}
      try { window.removeEventListener('pointermove', onMove); window.removeEventListener('pointerup', onUp); } catch {}
    };
    btn.addEventListener('pointerdown', (e)=>{ onDown(e); try { window.addEventListener('pointermove', onMove); window.addEventListener('pointerup', onUp, { once: true }); } catch {} });
  </script>
</body>
</html>
