<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>早读看板</title>
  <style>
    body{margin:0;background:#0b1520;color:#e6f1ff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{padding:16px;height:100vh;box-sizing:border-box}
    .grid{display:grid;grid-template-columns:1fr 42vw;gap:14px;height:calc(100vh - 80px)}
    .panel{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:24px;overflow:auto}
    .panel.left{display:flex;flex-direction:column;overflow:hidden}
    .time{font-size:clamp(56px,8vw,120px);line-height:1;font-weight:700}
    .date{font-size:2.2vw;margin-top:8px;opacity:.9}
    .meta{margin-top:10px;font-size:1.8vw;opacity:.9}
    .quote{font-size:clamp(22px,2.0vw,48px);line-height:1.6}
    .quote .from{margin-top:10px;font-size:14px;opacity:.8}
    .row{display:flex;gap:8px;align-items:center}
    .btn{padding:7px 12px;border:none;border-radius:8px;cursor:pointer}
    .btn.primary{background:#22c55e;color:#071a12}
    .btn.secondary{background:#334155;color:#e6f1ff}
    .muted{opacity:.7}
    .quote-card{margin-top:12px;padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.12)}
    .quote-card.general{background:rgba(34,197,94,0.10);border-left:4px solid #22c55e}
    .quote-card.specific.cn{background:rgba(245,158,11,0.10);border-left:4px solid #f59e0b}
    .quote-card.specific.en{background:rgba(96,165,250,0.10);border-left:4px solid #60a5fa}
    .quote-card .icon{font-size:28px;margin-right:8px}
    .quote-card .from{font-style:italic;margin-top:6px}
    .quote-card.general .from{color:#22c55e}
    .quote-card.specific.cn .from{color:#f59e0b}
    .quote-card.specific.en .from{color:#60a5fa}
    .poem-lines{margin-top:4px;white-space:pre-line;opacity:.92}
    .time-box{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:14px}
    .quote-card.poem-full{background:rgba(255,255,255,0.06);border-left:none}
    .annotate-box{margin-top:14px;flex:1;position:relative;overflow:hidden}
    #annotate-frame{width:100%;height:100%;display:block;border:none;border-radius:12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.12);background:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="panel left">
        <div class="time-box">
          <div class="time" id="t-time"></div>
          <div class="date" id="t-date"></div>
          <div class="meta" id="t-meta"></div>
        </div>
        <div style="position:fixed;left:24px;bottom:24px;">
          <button class="btn secondary" id="btn-exit"><i class="ri-logout-box-r-line"></i> 退出</button>
        </div>
        <div class="annotate-box">
          <iframe id="annotate-frame" src="../annotate-fabric/whiteboard.html?showClose=0&showMinimize=0&showSave=1&variant=overlay&persistKey=morning.reading.board"></iframe>
        </div>
      </div>
      <div class="panel right">
        <div class="row" style="justify-content:flex-end;">
          <button class="btn secondary" id="btn-refresh"><i class="ri-refresh-line"></i> 刷新</button>
        </div>
        <div class="quote-card general">
          <div class="row" style="gap:10px;align-items:center;">
            <i class="ri-star-line" style="font-size:28px;color:#22c55e;"></i>
            <div>
              <div class="quote" id="q-general"></div>
              <div class="quote from" id="q-general-from"></div>
            </div>
          </div>
        </div>
        <div class="quote-card specific cn" id="card-specific-cn" style="display:none;">
          <div class="row" style="gap:10px;align-items:center;">
            <i class="ri-book-2-line" style="font-size:28px;color:#f59e0b;"></i>
            <div>
              <div class="quote" id="q-specific"></div>
              <div class="quote from" id="q-specific-from"></div>
              <div class="quote from" id="q-specific-translate"></div>
            </div>
          </div>
        </div>
        <div class="quote-card poem-full" id="card-poem-full" style="display:none;">
          <div>
            <div class="poem-lines" id="q-poem-lines"></div>
          </div>
        </div>
        <div class="quote-card specific en" id="card-specific-en" style="display:none;">
          <div class="row" style="gap:10px;align-items:center;">
            <i class="ri-translate" style="font-size:28px;color:#60a5fa;"></i>
            <div>
              <div class="quote" id="q-specific-en"></div>
              <div class="quote from" id="q-specific-en-from"></div>
              <div class="quote from" id="q-specific-en-translate"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const $ = (s) => document.querySelector(s);
    window.pluginAPI?.ui.ensureStyles();
    $('#btn-exit').addEventListener('click',()=>window.pluginAPI?.windowControl('close'));
    async function tick(){
      const t = await window.pluginAPI?.getCurrentTime();
      const d = new Date(Number(t?.nowMs || Date.now()));
      let tz = 'Asia/Shanghai';
      try { const v = await window.pluginAPI?.configGet?.('system','timeZone'); if (v) tz = String(v); } catch {}
      let parts = null;
      try { parts = new Intl.DateTimeFormat('zh-CN', { timeZone: tz, hour12: false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', weekday:'long' }).formatToParts(d); } catch {}
      const get = (t) => parts ? (parts.find(p=>p.type===t)?.value || '') : null;
      const y = parts ? get('year') : String(d.getFullYear());
      const m = parts ? get('month') : String(d.getMonth()+1).padStart(2,'0');
      const day = parts ? get('day') : String(d.getDate()).padStart(2,'0');
      const hh = parts ? get('hour') : String(d.getHours()).padStart(2,'0');
      const mm = parts ? get('minute') : String(d.getMinutes()).padStart(2,'0');
      const ss = parts ? get('second') : String(d.getSeconds()).padStart(2,'0');
      const wk = parts ? get('weekday') : ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][d.getDay()];
      $('#t-time').textContent = `${hh}:${mm}:${ss}`;
      $('#t-date').textContent = `${y}-${m}-${day} ${wk}`;
      const days = Number(t?.daysFromBase || 0);
      const weekIdx = Math.floor(days/7)+1;
      let even = Math.floor(days/7)%2===0;
      const off = await window.pluginAPI?.configGet('system','biweekOffset');
      if (off) even = !even;
      const tag = even? '双周':'单周';
      $('#t-meta').textContent = `第${weekIdx}周 · ${tag} · 已开学${days}天`;
    }
    let timer = null;
    function startClock(){ if (timer) clearInterval(timer); tick(); timer = setInterval(tick, 500); }
    async function getActiveMode(){
      const cfg = await window.pluginAPI?.configGetAll('morning-reading');
      const list = Array.isArray(cfg?.boardPeriods)?cfg.boardPeriods:[];
      const now = new Date();
      const w = now.getDay()===0?7:now.getDay();
      const base = await window.pluginAPI?.configGet('system','semesterStart') || await window.pluginAPI?.configGet('system','offsetBaseDate');
      const off = await window.pluginAPI?.configGet('system','biweekOffset');
      let even = null;
      if (base){ try{ const bd = new Date(String(base)+'T00:00:00'); const diff = Math.floor((now-bd)/86400e3); const wi = Math.floor(diff/7); even = wi%2===0; if (off) even=!even; }catch{} }
      const match = (r)=>{ if(r==='any'||r==null) return true; if(even==null) return false; return r==='even'?even:!even; };
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const cur = `${hh}:${mm}`;
      for(const p of list){ if(p?.enabled===false) continue; const onW = Array.isArray(p?.weekdays)?p.weekdays.includes(w):true; const ok = match(p?.biweek); const s = String(p?.start||'').slice(0,5); const e = String(p?.end||'').slice(0,5); if(!onW||!ok) continue; if(/^\d{2}:\d{2}$/.test(s)&&/^\d{2}:\d{2}$/.test(e)){ if(s<=cur && cur<e) return String(p?.type||'cn'); } }
      return 'cn';
    }
    async function fetchQuote(force){
      const mode = await getActiveMode();
      try{
        // 通用金句始终显示
        try{
          const rg = await fetch('https://api.v1.inkpick.cn/api/random',{cache:'no-store'});
          const jg = await rg.json();
          $('#q-general').textContent = String(jg?.content||'');
          const byG = [jg?.author||'', jg?.source||''].filter(Boolean).join(' · ');
          $('#q-general-from').textContent = byG ? byG : '';
        }catch{}
        if(mode==='cn'){
          $('#card-specific-cn').style.display = '';
          $('#card-specific-en').style.display = 'none';
          $('#card-poem-full').style.display = '';
          let j = null;
          if(!force){ j = getCache('jinrishici'); }
          if(!j){ const r = await fetch('https://v2.jinrishici.com/one.json',{cache:'no-store'}); j = await r.json(); setCache('jinrishici', j); }
          const d = j?.data || {};
          $('#q-specific').textContent = String(d?.content||'');
          const org = d?.origin || {};
          const by = [org?.author||'', org?.title||''].filter(Boolean).join(' · ');
          $('#q-specific-from').textContent = by ? by : '';
          $('#q-specific-translate').textContent = '';
          try {
            const lines = Array.isArray(org?.content) ? org.content : [];
            $('#q-poem-lines').textContent = (lines.length ? lines.join('\n') : '');
          } catch { $('#q-poem-lines').textContent = ''; }
          return;
        }
        if(mode==='en'){
          $('#card-specific-cn').style.display = 'none';
          $('#card-specific-en').style.display = '';
          $('#card-poem-full').style.display = 'none';
          const r = await fetch('https://apiv3.shanbay.com/weapps/dailyquote/quote',{cache:'no-store'});
          const j = await r.json();
          $('#q-specific-en').textContent = String(j?.content||'');
          const by = String(j?.author||'');
          $('#q-specific-en-from').textContent = by ? by : '';
          $('#q-specific-en-translate').textContent = String(j?.translation||'');
          $('#q-poem-lines').textContent = '';
          return;
        }
      }catch{
        $('#q-general').textContent = '洛阳亲友如相问，一片冰心在玉壶';
        $('#q-general-from').textContent = '王昌龄 · 芙蓉楼送辛渐';
        $('#card-specific-cn').style.display = 'none';
        $('#card-specific-en').style.display = 'none';
        $('#card-poem-full').style.display = 'none';
        $('#q-poem-lines').textContent = '';
      }
    }
    function getCache(key){ try{ const raw = localStorage.getItem('mr.cache.'+key); if(!raw) return null; const obj = JSON.parse(raw); if(!obj||!obj.ts||!obj.data) return null; if(Date.now()-obj.ts > 20*60*1000) return null; return obj.data; }catch{ return null; } }
    function setCache(key,data){ try{ localStorage.setItem('mr.cache.'+key, JSON.stringify({ ts: Date.now(), data })); }catch{} }
    $('#btn-refresh').addEventListener('click', ()=>fetchQuote(true));
    startClock();
    fetchQuote();

    
  </script>
</body>
</html>
