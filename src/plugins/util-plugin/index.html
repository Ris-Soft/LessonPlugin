<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>工具示例</title>
    <link rel="stylesheet" href="../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../renderer/titlebar.css" />
    <link rel="stylesheet" href="../../renderer/settings.css" />
  </head>
  <body>
    <div class="titlebar">
      <div class="drag">工具示例</div>
      <div class="window-actions">
        <button class="win-btn" data-act="minimize" title="最小化"><i class="ri-subtract-line"></i></button>
        <button class="win-btn max" data-act="maximize" title="最大化"><i class="ri-checkbox-blank-line"></i></button>
        <button class="win-btn close" data-act="close" title="关闭"><i class="ri-close-line"></i></button>
      </div>
    </div>
    <div class="wrap">
      <div class="section">
        <div class="section-title"><i class="ri-tools-line"></i> 工具示例</div>
        <div class="muted">此插件提供功能：<code>getTime</code> 与事件：<code>basic:hello</code></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button id="btn-register" class="btn secondary"><i class="ri-plug-line"></i> 注册功能</button>
          <button id="btn-call" class="btn secondary"><i class="ri-exchange-line"></i> 调用 demo.basic:hello</button>
        </div>
      </div>
      <div class="section">
        <div class="section-title"><i class="ri-file-list-3-line"></i> 日志</div>
        <div class="box" id="log"></div>
      </div>
    </div>
    <script>
      const log = (msg) => { const el = document.getElementById('log'); const p = document.createElement('div'); p.textContent = msg; el.appendChild(p); };
      document.querySelectorAll('.win-btn').forEach((b) => {
        b.addEventListener('click', () => { const act = b.dataset.act; window.pluginAPI?.windowControl(act); });
      });

      // 当被其他插件调用时执行
      window.pluginAPI?.onInvoke(async (fn, args) => {
        if (fn === 'getTime') {
          return new Date().toISOString();
        }
        throw new Error('未知函数: ' + fn);
      });
      window.pluginAPI?.onEvent((name, payload) => { log(`[事件] ${name}: ${JSON.stringify(payload)}`); });

      document.getElementById('btn-register').addEventListener('click', () => {
        window.pluginAPI?.register('demo.utils', ['getTime']);
        window.pluginAPI?.subscribe('basic:hello');
        log('已注册函数: getTime，并订阅事件 basic:hello');
      });
      document.getElementById('btn-call').addEventListener('click', async () => {
        const res = await window.pluginAPI?.call('demo.basic', 'hello', ['from 工具示例']);
        log('调用结果: ' + JSON.stringify(res));
      });
    </script>
  </body>
  </html>