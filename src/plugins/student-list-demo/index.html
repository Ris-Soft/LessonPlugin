<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>学生列表示例</title>
    <link rel="stylesheet" href="../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../renderer/titlebar.css" />
    <style>
      :root { --bg:#0b1520; --fg:#e6f1ff; --muted:#9bb3cc; --panel:rgba(255,255,255,0.06); --accent:#2dd4bf; --danger:#ef4444; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Microsoft YaHei", sans-serif; margin: 0; background: var(--bg); color: var(--fg); }
      .wrap { padding: 20px; }
      h1 { margin: 0 0 8px 0; color: var(--accent); }
      p { color: var(--muted); margin: 4px 0 12px; }
      .box { margin-top: 16px; padding: 12px; border-radius: 8px; background: var(--panel); }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 8px; }
      th { text-align: left; color: var(--muted); font-weight: 600; }
      td input, td select { width: 100%; box-sizing: border-box; padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); }
      .actions { display: flex; gap: 8px; }
      .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; color: var(--bg); background: var(--fg); }
      .btn.primary { background: var(--accent); color: #06222a; }
      .btn.danger { background: var(--danger); color: #fff; }
      .muted { color: var(--muted); }
      .titlebar .drag { color: var(--fg); }
    </style>
  </head>
  <body>
    <div class="titlebar">
      <div class="drag">学生列表示例</div>
      <div class="window-actions">
        <button class="win-btn" data-act="minimize" title="最小化"><i class="ri-subtract-line"></i></button>
        <button class="win-btn" data-act="maximize" title="最大化"><i class="ri-checkbox-blank-line"></i></button>
        <button class="win-btn close" data-act="close" title="关闭"><i class="ri-close-line"></i></button>
      </div>
    </div>
    <div class="wrap">
      <h1>学生列表维护</h1>
      <p>演示：读取与编辑“档案管理/学生列表”，以及“通用设置”的精准时间＋偏移效果。</p>

      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div class="muted">学生列表（保存在 `profiles.students`）</div>
          <div class="actions">
            <button id="btn-add" class="btn"><i class="ri-user-add-line"></i> 增加一行</button>
            <button id="btn-save" class="btn primary"><i class="ri-save-3-line"></i> 保存修改</button>
          </div>
        </div>
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div>
            <strong>当前时间（按设置偏移与精确开关）</strong>
            <div class="muted">显示设置调整后的时间与偏移秒数</div>
          </div>
          <div class="actions"><button id="btn-refresh" class="btn"><i class="ri-refresh-line"></i> 立即同步</button></div>
        </div>
        <div id="time-box" style="margin-top:8px;"></div>
      </div>

      <div class="box muted" id="log"></div>
    </div>

    <script>
      const log = (msg) => { const el = document.getElementById('log'); const p = document.createElement('div'); p.textContent = msg; el.appendChild(p); };
      document.querySelectorAll('.win-btn').forEach((b) => {
        b.addEventListener('click', () => {
          const act = b.dataset.act;
          window.pluginAPI?.windowControl(act);
        });
      });

      let columns = [];
      let students = [];

      async function loadColumns() {
        const defsRes = await window.pluginAPI?.profilesGetColumnDefs?.();
        const extraCols = Array.isArray(defsRes?.columns) ? defsRes.columns : [];
        columns = [
          { key: 'index', label: '序号' },
          { key: 'name', label: '姓名' },
          { key: 'gender', label: '性别' },
          ...extraCols.map(c => ({ key: c.key, label: c.label })),
          { key: 'actions', label: '操作' }
        ];
        const headRow = document.createElement('tr');
        columns.forEach(col => { const th = document.createElement('th'); th.textContent = col.label; headRow.appendChild(th); });
        const thead = document.getElementById('thead'); thead.innerHTML = ''; thead.appendChild(headRow);
      }

      function renderBody() {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        students.forEach((stu, idx) => {
          const tr = document.createElement('tr');
          columns.forEach(col => {
            const td = document.createElement('td');
            if (col.key === 'index') { td.textContent = String(idx + 1); tr.appendChild(td); return; }
            if (col.key === 'actions') {
              const btnDel = document.createElement('button'); btnDel.className = 'btn danger'; btnDel.innerHTML = '<i class="ri-delete-bin-line"></i> 删除';
              btnDel.addEventListener('click', () => { students.splice(idx, 1); renderBody(); });
              td.appendChild(btnDel); tr.appendChild(td); return;
            }
            if (col.key === 'gender') {
              const sel = document.createElement('select');
              ['','男','女'].forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v || '未填'; sel.appendChild(o); });
              sel.value = stu.gender || '';
              sel.addEventListener('change', () => { stu.gender = sel.value; });
              td.appendChild(sel); tr.appendChild(td); return;
            }
            const inp = document.createElement('input');
            inp.value = (stu[col.key] ?? '');
            inp.placeholder = col.label;
            inp.addEventListener('input', () => { stu[col.key] = inp.value; });
            td.appendChild(inp); tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      async function loadStudents() {
        await window.pluginAPI?.configEnsureDefaults('profiles', { students: [] });
        const list = await window.pluginAPI?.configGet('profiles', 'students');
        students = Array.isArray(list) ? list.map(x => ({ ...x })) : [];
        renderBody();
      }

      async function saveStudents() {
        // 移除序号与操作列，不需要保存
        const toSave = students.map(stu => {
          const obj = { ...stu }; delete obj.index; delete obj.actions; return obj;
        });
        const res = await window.pluginAPI?.configSet('profiles', 'students', toSave);
        log('保存结果: ' + JSON.stringify(res));
      }

      async function refreshTime() {
        const info = await window.pluginAPI?.getCurrentTime();
        const box = document.getElementById('time-box');
        const sysIso = new Date(Date.now()).toISOString();
        box.innerHTML = '';
        const lines = [
          `系统当前时间: ${sysIso}`,
          `设置调整后: ${info?.iso || ''}`,
          `偏移秒数: ${info?.offsetSec ?? 0} （含每天自动叠加）`
        ];
        for (const s of lines) { const p = document.createElement('div'); p.textContent = s; box.appendChild(p); }
      }

      document.getElementById('btn-add').addEventListener('click', () => {
        students.push({ name: '', gender: '', });
        renderBody();
      });
      document.getElementById('btn-save').addEventListener('click', saveStudents);
      document.getElementById('btn-refresh').addEventListener('click', refreshTime);

      (async function init() {
        await loadColumns();
        await loadStudents();
        await refreshTime();
      })();
    </script>
  </body>
  </html>