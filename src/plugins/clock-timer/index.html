<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>时钟/秒表/倒计时</title>
    <link rel="stylesheet" href="../../renderer/remixicon-local.css" />
    <style>
      html, body { height: 100%; background: #000; color: #e6e6e6; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, sans-serif; }
      .titlebar { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; background: #000; color: #ddd; -webkit-app-region: drag; }
      .left { display: flex; gap: 8px; align-items: center; padding-top: 8px; }
      .tabs { display: flex; gap: 8px; }
      .tab { padding: 6px 10px; border-radius: 8px; cursor: pointer; -webkit-app-region: no-drag; }
      .tab.active { background: #1f1f1f; color: #fff; }
      .window-actions { display: flex; gap: 8px; -webkit-app-region: no-drag; }
      .btn { height: 28px; padding: 0 8px; border: none; border-radius: 4px; background: transparent; color: #ddd; cursor: pointer; }
      .btn i { font-size: 18px; }
      .btn.close { color: #ff4d4f; }
      .content { height: calc(100% - 50px); display: flex; align-items: center; justify-content: center; -webkit-app-region: drag; }
      .compact .content { height: 100%; }
      .panel { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; -webkit-app-region: drag; }
      .time { font-size: 96px; letter-spacing: 2px; font-weight: 600; }
      .controls { display: flex; gap: 10px; -webkit-app-region: no-drag; }
      .ctrl { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; background: #1f1f1f; color: #ddd; display: inline-flex; align-items: center; justify-content: center; -webkit-app-region: no-drag; }
      .ctrl i { font-size: 20px; }
      .ctrl.primary { background: #22c55e; color: #041a10; }
      .ctrl.warn { background: #ef4444; color: #fff; }
      .compact-label { position: absolute; right: 12px; bottom: 10px; font-size: 12px; color: #9aa0a6; }
      .fullscreen-actions { position: absolute; right: 12px; bottom: 10px; display: flex; gap: 8px; -webkit-app-region: no-drag; }
      .fs-btn { padding: 6px 10px; border-radius: 8px; border: none; background: #1f1f1f; color: #ddd; cursor: pointer; -webkit-app-region: no-drag; }
      .fs-btn.close { background: #ef4444; color: #fff; }
      .hidden { display: none !important; }
      input { -webkit-app-region: no-drag; }
      .compact-menu { position: absolute; left: 12px; bottom: 10px; display: none; -webkit-app-region: no-drag; }
      .compact .compact-menu { display: flex; }
      .display-wrap { width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; position: relative; }
      .cd-editor { position: absolute; display: flex; gap: 18px; align-items: center; justify-content: center; }
      .compact #panel-stopwatch .controls { display: none !important; }
      .compact #panel-countdown #cd-controls { display: none !important; }
    </style>
  </head>
  <body>
    <div class="titlebar">
      <div class="left">
        <div class="tabs" id="tabs">
          <div class="tab" data-mode="clock">时钟</div>
          <div class="tab" data-mode="stopwatch">秒表</div>
          <div class="tab" data-mode="countdown">倒计时</div>
        </div>
      </div>
      <div class="window-actions">
        <button class="btn" data-act="fullscreen" title="全屏"><i class="ri-focus-2-line"></i></button>
        <button class="btn close" data-act="close" title="关闭"><i class="ri-close-line"></i></button>
      </div>
    </div>
    <div class="content">
      <div class="panel" id="panel-clock">
        <div class="time" id="clock-time">00:00:00</div>
      </div>
      <div class="panel hidden" id="panel-stopwatch">
        <div class="time" id="stopwatch-time">00:00:00</div>
        <div class="controls">
          <button class="ctrl primary" id="sw-start" title="开始"><i class="ri-play-line"></i></button>
          <button class="ctrl" id="sw-pause" title="暂停"><i class="ri-pause-line"></i></button>
          <button class="ctrl warn" id="sw-reset" title="重置"><i class="ri-refresh-line"></i></button>
        </div>
      </div>
      <div class="panel hidden" id="panel-countdown">
        <div class="display-wrap">
          <div class="time" id="countdown-time">00:00:00</div>
          <div class="cd-editor" id="cd-editor">
            <div class="cd-digit" data-key="hTens" style="text-align:center;">
              <button class="ctrl" data-op="inc" data-key="hTens" title="时十位+"><i class="ri-add-line"></i></button>
              <div class="digit" id="cd-hTens" style="font-size:36px; margin:6px 0;">0</div>
              <button class="ctrl" data-op="dec" data-key="hTens" title="时十位-"><i class="ri-subtract-line"></i></button>
            </div>
            <div class="cd-digit" data-key="hOnes" style="text-align:center;">
              <button class="ctrl" data-op="inc" data-key="hOnes" title="时个位+"><i class="ri-add-line"></i></button>
              <div class="digit" id="cd-hOnes" style="font-size:36px; margin:6px 0;">0</div>
              <button class="ctrl" data-op="dec" data-key="hOnes" title="时个位-"><i class="ri-subtract-line"></i></button>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;font-size:28px;color:#888;">:</div>
            <div class="cd-digit" data-key="mTens" style="text-align:center;">
              <button class="ctrl" data-op="inc" data-key="mTens" title="分十位+"><i class="ri-add-line"></i></button>
              <div class="digit" id="cd-mTens" style="font-size:36px; margin:6px 0;">0</div>
              <button class="ctrl" data-op="dec" data-key="mTens" title="分十位-"><i class="ri-subtract-line"></i></button>
            </div>
            <div class="cd-digit" data-key="mOnes" style="text-align:center;">
              <button class="ctrl" data-op="inc" data-key="mOnes" title="分个位+"><i class="ri-add-line"></i></button>
              <div class="digit" id="cd-mOnes" style="font-size:36px; margin:6px 0;">0</div>
              <button class="ctrl" data-op="dec" data-key="mOnes" title="分个位-"><i class="ri-subtract-line"></i></button>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;font-size:28px;color:#888;">:</div>
            <div class="cd-digit" data-key="sTens" style="text-align:center;">
              <button class="ctrl" data-op="inc" data-key="sTens" title="秒十位+"><i class="ri-add-line"></i></button>
              <div class="digit" id="cd-sTens" style="font-size:36px; margin:6px 0;">0</div>
              <button class="ctrl" data-op="dec" data-key="sTens" title="秒十位-"><i class="ri-subtract-line"></i></button>
            </div>
            <div class="cd-digit" data-key="sOnes" style="text-align:center;">
              <button class="ctrl" data-op="inc" data-key="sOnes" title="秒个位+"><i class="ri-add-line"></i></button>
              <div class="digit" id="cd-sOnes" style="font-size:36px; margin:6px 0;">0</div>
              <button class="ctrl" data-op="dec" data-key="sOnes" title="秒个位-"><i class="ri-subtract-line"></i></button>
            </div>
          </div>
        </div>
        <div class="controls" id="cd-controls" style="gap:10px;">
          <button class="ctrl primary" id="cd-start" title="开始"><i class="ri-play-line"></i></button>
          <button class="ctrl" id="cd-pause" title="暂停"><i class="ri-pause-line"></i></button>
          <button class="ctrl warn" id="cd-reset" title="重置"><i class="ri-refresh-line"></i></button>
        </div>
      </div>
    </div>
    <div class="compact-label hidden" id="compact-label">时钟</div>
    <div class="fullscreen-actions" id="fs-actions">
      <button class="fs-btn" id="fs-shrink" title="退出全屏并缩小"><i class="ri-fullscreen-exit-line"></i></button>
      <button class="fs-btn close" id="fs-close" title="关闭"><i class="ri-close-line"></i></button>
    </div>
    <div class="compact-menu" id="compact-menu">
      <button class="fs-btn" id="compact-menu-btn" title="恢复到正常"><i class="ri-menu-line"></i></button>
    </div>

    <script>
      const qs = new URLSearchParams(location.search);
      let mode = qs.get('mode') || 'clock';
      let compact = false;
      let lastActive = Date.now();
      let swRunning = false, swStart = 0, swElapsed = 0;
      let cdRunning = false, cdTarget = 0;

      const el = (id) => document.getElementById(id);
      const fmt = (ms) => {
        const t = Math.max(0, Math.floor(ms / 1000));
        const h = String(Math.floor(t / 3600)).padStart(2, '0');
        const m = String(Math.floor((t % 3600) / 60)).padStart(2, '0');
        const s = String(t % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
      };

      const updateTabs = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
        el('panel-clock').classList.toggle('hidden', mode !== 'clock');
        el('panel-stopwatch').classList.toggle('hidden', mode !== 'stopwatch');
        el('panel-countdown').classList.toggle('hidden', mode !== 'countdown');
        el('compact-label').textContent = mode === 'clock' ? '时钟' : (mode === 'stopwatch' ? '秒表' : '倒计时');
      };

      const setCompact = async (on) => {
        compact = !!on;
        document.querySelector('.titlebar').classList.toggle('hidden', compact);
        // 计时控制按钮在紧凑模式下也保持可见
        el('compact-label').classList.toggle('hidden', !compact);
        document.body.classList.toggle('compact', compact);
        await window.clockAPI?.call('setWindowMode', [compact ? 'compact' : 'normal']);
        if (compact) await window.clockAPI?.windowControl('blur');
      };

      const restoreIfCompact = () => { if (compact) setCompact(false); };

      document.addEventListener('mousemove', () => { lastActive = Date.now(); restoreIfCompact(); });
      document.addEventListener('pointerdown', () => { lastActive = Date.now(); restoreIfCompact(); });
      document.addEventListener('keydown', () => { lastActive = Date.now(); restoreIfCompact(); });
      document.addEventListener('click', () => { lastActive = Date.now(); restoreIfCompact(); });
      window.addEventListener('focus', () => { lastActive = Date.now(); restoreIfCompact(); });

      document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', () => {
        const act = b.dataset.act; window.clockAPI?.windowControl(act);
      }));

      const resetTimers = () => {
        swRunning = false; swElapsed = 0; el('stopwatch-time').textContent = '00:00:00';
        cdRunning = false; cdTarget = 0; el('countdown-time').textContent = '00:00:00';
      };
      document.getElementById('fs-shrink').addEventListener('click', async () => {
        await window.clockAPI?.windowControl('fullscreen');
        resetTimers();
        await setCompact(true);
      });
      document.getElementById('fs-close').addEventListener('click', () => { window.clockAPI?.windowControl('close'); });
      document.getElementById('compact-menu-btn').addEventListener('click', async () => { lastActive = Date.now(); await setCompact(false); });

      document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => { mode = t.dataset.mode; lastActive = Date.now(); updateTabs(); restoreIfCompact(); }));

      el('sw-start').addEventListener('click', () => { if (!swRunning) { swRunning = true; swStart = Date.now() - swElapsed; lastActive = Date.now(); } });
      el('sw-pause').addEventListener('click', () => { if (swRunning) { swRunning = false; swElapsed = Date.now() - swStart; lastActive = Date.now(); } });
      el('sw-reset').addEventListener('click', () => { swRunning = false; swElapsed = 0; el('stopwatch-time').textContent = '00:00:00'; lastActive = Date.now(); });

      let cdEditorVisible = true;
      const cdDigits = { hTens: 0, hOnes: 0, mTens: 0, mOnes: 0, sTens: 0, sOnes: 0 };
      const clamp01 = (v) => Math.max(0, Math.min(9, v));
      const clampST = (v) => Math.max(0, Math.min(5, v));
      const renderDigits = () => {
        el('cd-hTens').textContent = String(cdDigits.hTens);
        el('cd-hOnes').textContent = String(cdDigits.hOnes);
        el('cd-mTens').textContent = String(cdDigits.mTens);
        el('cd-mOnes').textContent = String(cdDigits.mOnes);
        el('cd-sTens').textContent = String(cdDigits.sTens);
        el('cd-sOnes').textContent = String(cdDigits.sOnes);
      };
      document.querySelectorAll('[data-op][data-key]').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-key');
          const op = btn.getAttribute('data-op');
          if (!key || !op) return;
          if (key === 'hTens') cdDigits.hTens = clamp01(cdDigits.hTens + (op === 'inc' ? 1 : -1));
          else if (key === 'hOnes') cdDigits.hOnes = clamp01(cdDigits.hOnes + (op === 'inc' ? 1 : -1));
          else if (key === 'mTens') cdDigits.mTens = clampST(cdDigits.mTens + (op === 'inc' ? 1 : -1));
          else if (key === 'mOnes') cdDigits.mOnes = clamp01(cdDigits.mOnes + (op === 'inc' ? 1 : -1));
          else if (key === 'sTens') cdDigits.sTens = clampST(cdDigits.sTens + (op === 'inc' ? 1 : -1));
          else if (key === 'sOnes') cdDigits.sOnes = clamp01(cdDigits.sOnes + (op === 'inc' ? 1 : -1));
          renderDigits();
        });
      });
      renderDigits();

      const cdTotalMs = () => {
        const hours = cdDigits.hTens * 10 + cdDigits.hOnes;
        const minutes = cdDigits.mTens * 10 + cdDigits.mOnes;
        const seconds = cdDigits.sTens * 10 + cdDigits.sOnes;
        return ((hours * 3600) + (minutes * 60) + seconds) * 1000;
      };
      el('cd-start').addEventListener('click', () => {
        const total = cdTotalMs();
        if (total > 0) {
          cdRunning = true;
          cdTarget = Date.now() + total;
          lastActive = Date.now();
          cdEditorVisible = false;
          el('cd-editor').classList.add('hidden');
          el('countdown-time').classList.remove('hidden');
        }
      });
      el('cd-pause').addEventListener('click', () => { cdRunning = false; lastActive = Date.now(); });
      el('cd-reset').addEventListener('click', () => {
        cdRunning = false;
        cdTarget = 0;
        el('countdown-time').textContent = '00:00:00';
        el('countdown-time').classList.add('hidden');
        lastActive = Date.now();
        cdEditorVisible = true;
        el('cd-editor').classList.remove('hidden');
      });

      let isFullscreen = false;
      let prevFullscreen = null;
      let tz = 'Asia/Shanghai';
      let baseNowMs = Date.now();
      let baseJsNow = Date.now();
      const fmtHMSByTZ = (ms) => {
        try {
          const d = new Date(ms);
          const parts = new Intl.DateTimeFormat('zh-CN', { timeZone: tz, hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }).formatToParts(d);
          const get = (t) => parts.find(p => p.type === t)?.value || '00';
          return `${get('hour')}:${get('minute')}:${get('second')}`;
        } catch (_) {
          const d = new Date(ms);
          const h = String(d.getHours()).padStart(2, '0');
          const m = String(d.getMinutes()).padStart(2, '0');
          const s = String(d.getSeconds()).padStart(2, '0');
          return `${h}:${m}:${s}`;
        }
      };
      const syncTime = async () => {
        try {
          const cfgTz = await window.clockAPI?.configGet('system', 'timeZone');
          if (typeof cfgTz === 'string' && cfgTz) tz = cfgTz;
        } catch {}
        try {
          const t = await window.clockAPI?.getCurrentTime();
          if (t && typeof t.nowMs === 'number') { baseNowMs = t.nowMs; baseJsNow = Date.now(); }
        } catch {}
      };
      const tick = () => {
        const nowMs = baseNowMs + (Date.now() - baseJsNow);
        el('clock-time').textContent = fmtHMSByTZ(nowMs);
        if (swRunning) el('stopwatch-time').textContent = fmt(Date.now() - swStart); else el('stopwatch-time').textContent = fmt(swElapsed);
        if (cdRunning) {
          const left = Math.max(0, cdTarget - Date.now());
          el('countdown-time').textContent = fmt(left);
          if (left <= 0) {
            cdRunning = false;
            try {
              const times = 3; const interval = 2000;
              for (let i = 0; i < times; i++) { setTimeout(() => { try { window.clockAPI?.pluginCall('notify.plugin','sound',['alarm']); } catch {} }, i * interval); }
            } catch {}
            cdEditorVisible = true;
            el('cd-editor').classList.remove('hidden');
            el('countdown-time').classList.add('hidden');
          }
        }
      };

      (async () => { await syncTime(); })();
      setInterval(() => { syncTime(); }, 5000);
      setInterval(() => {
        tick();
        const idleFor = Date.now() - lastActive;
        const shouldCompact = (mode === 'clock' || (mode === 'stopwatch' && swRunning) || (mode === 'countdown' && cdRunning)) && idleFor >= 5000;
        if (shouldCompact && !compact) setCompact(true);
      }, 250);

      const initMode = mode;
      updateTabs();
      if (['clock','stopwatch','countdown'].includes(initMode)) { mode = initMode; updateTabs(); }
      el('countdown-time').classList.add('hidden');

      setInterval(async () => {
        try {
          const fs = await window.clockAPI?.isFullscreen();
          if (typeof fs === 'boolean') {
            isFullscreen = fs;
            document.querySelector('.window-actions').classList.toggle('hidden', isFullscreen);
            document.querySelector('.left').classList.toggle('hidden', isFullscreen);
            el('fs-actions').classList.toggle('hidden', !isFullscreen);
            if (prevFullscreen === true && isFullscreen === false) {
              resetTimers();
            }
            prevFullscreen = isFullscreen;
          }
        } catch {}
      }, 500);
    </script>
  </body>
</html>
