<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>搜索</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>
    html, body { height: 100%; margin: 0; background: #181818; color: #e6e6e6; font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; }
    .wrap { height: 100%; display: flex; flex-direction: column; }
    header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #2a2a2a; }
    .content { padding: 16px; display: flex; gap: 8px; }
    input { flex: 1; padding: 10px 12px; border-radius: 6px; border: 1px solid #2a2a2a; background: #101010; color: #e6e6e6; }
    button { padding: 10px 16px; border-radius: 6px; border: 1px solid #2a2a2a; background: #202020; color: #e6e6e6; cursor: pointer; }
    .result { padding: 8px 16px; color: #a0a0a0; display:flex; flex-direction:column; gap:8px; }
    .item { display:flex; gap:12px; align-items:center; padding:8px; border:1px solid #2a2a2a; border-radius:8px; cursor:pointer; }
    .item:hover { background:#202020; }
    .item img { width:56px; height:56px; object-fit:cover; border-radius:6px; }
    .item .meta { display:flex; flex-direction:column; }
    .item .meta .title { color:#e6e6e6; }
    .item .meta .artist { color:#9a9a9a; font-size:12px; }
  </style>
  <script>
    async function fetchKuwoPage(q, pn){
      const apiUrl = `https://search.kuwo.cn/r.s?all=${encodeURIComponent(q)}&pn=${pn}&rn=20&vipver=100&ft=music&encoding=utf8&rformat=json&vermerge=1&mobi=1`;
      const proxyRes = await window.lowbarAPI.pluginCall('radio.music', 'kuwoProxy', [apiUrl]);
      if (!proxyRes || !proxyRes.ok) return null;
      try {
        const txt = String(proxyRes.content || '');
        const s = txt.indexOf('{'); const e = txt.lastIndexOf('}');
        const jsonStr = (s>=0 && e>s) ? txt.slice(s, e+1) : txt;
        return JSON.parse(jsonStr);
      } catch { return null; }
    }
    async function doSearch(){
      const q = document.getElementById('q').value.trim();
      const r = document.getElementById('result');
      r.innerHTML = '';
      r.style.display = 'block';
      if (!q) { r.textContent = '请输入关键词'; return; }
      let data = await fetchKuwoPage(q, 0);
      let list = (data && Array.isArray(data.abslist)) ? data.abslist : [];
      if (!list.length) {
        data = await fetchKuwoPage(q, 1);
        list = (data && Array.isArray(data.abslist)) ? data.abslist : [];
      }
      if (!list.length) { r.textContent = '未找到结果'; return; }
      for (const item of list) {
        const id = String(item.MUSICRID||'').replace('MUSIC_','');
        const cover = item.web_albumpic_short ? `https://img3.kuwo.cn/star/albumcover/${String(item.web_albumpic_short).replace('120/','256/')}` : (item.web_artistpic_short ? `https://star.kuwo.cn/star/starheads/${String(item.web_artistpic_short).replace('120/','500/')}` : '');
        const rawTitle = item.SONGNAME || '';
        const title = rawTitle.includes('-') ? rawTitle.split('-').slice(0,-1).join('-').trim() : rawTitle;
        const artist = item.ARTIST || '';
        const album = item.ALBUM || '';
        const it = { id, cover, title, artist, album };
        const el = document.createElement('div'); el.className = 'item';
        const img = document.createElement('img'); img.src = it.cover || '';
        const meta = document.createElement('div'); meta.className = 'meta';
        const t = document.createElement('div'); t.className = 'title'; t.textContent = it.title || '';
        const a = document.createElement('div'); a.className = 'artist'; a.textContent = (it.artist||'') + (it.album? ' · ' + it.album : '');
        meta.appendChild(t); meta.appendChild(a);
        el.appendChild(img); el.appendChild(meta);
        el.onclick = async () => {
          const g = await window.lowbarAPI.pluginCall('radio.music', 'getKuwoPlayUrl', [it.id, 'standard']);
          if (!g || !g.ok) { alert('获取播放地址失败'); return; }
          await window.lowbarAPI.pluginCall('radio.music', 'setBackgroundMusic', [{ music: g.url, album: it.cover, title: it.title, artist: it.artist }]);
        };
        r.appendChild(el);
      }
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>搜索歌曲/电台</header>
    <div class="content">
      <input id="q" placeholder="输入歌名/艺术家/电台" />
      <button onclick="doSearch()"><i class="ri-search-line"></i> 搜索</button>
    </div>
    <div id="result" class="result">输入关键词后显示结果（占位）</div>
  </div>
</body>
</html>