<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>搜索</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>
    html, body { height: 100%; margin: 0; background: #181818; color: #e6e6e6; font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; user-select: none; -webkit-user-select: none; -ms-user-select: none; }
    .wrap { height: 100%; display: flex; flex-direction: column; }
    header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #2a2a2a; }
    .content { padding: 16px; display: flex; gap: 8px; }
    input { flex: 1; padding: 10px 12px; border-radius: 6px; border: 1px solid #2a2a2a; background: #101010; color: #e6e6e6; }
    input:focus { outline: none; box-shadow: none; border-color: #3a3a3a; }
    button { padding: 10px 16px; border-radius: 6px; border: 1px solid #2a2a2a; background: #202020; color: #e6e6e6; cursor: pointer; }
    button:focus { outline: none; box-shadow: none; border-color: #3a3a3a; }
    .scroll { flex: 1; overflow: auto; }
    .scroll::-webkit-scrollbar { width: 10px; }
    .scroll::-webkit-scrollbar-track { background: #151515; }
    .scroll::-webkit-scrollbar-thumb { background: #2e2e2e; border-radius: 6px; border: 2px solid #151515; }
    .result { padding: 8px 16px; color: #a0a0a0; display:flex; flex-direction:column; gap:8px; }
    .item { display:flex; gap:12px; align-items:flex-start; padding:12px; border:1px solid #2a2a2a; border-radius:8px; cursor:pointer; margin-bottom:10px; }
    .item:hover { background:#202020; }
    .item img { width:56px; height:56px; object-fit:cover; border-radius:6px; }
    .item .meta { display:flex; flex-direction:column; }
    .item .meta .title { color:#e6e6e6; }
    .item .meta .artist { color:#9a9a9a; font-size:12px; }
    .controls { display:flex; gap:8px; margin-left:auto; }
    .controls button { padding:6px 10px; font-size:12px; border-radius:6px; border:1px solid #2a2a2a; background:transparent; color:#e6e6e6; cursor:pointer; }
    .controls i { margin-right:6px; color:#c0c0c0; }
    .menu { margin: -6px 16px 10px 72px; padding:8px; border:1px dashed #2a2a2a; border-radius:8px; display:none; background:#1a1a1a; }
    .menu .actions { display:flex; gap:10px; }
    .menu .actions button { padding:6px 10px; font-size:12px; border-radius:6px; border:1px solid #2a2a2a; background:#262626; color:#e6e6e6; cursor:pointer; }
    .menu .actions i { margin-right:6px; color:#c0c0c0; }
    .loadingbar { display:none; padding: 8px 16px; color:#9ad; align-items:center; gap:8px; }
    .loadingbar i { font-size:16px; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
    .tip { padding: 0 16px 4px 16px; color:#9a9a9a; font-size:12px; }
  </style>
  <script>
    let currentPage = 0;
    let currentQuery = '';
    let currentSource = 'kuwo';
    let hasMore = false;
    let loading = false;
    let searchSeq = 0;
    let openMenu = null;
    function renderItems(items){
      const r = document.getElementById('result');
      for (const it of items) {
        const el = document.createElement('div'); el.className = 'item';
        const img = document.createElement('img'); img.src = it.cover || '';
        const meta = document.createElement('div'); meta.className = 'meta';
        const t = document.createElement('div'); t.className = 'title'; t.textContent = it.title || '';
        const a = document.createElement('div'); a.className = 'artist'; a.textContent = (it.artist||'') + (it.album? ' · ' + it.album : '');
        meta.appendChild(t); meta.appendChild(a);
        el.appendChild(img); el.appendChild(meta);
        const menu = document.createElement('div'); menu.className = 'menu';
        const actions = document.createElement('div'); actions.className = 'actions';
        const mTail = document.createElement('button'); mTail.innerHTML = '<i class="ri-play-list-2-line"></i> 插入到歌单尾部';
        const mPlay = document.createElement('button'); mPlay.innerHTML = '<i class="ri-play-fill"></i> 立即播放';
        const mNext = document.createElement('button'); mNext.innerHTML = '<i class="ri-skip-forward-fill"></i> 下一首播放';
        function hideFloating(){ try { window.lowbarAPI.emitEvent('radio.music', { type:'update', target:'floatingUrl', value: null }); } catch {} }
        mTail.onclick = async (e) => { e.stopPropagation(); await window.lowbarAPI.pluginCall('radio.music', 'enqueueTail', [it]); hideFloating(); };
        mPlay.onclick = async (e) => { e.stopPropagation(); const r = await window.lowbarAPI.pluginCall('radio.music', 'playNow', [it]); if (!(r && (r.result ? r.result.ok : r.ok))) alert('播放失败'); hideFloating(); };
        mNext.onclick = async (e) => { e.stopPropagation(); await window.lowbarAPI.pluginCall('radio.music', 'enqueueNext', [it]); hideFloating(); };
        actions.appendChild(mTail); actions.appendChild(mPlay); actions.appendChild(mNext);
        menu.appendChild(actions);
        const ctrl = document.createElement('div'); ctrl.className = 'controls';
        const btnExpand = document.createElement('button'); btnExpand.innerHTML = '<i class="ri-arrow-down-s-line"></i> 展开';
        btnExpand.onclick = (e) => { e.stopPropagation(); if (openMenu && openMenu !== menu) openMenu.style.display = 'none'; menu.style.display = (menu.style.display === 'none' || !menu.style.display) ? 'block' : 'none'; openMenu = menu.style.display === 'block' ? menu : null; };
        ctrl.appendChild(btnExpand);
        el.appendChild(ctrl);
        el.onclick = () => {
          if (openMenu && openMenu !== menu) openMenu.style.display = 'none';
          menu.style.display = menu.style.display === 'none' || !menu.style.display ? 'block' : 'none';
          openMenu = menu.style.display === 'block' ? menu : null;
        };
        r.appendChild(el);
        r.appendChild(menu);
      }
    }
    async function loadPage(append){
      if (loading) return;
      loading = true;
      const r = document.getElementById('result');
      const btn = document.getElementById('loadmore');
      const pageInfo = document.getElementById('pageinfo');
      const dbg = document.getElementById('debugjson');
      const sbtn = document.getElementById('searchbtn');
      const lbar = document.getElementById('loadingbar');
      btn.disabled = true;
      if (sbtn) sbtn.disabled = true;
      if (lbar) { lbar.style.display = 'flex'; }
      const method = currentSource === 'bili' ? 'searchBili' : 'searchKuwo';
      const res = await window.lowbarAPI.pluginCall('radio.music', method, [currentQuery, currentPage]);
      const data = res && res.result ? res.result : res;
      if (!data || data.ok === false) {
        if (!append) r.textContent = '搜索失败';
        const txt = (data && data.raw) ? data.raw : JSON.stringify(res || {});
        dbg.textContent = String(txt || '');
        dbg.style.display = 'block';
      loading = false;
      btn.disabled = false;
      if (sbtn) sbtn.disabled = false;
      if (lbar) { lbar.style.display = 'none'; }
      return;
    }
      const items = Array.isArray(data.items) ? data.items : [];
      hasMore = !!data.hasMore;
      if (!append) r.innerHTML = '';
      if (!items.length && !append) { r.textContent = '未找到结果'; }
      else renderItems(items);
      if (!items.length) {
        const txt = (data && data.raw) ? data.raw : JSON.stringify(data || {});
        dbg.textContent = String(txt || '');
        dbg.style.display = 'block';
      } else {
        dbg.textContent = '';
        dbg.style.display = 'none';
      }
      btn.style.display = hasMore ? 'inline-block' : 'none';
      pageInfo.textContent = `第 ${currentPage+1} 页`;
      loading = false;
      btn.disabled = false;
      if (sbtn) sbtn.disabled = false;
      if (lbar) { lbar.style.display = 'none'; }
    }
    async function doSearch(){
      const q = document.getElementById('q').value.trim();
      const r = document.getElementById('result');
      r.style.display = 'block';
      if (!q) { r.innerHTML = '请输入关键词'; return; }
      searchSeq += 1;
      const seq = searchSeq;
      r.innerHTML = '';
      const dbg = document.getElementById('debugjson');
      if (dbg) { dbg.textContent = ''; dbg.style.display = 'none'; }
      const btn = document.getElementById('loadmore');
      if (btn) { btn.style.display = 'none'; btn.disabled = true; }
      currentQuery = q;
      currentPage = 0;
      loading = false;
      await loadPage(false);
      if (seq !== searchSeq) return;
    }
    function initSourceSwitch(){
      const sel = document.getElementById('source');
      if (sel) {
        sel.value = currentSource;
        sel.addEventListener('change', () => { currentSource = sel.value || 'kuwo'; });
      }
    }
    window.addEventListener('DOMContentLoaded', initSourceSwitch);
    window.addEventListener('DOMContentLoaded', () => { const iq = document.getElementById('q'); if (iq) { iq.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); }); try { iq.focus(); } catch {} } });
  </script>
</head>
<body>
  <div class="wrap">
    <header>搜索歌曲</header>
    <div class="content">
      <input id="q" placeholder="输入歌名/艺术家" />
      <select id="source" style="padding:10px 12px;border-radius:6px;border:1px solid #2a2a2a;background:#101010;color:#e6e6e6;">
        <option value="kuwo">酷我</option>
        <option value="bili">Bilibili</option>
      </select>
      <button id="searchbtn" onclick="doSearch()"><i class="ri-search-line"></i> 搜索</button>
    </div>
    <div class="tip">请单击目标歌曲以调起播放菜单</div>
    <div class="scroll">
      <div id="result" class="result">输入关键词后显示结果</div>
      <div id="loadingbar" class="loadingbar"><i class="ri-loader-4-line spin"></i> 正在搜索…</div>
      <div style="padding: 8px 16px; display:flex; align-items:center; gap:12px;">
        <span id="pageinfo">第 1 页</span>
        <button id="loadmore" style="display:none;" onclick="(async()=>{ if (!hasMore) return; currentPage += 1; await loadPage(true); })()">加载更多</button>
      </div>
      <pre id="debugjson" style="display:none; padding:8px 16px; margin:0; border-top:1px solid #2a2a2a; color:#9ad; white-space:pre-wrap; word-break:break-all; max-height:200px; overflow:auto;"></pre>
    </div>
  </div>
</body>
</html>
