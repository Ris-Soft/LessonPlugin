<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMLL 播放器</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0f1115; color: #e6e6e6; font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; }
    .wrap { display: grid; grid-template-columns: 340px 1fr; grid-template-rows: 56px 1fr; height: 100%; }
    .top { grid-column: 1 / 3; display: flex; align-items: center; gap: 12px; padding: 0 12px; border-bottom: 1px solid #1f232b; }
    .panel { padding: 12px; border-right: 1px solid #1f232b; overflow: auto; }
    .player { position: relative; }
    .player .mount { position: absolute; inset: 0; }
    .row { display: flex; align-items: center; gap: 8px; }
    .row input[type="file"] { color: #c9c9c9; }
    .row button { height: 30px; padding: 0 12px; background: #1f6feb; color: #fff; border: 0; border-radius: 6px; }
    .row button.secondary { background: #30363d; color: #e6e6e6; }
    textarea { width: 100%; height: 200px; background: #0d0f14; color: #e6e6e6; border: 1px solid #1f232b; border-radius: 8px; padding: 8px; resize: vertical; }
    .hint { font-size: 12px; color: #a8b3c5; }
  </style>
  <script>
    window.state = { coreUrl: null, lyricUrl: null, coreStyleUrl: null, importMap: null };
    (async function setup(){
      const res = await window.lowbarAPI.pluginCall('radio.music', 'getAmlEntryUrls', []);
      if (res && res.ok) {
        window.state.coreUrl = res.coreUrl; window.state.lyricUrl = res.lyricUrl; window.state.coreStyleUrl = res.coreStyleUrl; window.state.importMap = res.importMap || {};
        if (window.state.importMap && typeof window.state.importMap === 'object') {
          const m = document.createElement('script'); m.type = 'importmap'; m.textContent = JSON.stringify({ imports: window.state.importMap }); document.head.appendChild(m);
        }
        if (window.state.coreStyleUrl) { const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = window.state.coreStyleUrl; document.head.appendChild(l); }
      } else {
        alert('AMLL 入口解析失败');
      }
    })();
  </script>
  <script type="module">
    const audio = new Audio();
    let CoreMod = null;
    let LyricMod = null;
    let player = null;
    async function ensureMods(){
      if (!CoreMod) { CoreMod = await import(window.state.coreUrl); }
      if (!LyricMod) { LyricMod = await import(window.state.lyricUrl); }
    }
    function toLines(raw){
      return raw.map((line, i, arr) => ({
        words: [{ word: line.words[0]?.word ?? '', startTime: line.words[0]?.startTime ?? 0, endTime: arr[i + 1]?.words?.[0]?.startTime ?? Infinity }],
        startTime: line.words[0]?.startTime ?? 0,
        endTime: arr[i + 1]?.words?.[0]?.startTime ?? Infinity,
        translatedLyric: '', romanLyric: '', isBG: false, isDuet: false
      }));
    }
    async function initPlayer(){
      await ensureMods();
      const { LyricPlayer } = CoreMod;
      const mount = document.querySelector('.mount');
      player = new LyricPlayer();
      mount.appendChild(player.getElement());
      let rafId = 0;
      function loop(){
        const ms = Math.floor(audio.currentTime * 1000);
        player.setCurrentTime(ms);
        player.update(ms);
        rafId = requestAnimationFrame(loop);
      }
      audio.addEventListener('play', () => { cancelAnimationFrame(rafId); rafId = requestAnimationFrame(loop); });
      audio.addEventListener('pause', () => { cancelAnimationFrame(rafId); });
      audio.addEventListener('ended', () => { cancelAnimationFrame(rafId); });
    }
    async function loadLyric(text){
      await ensureMods();
      const { parseLrc } = LyricMod;
      const raw = parseLrc(text || '');
      const lines = toLines(raw);
      player.setLyricLines(lines);
    }
    window.addEventListener('DOMContentLoaded', async () => {
      await initPlayer();
      const audioInput = document.getElementById('audio-file');
      const lyricInput = document.getElementById('lyric-file');
      const lyricText = document.getElementById('lyric-text');
      const btnLoadText = document.getElementById('btn-load-text');
      const btnPlay = document.getElementById('btn-play');
      const btnPause = document.getElementById('btn-pause');
      audioInput.addEventListener('change', () => {
        const f = audioInput.files && audioInput.files[0]; if (!f) return;
        const url = URL.createObjectURL(f); audio.src = url; audio.load();
      });
      lyricInput.addEventListener('change', () => {
        const f = lyricInput.files && lyricInput.files[0]; if (!f) return;
        const r = new FileReader(); r.onload = () => loadLyric(String(r.result||'')); r.readAsText(f);
      });
      btnLoadText.addEventListener('click', () => loadLyric(lyricText.value));
      btnPlay.addEventListener('click', () => audio.play());
      btnPause.addEventListener('click', () => audio.pause());
    });
  </script>
  
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="row">
        <input id="audio-file" type="file" accept="audio/*" />
        <button id="btn-play">播放</button>
        <button id="btn-pause" class="secondary">暂停</button>
      </div>
      <div class="row">
        <input id="lyric-file" type="file" accept=".lrc,.txt" />
        <button id="btn-load-text" class="secondary">载入文本歌词</button>
      </div>
    </div>
    <div class="panel">
      <div class="hint">在此粘贴 LRC 文本，点击“载入文本歌词”</div>
      <textarea id="lyric-text" placeholder="[mm:ss.xx] 示例歌词"></textarea>
    </div>
    <div class="player">
      <div class="mount"></div>
    </div>
  </div>
</body>
</html>