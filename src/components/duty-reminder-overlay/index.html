<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>值日生提醒遮罩</title>
    <link rel="stylesheet" href="../../renderer/remixicon-local.css" />
    <style>
      :root{--bg:#121212;--fg:#e6e6e6;--muted:#b0b0b0;--border:rgba(255,255,255,0.12);--accent:#8ab4f8}
      html,body{height:100%}
      body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
      .wrap{padding:16px}
      .header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
      .header i{font-size:24px;color:var(--accent)}
      .title{font-size:28px;font-weight:800;color:var(--fg)}
      .sub{font-size:18px;color:var(--muted)}
      .grid{margin-top:12px;overflow-x:auto}
      table{width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:14px;overflow:hidden}
      thead th{font-weight:700;color:var(--muted);text-align:center;padding:12px;border-bottom:1px solid var(--border);font-size:18px}
      tbody td{color:var(--fg);padding:14px 12px;text-align:center;border-top:1px solid var(--border);font-size:20px}
      tbody tr:first-child td{border-top:none}
      .label-lg{font-size:28px;font-weight:900;white-space:nowrap}
      .cell-lg{font-size:22px}
      .rot{margin-top:12px}
      .rot table{width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:14px;overflow:hidden}
      .rot tbody td{border-top:1px solid var(--border)}
      .rot tbody tr:first-child td{border-top:none}
      .rot-name{width:160px;text-align:left;font-size:20px;font-weight:800;color:var(--fg);padding-left:12px}
      .rot-names{text-align:left;font-size:20px;color:var(--fg)}
      .calib{margin-top:16px;border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(255,255,255,0.04)}
      .calib-title{font-size:16px;font-weight:800;margin-bottom:6px;color:var(--fg);display:flex;align-items:center;gap:8px}
      .calib-row{display:flex;align-items:center;gap:8px;margin:6px 0}
      .calib-label{width:110px;color:var(--muted);font-weight:700;font-size:14px}
      .calib-value{flex:0 0 auto; min-width:120px; text-align:center; font-size:16px; color:var(--fg)}
      .icon-btn{width:28px;height:28px;display:grid;place-items:center;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,0.06);color:var(--fg);cursor:pointer}
      .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,0.06);color:var(--fg);cursor:pointer}
      .btn.small{padding:4px 8px}
      .muted{color:var(--muted)}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <i class="ri-notification-2-line"></i>
        <div class="title" id="title"></div>
      </div>
      <div class="sub" id="sub"></div>
      <div class="grid"><table id="table"></table></div>
      <div class="rot"><table id="rot"></table></div>
      <div class="calib" id="calib">
        <div class="calib-title"><i class="ri-settings-3-line"></i> 值日校准</div>
        <div class="calib-row">
          <div class="calib-label">组别</div>
          <button class="icon-btn" id="groupPrev"><i class="ri-arrow-left-s-line"></i></button>
          <div id="calibGroupPreview" class="calib-value"></div>
          <button class="icon-btn" id="groupNext"><i class="ri-arrow-right-s-line"></i></button>
        </div>
        <div id="calibSingles"></div>
        <div id="calibMsg" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
    <script>
      const p=new URLSearchParams(location.search)
      const title=p.get('title')||'今日值日生提醒'
      const date=p.get('date')||new Date().toISOString().slice(0,10)
      const group=p.get('group')||''
      let members=[]
      try{const raw=p.get('members');if(raw)members=JSON.parse(raw)}catch{}
      document.getElementById('title').textContent=title
      document.getElementById('sub').textContent=`${date}${group?`｜${group}`:''}`
      const table=document.getElementById('table')
      let colsFromParam=[]
      try{const rawCols=p.get('columns');if(rawCols)colsFromParam=JSON.parse(rawCols)}catch{}
      let membersGroup=[]
      let membersSingle=[]
      try{const mg=p.get('membersGroup');if(mg)membersGroup=JSON.parse(mg)}catch{}
      try{const ms=p.get('membersSingle');if(ms)membersSingle=JSON.parse(ms)}catch{}
      const groupItems=membersGroup.length?membersGroup:members.filter(m=>Array.isArray(m?.names)&&m.names.length>=1)
      const singleItems=membersSingle.length?membersSingle:members.filter(m=>Array.isArray(m?.names)&&m.names.length===1)
      const cols=[]
      const base=colsFromParam.length?colsFromParam:(groupItems.length?groupItems:members)
      base.forEach(m=>{const r=typeof m==='string'?m:String(m?.role||'').trim();if(r&&!cols.includes(r))cols.push(r)})
      const gMap={}
      groupItems.forEach(m=>{gMap[String(m.role)]=Array.isArray(m.names)?m.names:[]})
      const thead=document.createElement('thead')
      const hr=document.createElement('tr')
      const firstTh=document.createElement('th')
      firstTh.textContent=''
      hr.appendChild(firstTh)
      cols.forEach(c=>{const th=document.createElement('th');th.textContent=String(c);hr.appendChild(th)})
      thead.appendChild(hr)
      const tbody=document.createElement('tbody')
      const r1=document.createElement('tr')
      const r1Label=document.createElement('td')
      r1Label.className='label-lg'
      r1Label.textContent=group||''
      r1.appendChild(r1Label)
      cols.forEach(c=>{const td=document.createElement('td');td.className='cell-lg';td.textContent=Array.isArray(gMap[c])?gMap[c].join('、'):'';r1.appendChild(td)})
      tbody.appendChild(r1)
      table.appendChild(thead)
      table.appendChild(tbody)
      const rot=document.getElementById('rot')
      const rotBody=document.createElement('tbody')
      singleItems.forEach(it=>{const tr=document.createElement('tr');const lc=document.createElement('td');lc.className='rot-name';lc.textContent=String(it?.role||'');const rc=document.createElement('td');rc.className='rot-names';rc.textContent=Array.isArray(it?.names)?it.names.join('、'):'';tr.appendChild(lc);tr.appendChild(rc);rotBody.appendChild(tr)})
      rot.appendChild(rotBody)
      const api=window.notifyAPI|| (window.parent&&window.parent.notifyAPI) || null
      let cfgCache=null
      async function loadCfg(){ try{ if(!api?.pluginCall) return; let r=await api.pluginCall('duty.easy','getConfig'); r=r?.result||r; cfgCache=r?.config||null }catch{} }
      loadCfg()
      function renderFromItem(item){ try{ table.innerHTML=''; rot.innerHTML=''; const cols2=Array.isArray(item?.rolesGroup)?item.rolesGroup:[]; const thead2=document.createElement('thead'); const hr2=document.createElement('tr'); const th0=document.createElement('th'); th0.textContent=''; hr2.appendChild(th0); cols2.forEach(c=>{ const th=document.createElement('th'); th.textContent=String(c||''); hr2.appendChild(th) }); thead2.appendChild(hr2); const tbody2=document.createElement('tbody'); const tr2=document.createElement('tr'); const tdg=document.createElement('td'); tdg.className='label-lg'; tdg.textContent=String(item?.groupName||''); tr2.appendChild(tdg); cols2.forEach(c=>{ const td=document.createElement('td'); const arr=Array.isArray(item?.groupMembers?.[c])?item.groupMembers[c]:[]; td.textContent=arr.length?arr.join('、'):''; tr2.appendChild(td) }); tbody2.appendChild(tr2); table.appendChild(thead2); table.appendChild(tbody2); const rotBody2=document.createElement('tbody'); const rs=Array.isArray(item?.rolesSingle)?item.rolesSingle:[]; rs.forEach(r=>{ const arr=Array.isArray(item?.singleMembers?.[r])?item.singleMembers[r]:[]; if(!arr.length) return; const tr=document.createElement('tr'); const lc=document.createElement('td'); lc.className='rot-name'; lc.textContent=String(r||''); const rc=document.createElement('td'); rc.className='rot-names'; rc.textContent=arr.join('、'); tr.appendChild(lc); tr.appendChild(rc); rotBody2.appendChild(tr) }); rot.appendChild(rotBody2); document.getElementById('sub').textContent=`${item?.dateISO||date}${item?.groupName?`｜${item.groupName}`:''}`; document.getElementById('calibGroupName').textContent=item?.groupName||'' }catch{}
      }
      function weekNumberISO(dateStr){ const d=new Date(dateStr); const dd=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const day=(dd.getUTCDay()+6)%7; dd.setUTCDate(dd.getUTCDate()-day+3); const firstThursday=new Date(Date.UTC(dd.getUTCFullYear(),0,4)); const diff=dd-firstThursday; return 1+Math.round(diff/604800000); }
      function matchCond(dateStr, cond){ if(!cond||typeof cond!=='object') return true; const wk=weekNumberISO(dateStr); const isOdd=(wk%2)===1; if(cond.mode==='odd' && !isOdd) return false; if(cond.mode==='even' && isOdd) return false; const d=new Date(dateStr).getDay(); const d17=d===0?7:d; const arr=Array.isArray(cond.weekdays)?cond.weekdays:[]; if(arr.length){ return arr.includes(d17); } return true; }
      function buildItemFromCfgWithDelta(){ try{ const cfg=cfgCache; if(!cfg) return null; const groups=Array.isArray(cfg.groups)?cfg.groups:[]; const rolesAll=Array.isArray(cfg.roles)?cfg.roles:[]; const singleRoles=Array.isArray(cfg.singleRoles)?cfg.singleRoles:rolesAll; const rule=cfg.rule||{}; const lists= typeof cfg.singleRoleLists==='object' && cfg.singleRoleLists ? cfg.singleRoleLists : {}; const indices= typeof rule.singleRoleIndices==='object' && rule.singleRoleIndices ? rule.singleRoleIndices : {}; const conds= typeof cfg.singleRoleConditions==='object' && cfg.singleRoleConditions ? cfg.singleRoleConditions : {}; const norm=(v,len)=>{ const m=((v%len)+len)%len; return m }; let gi= Number.isFinite(rule.currentGroupIndex) ? rule.currentGroupIndex : 0; gi=groups.length?norm(gi+state.groupDelta, groups.length):0; const groupObj=groups[gi]||{ name:'', roles:{} }; const groupMembers={}; rolesAll.forEach((r)=>{ groupMembers[r]=Array.isArray(groupObj.roles?.[r])?groupObj.roles[r]:[] }); const singleMembers={}; singleRoles.forEach((r)=>{ const arr=Array.isArray(lists[r])?lists[r]:[]; const base= Number.isFinite(indices[r]) ? indices[r] : 0; const pick= arr.length ? arr[norm(base+(state.singleDelta[r]||0), arr.length)] : undefined; const canShow=matchCond(date, conds[r]||null); singleMembers[r]= (pick && canShow) ? [pick] : [] }); return { dateISO: date, groupIndex: gi, groupName: groupObj.name||'', rolesGroup: rolesAll, groupMembers, rolesSingle: singleRoles, singleMembers } }catch{ return null } }
      function previewLocal(){ }
      function computeGroupPreview(){ try{ const cfg=cfgCache; if(!cfg) return group||''; const groups=Array.isArray(cfg.groups)?cfg.groups:[]; const rule=cfg.rule||{}; let gi= Number.isFinite(rule.currentGroupIndex) ? rule.currentGroupIndex : 0; return groups[gi]?.name||'' }catch{ return group||'' } }
      function computeSinglePreview(role){ try{ const cfg=cfgCache; if(!cfg) return ''; const lists= typeof cfg.singleRoleLists==='object' && cfg.singleRoleLists ? cfg.singleRoleLists : {}; const rule=cfg.rule||{}; const indices= typeof rule.singleRoleIndices==='object' && rule.singleRoleIndices ? rule.singleRoleIndices : {}; const arr=Array.isArray(lists[role])?lists[role]:[]; if(!arr.length) return '未设置'; const base= Number.isFinite(indices[role]) ? indices[role] : 0; const pick=arr[base]||''; return String(pick||'') }catch{ return '' } }
      function renderCalibDisplay(){ try{ const gp=document.getElementById('calibGroupPreview'); gp.textContent=computeGroupPreview(); Object.keys(singleValueEls).forEach(r=>{ singleValueEls[r].textContent=computeSinglePreview(r) }) }catch{} }
      async function refreshFromConfig(){ try{ if(!api?.pluginCall) return; let r=await api.pluginCall('duty.easy','getPreview'); r=r?.result||r; const list=Array.isArray(r?.list)?r.list:[]; if(list.length) renderFromItem(list[0]); await loadCfg(); renderCalibDisplay() }catch{} }
      const calibSingles=document.getElementById('calibSingles')
      const state={ groupDelta:0, singleDelta:{} }
      let dirty=false
      const singleValueEls={}
      const makeSingleRow=(role)=>{ const row=document.createElement('div'); row.className='calib-row'; const lab=document.createElement('div'); lab.className='calib-label'; lab.textContent=role; const left=document.createElement('button'); left.className='icon-btn'; left.innerHTML='<i class="ri-arrow-left-s-line"></i>'; const val=document.createElement('div'); val.className='calib-value'; singleValueEls[role]=val; const right=document.createElement('button'); right.className='icon-btn'; right.innerHTML='<i class="ri-arrow-right-s-line"></i>'; left.addEventListener('click',async ()=>{ await persistDelta('single', role, -1) }); right.addEventListener('click',async ()=>{ await persistDelta('single', role, 1) }); row.appendChild(lab); row.appendChild(left); row.appendChild(val); row.appendChild(right); return row }
      async function persistDelta(type, role, step){ try{
        if(!api?.pluginCall) return; let cfgRes=await api.pluginCall('duty.easy','getConfig'); cfgRes=cfgRes?.result||cfgRes; const cfg=cfgRes?.config||{}
        const groups=Array.isArray(cfg.groups)?cfg.groups:[]
        const rule=cfg.rule||{}
        const lists= typeof cfg.singleRoleLists==='object' && cfg.singleRoleLists ? cfg.singleRoleLists : {}
        const indices= typeof rule.singleRoleIndices==='object' && rule.singleRoleIndices ? { ...rule.singleRoleIndices } : {}
        const norm=(v,len)=>{ const m=((v%len)+len)%len; return m }
        let gi= Number.isFinite(rule.currentGroupIndex) ? rule.currentGroupIndex : 0
        if(type==='group' && groups.length){ gi=norm(gi+step, groups.length) }
        if(type==='single' && role){ const arr=Array.isArray(lists[role])?lists[role]:[]; if(arr.length){ const base= Number.isFinite(indices[role]) ? indices[role] : 0; indices[role]=norm(base+step, arr.length) } }
        const nextRule={ ...rule, currentGroupIndex: gi, singleRoleIndices: indices }
        await api.pluginCall('duty.easy','saveConfig',[{ rule: nextRule }])
        await refreshFromConfig()
      }catch{} }
      document.getElementById('groupPrev').addEventListener('click',async ()=>{ await persistDelta('group', null, -1) })
      document.getElementById('groupNext').addEventListener('click',async ()=>{ await persistDelta('group', null, 1) })
      const calibMsg=document.getElementById('calibMsg')
      async function initCalib(){ try{ await loadCfg(); const roles=Array.isArray(cfgCache?.singleRoles)?cfgCache.singleRoles:[]; const conds= typeof cfgCache?.singleRoleConditions==='object' && cfgCache.singleRoleConditions ? cfgCache.singleRoleConditions : {}; const lists= typeof cfgCache?.singleRoleLists==='object' && cfgCache.singleRoleLists ? cfgCache.singleRoleLists : {}; calibSingles.innerHTML=''; roles.forEach(r=>{ const role=String(r||'').trim(); const arr=Array.isArray(lists[role])?lists[role]:[]; const canShow=matchCond(date, conds[role]||null); if(role && arr.length && canShow) { const row=makeSingleRow(role); calibSingles.appendChild(row); const left=row.querySelector('.icon-btn'); const right=row.querySelectorAll('.icon-btn')[1]; left.addEventListener('click', async ()=>{ await persistDelta('single', role, -1) }); right.addEventListener('click', async ()=>{ await persistDelta('single', role, 1) }); }
        }); renderCalibDisplay() }catch{} }
      initCalib()
    </script>
  </body>
</html>
